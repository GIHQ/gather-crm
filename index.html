<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="GATHER">
  <meta name="theme-color" content="#E87722">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="Gathericon.png">
  <link rel="icon" type="image/png" href="Gathericon.png">
  <title>GATHER</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&display=swap" rel="stylesheet">
  
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            goldin: {
              orange: '#E87722',
              'orange-dark': '#D56A1C',
              gray: '#6B7280',
              'gray-dark': '#374151',
            }
          },
          fontFamily: {
            sans: ['DM Sans', 'system-ui', 'sans-serif'],
          }
        }
      }
    };
  </script>
  
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { 
      font-family: 'DM Sans', system-ui, sans-serif;
      overscroll-behavior: none;
    }
    
    /* Safe area for notch */
    .safe-top { padding-top: env(safe-area-inset-top); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    
    /* Smooth page transitions */
    .page { 
      position: absolute; 
      inset: 0; 
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .page-enter { opacity: 0; transform: translateX(20px); }
    .page-exit { opacity: 0; transform: translateX(-20px); }
    
    /* Bottom sheet */
    .bottom-sheet {
      transform: translateY(100%);
      transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
    }
    .bottom-sheet.open { transform: translateY(0); }
    
    /* Slide menu */
    .slide-menu {
      transform: translateX(-100%);
      transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
    }
    .slide-menu.open { transform: translateX(0); }
    
    /* Activity item animation */
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .activity-item { animation: slideUp 0.4s ease forwards; }
    
    /* Onboarding animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.5s ease forwards; }
    .fade-in-delay-1 { animation-delay: 0.1s; opacity: 0; }
    .fade-in-delay-2 { animation-delay: 0.2s; opacity: 0; }
    .fade-in-delay-3 { animation-delay: 0.3s; opacity: 0; }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 0; background: transparent; }
    
    /* Status colors */
    .status-green { background: #10B981; }
    .status-yellow { background: #F59E0B; }
    .status-red { background: #EF4444; }
    
    /* Pull to refresh indicator */
    .refresh-indicator {
      transition: transform 0.2s ease;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 overflow-x-hidden">

<div id="root"></div>

<!-- React + Supabase -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/getstream@8/dist/js_min/getstream.js"></script>

<script type="text/babel">
const { useState, useEffect, useMemo, useCallback, useRef, createContext, useContext } = React;

// ============================================
// COMPONENT INDEX
// ============================================
// This file contains all React components for the GATHER app.
// Major components and their line numbers (approximate):
//
// PROVIDERS & CONTEXT:
//   AppProvider              - Global state, auth, data fetching
//
// SCREENS (Full-page views):
//   WelcomeScreen           - Initial landing/splash screen
//   LoginScreen             - Email magic link login
//   NotificationSetupScreen - Onboarding notification preferences
//   OnboardingSetupScreen   - Initial app setup flow
//
// PAGES (Main navigation destinations):
//   DashboardPage           - Home dashboard with stats & activity
//   DirectoryPage           - Fellow directory with search/filter
//   ActivityPage            - Activity feed and history
//   SearchPage              - Global search across fellows
//   CommunityPage           - Community feed with announcements
//   LibraryPage             - Shared resources/documents
//   BroadcastPage           - In-app announcements & email newsletters
//   SettingsPage            - User settings and preferences
//   TeamManagementPage      - Admin page for managing staff accounts
//
// MODALS:
//   FellowProfileModal      - Detailed fellow profile view
//   LogInteractionModal     - Log new interaction with fellow
//   FilterSortPanel         - Directory filter/sort options
//   NotificationSettingsModal (inline in SettingsPage)
//
// UI COMPONENTS:
//   Header                  - App header with menu toggle
//   SlideMenu               - Side navigation drawer
//   StatusPill              - Status indicator badges
//   StatusFilterBar         - Filter buttons for status
//   QuickActionButton       - Floating action button
//   SearchBar               - Reusable search input
//   ActivityItem            - Single activity list item
//   FocusAreasEditor        - Edit fellow focus areas
//
// APP STRUCTURE:
//   MainApp                 - Main app with navigation
//   App                     - Root component with routing
// ============================================

// ============================================
// CONFIG & SUPABASE
// ============================================
const SUPABASE_URL = 'https://pwazurumpzydxyppbvee.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3YXp1cnVtcHp5ZHh5cHBidmVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1MjM3MDUsImV4cCI6MjA4NTA5OTcwNX0.iGLmSpTPM84lMGGizSfBnkDCvpMZaJVaFhcRJ9cYDrs';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
    storageKey: 'gather-auth',
    storage: window.localStorage,
    detectSessionInUrl: false,
  }
});

// GATHER Logo from Supabase Storage
// Local icon file (just the logo, no text)
const GATHER_LOGO = './Gathericon.png';
// Full logo with text (from Supabase storage)
const GATHER_LOGO_FULL = 'https://pwazurumpzydxyppbvee.supabase.co/storage/v1/object/public/Photos/Gather%20-%20Logo.png';

// ============================================
// NEWS SEARCH - Uses Supabase Edge Function (server-side)
// See: supabase/functions/search-news/index.ts
// Deploy with: supabase functions deploy search-news
// ============================================

// Save activity to database (used by edge function callback if needed)
async function saveActivity(fellowId, result) {
  const { error } = await supabase.from('activities').upsert({
    fellow_id: fellowId,
    activity_type: 'news_mention',
    source_name: result.source,
    source_url: result.url,
    source_domain: result.source,
    title: result.title,
    snippet: result.snippet,
    image_url: result.image,
    relevance_score: 0.5,
    verified: false,
    dismissed: false,
  }, {
    onConflict: 'fellow_id,source_url',
    ignoreDuplicates: true,
  });

  return !error;
}

// ============================================
// TRANSLATION SYSTEM (via Edge Function)
// ============================================

const SUPPORTED_LANGUAGES = [
  { code: 'en', name: 'English', native: 'English' },
  { code: 'es', name: 'Spanish', native: 'EspaÃ±ol' },
  { code: 'fr', name: 'French', native: 'FranÃ§ais' },
  { code: 'ar', name: 'Arabic', native: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', rtl: true },
  { code: 'sw', name: 'Swahili', native: 'Kiswahili' },
  { code: 'zh', name: 'Chinese', native: 'ä¸­æ–‡' },
];

// UI strings to translate (menu labels, buttons, etc.)
const UI_STRINGS = [
  'Dashboard', 'Directory', 'Search', 'Activity', 'Settings', 'Cohort Communication',
  'Network Health', 'fellows', 'Last contact', 'Add Interaction', 'Log Interaction',
  'Help Me Connect', 'News', 'Interactions', 'Recent', 'Follow-up', 'Overdue',
  'Save', 'Cancel', 'Close', 'Edit', 'Delete', 'Submit', 'Loading...', 'Continue',
  'Sign Out', 'My Profile', 'Notifications', 'Coming Soon', 'All', 'View all',
  'No results found', 'Search fellows...', 'Name', 'Organization', 'Email', 'Phone',
  'City', 'Country', 'Biography', 'Job Title', 'Program', 'days ago', 'Today',
  'This week', 'This month', 'Get Started', 'Welcome to', 'Send Login Link',
  'Enter your email to receive a login link', 'Skip for now', 'View public directory without signing in',
  'Stay in the loop', 'Get notified about important updates', 'Enable Notifications',
  'Maybe later', 'Daily Summary', 'Activity Alerts', 'News Mentions', 'Overdue Alerts',
  'Morning overview of your priorities', 'When team members log interactions',
  'When fellows appear in the news', 'When follow-ups become overdue',
  'Continue to GATHER', 'Choose your language', 'Select your preferred language',
  'News Scanner', 'Scan All Fellows', 'Quick Scan', 'Scanning...', 'Language',
  'Change your display language', 'No fellow profile found', 'Edit your fellow profile',
  'Manage your alerts', 'About', 'Location', 'Contact Info', 'Focus Areas',
  'No contact recorded', 'Last contact', 'days ago', 'Community', 'Library',
  'Broadcast', 'Announcements', 'Resources', 'Newsletter', 'Team Management',
  'Call', 'Email', 'Meeting', 'News Mention', 'Event', 'Site Visit', 'Note',
  'No organization', 'View Profile', 'Log Interaction', 'Pinned',
  'Overview', 'Notes', 'AI-powered suggestions', 'Recent Interactions',
  'View all', 'No recent activity', 'fellows', 'Overdue follow-ups',
  'staff member', 'Team', 'Search fellows...'
];

// ============================================
// DEEP TRANSLATION ENGINE
// Memory cache + Supabase DB cache + Google Translate API
// ============================================

// In-memory translation cache (persists for session)
const translationCache = new Map();

// Simple MD5-like hash for cache keys (fast, not cryptographic)
function simpleHash(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // Convert to 32-bit integer
  }
  return 'h' + Math.abs(hash).toString(36);
}

// Translation queue for batching dynamic content
let translationQueue = [];
let translationFlushTimer = null;
let translationFlushCallbacks = [];

// Call Google Translate API via Edge Function
async function callTranslateAPI(texts, targetLang) {
  try {
    const { data: { session } } = await supabase.auth.getSession();
    const headers = {
      'Content-Type': 'application/json',
      'apikey': SUPABASE_ANON_KEY,
      'Authorization': session?.access_token ? `Bearer ${session.access_token}` : `Bearer ${SUPABASE_ANON_KEY}`,
    };

    const response = await fetch(
      `${SUPABASE_URL}/functions/v1/translate`,
      {
        method: 'POST',
        headers,
        body: JSON.stringify({ texts, targetLang, sourceLang: 'en' })
      }
    );

    if (!response.ok) {
      console.error(`Translation API failed (${response.status})`);
      return null;
    }

    const data = await response.json();
    return data.data?.translations?.map(t => t.translatedText) || null;
  } catch (err) {
    console.error('Translation API error:', err);
    return null;
  }
}

// Load cached translations from Supabase DB for a language
async function loadDBTranslations(targetLang) {
  try {
    const { data, error } = await supabase
      .from('content_translations')
      .select('source_hash, source_text, translated_text')
      .eq('target_lang', targetLang);

    if (error) {
      console.warn('Could not load cached translations:', error.message);
      return;
    }

    if (data) {
      data.forEach(row => {
        translationCache.set(`${targetLang}:${row.source_text}`, row.translated_text);
      });
      console.log(`Loaded ${data.length} cached translations for ${targetLang}`);
    }
  } catch (err) {
    console.warn('DB translation cache unavailable:', err.message);
  }
}

// Save translations to Supabase DB cache
async function saveDBTranslations(entries) {
  if (entries.length === 0) return;
  try {
    const rows = entries.map(({ text, targetLang, translated }) => ({
      source_hash: simpleHash(text),
      source_text: text,
      target_lang: targetLang,
      translated_text: translated,
    }));

    // Upsert to handle duplicates gracefully
    await supabase
      .from('content_translations')
      .upsert(rows, { onConflict: 'source_hash,target_lang', ignoreDuplicates: true });
  } catch (err) {
    console.warn('Could not save translations to DB:', err.message);
  }
}

// Batch translate texts â€” checks memory cache, then DB cache (preloaded), then API
async function batchTranslate(texts, targetLang) {
  if (targetLang === 'en' || !texts || texts.length === 0) return {};

  // Filter to unique, non-empty, uncached texts
  const seen = new Set();
  const uncached = texts.filter(t => {
    if (!t || typeof t !== 'string' || t.trim().length === 0) return false;
    if (seen.has(t)) return false;
    seen.add(t);
    return !translationCache.has(`${targetLang}:${t}`);
  });

  if (uncached.length > 0) {
    // Translate in batches of 50 to avoid payload limits
    const BATCH_SIZE = 50;
    const dbEntries = [];

    for (let i = 0; i < uncached.length; i += BATCH_SIZE) {
      const batch = uncached.slice(i, i + BATCH_SIZE);
      const results = await callTranslateAPI(batch, targetLang);

      if (results) {
        results.forEach((translated, idx) => {
          translationCache.set(`${targetLang}:${batch[idx]}`, translated);
          dbEntries.push({ text: batch[idx], targetLang, translated });
        });
      }
    }

    // Save to DB cache in background (don't await)
    if (dbEntries.length > 0) {
      saveDBTranslations(dbEntries);
    }
  }

  // Build result from cache
  const result = {};
  texts.forEach(text => {
    if (!text) return;
    const cached = translationCache.get(`${targetLang}:${text}`);
    if (cached) result[text] = cached;
  });
  return result;
}

// Flush the translation queue â€” called on a debounced timer
async function flushTranslationQueue(targetLang) {
  if (translationQueue.length === 0) return;

  const textsToTranslate = [...new Set(translationQueue.filter(t => t && !translationCache.has(`${targetLang}:${t}`)))];
  translationQueue = [];
  const callbacks = [...translationFlushCallbacks];
  translationFlushCallbacks = [];

  if (textsToTranslate.length === 0) {
    callbacks.forEach(cb => cb());
    return;
  }

  await batchTranslate(textsToTranslate, targetLang);
  callbacks.forEach(cb => cb());
}

// Queue a text for translation and trigger a batched flush
function queueTranslation(text, targetLang, onComplete) {
  if (!text || targetLang === 'en') return;
  if (translationCache.has(`${targetLang}:${text}`)) {
    if (onComplete) onComplete();
    return;
  }

  translationQueue.push(text);
  if (onComplete) translationFlushCallbacks.push(onComplete);

  // Debounce: flush after 150ms of no new requests
  if (translationFlushTimer) clearTimeout(translationFlushTimer);
  translationFlushTimer = setTimeout(() => flushTranslationQueue(targetLang), 150);
}

// Translation context - allows <T> component to access current language
const TranslationContext = createContext({ language: 'en', version: 0 });

// <T> component for translating dynamic content (bios, announcements, etc.)
// Usage: <T>{fellow.biography}</T>
// Renders original text immediately, then swaps in translation when ready
function T({ children }) {
  const ctx = useContext(TranslationContext);
  const lang = ctx ? ctx.language : 'en';
  const ver = ctx ? ctx.version : 0;
  const text = (children != null && typeof children === 'string') ? children : (children != null ? String(children) : '');
  const [translated, setTranslated] = useState(text);

  useEffect(() => {
    if (!text || lang === 'en') {
      setTranslated(text);
      return;
    }

    // Check memory cache first
    const cached = translationCache.get(`${lang}:${text}`);
    if (cached) {
      setTranslated(cached);
      return;
    }

    // Show original text while waiting
    setTranslated(text);

    // Queue for batch translation
    queueTranslation(text, lang, () => {
      const result = translationCache.get(`${lang}:${text}`);
      if (result) setTranslated(result);
    });
  }, [text, lang, ver]);

  return translated || '';
}

// ============================================
// PERMISSION SYSTEM
// ============================================
const ROLES = {
  SUPER_ADMIN: 'super_admin',
  ADMIN: 'admin',
  MANAGER: 'manager',
  TEAM: 'team',
  FELLOW: 'fellow',
  VIEWER: 'viewer',
};

// Role hierarchy for permission checks (higher number = more permissions)
const ROLE_LEVELS = {
  [ROLES.VIEWER]: 0,
  [ROLES.FELLOW]: 1,
  [ROLES.TEAM]: 2,
  [ROLES.MANAGER]: 3,
  [ROLES.ADMIN]: 4,
  [ROLES.SUPER_ADMIN]: 5,
};

// Role display labels and colors
const ROLE_CONFIG = {
  [ROLES.SUPER_ADMIN]: { label: 'Super Admin', color: 'bg-red-500', textColor: 'text-red-700' },
  [ROLES.ADMIN]: { label: 'Admin', color: 'bg-purple-500', textColor: 'text-purple-700' },
  [ROLES.MANAGER]: { label: 'Manager', color: 'bg-blue-500', textColor: 'text-blue-700' },
  [ROLES.TEAM]: { label: 'Staff', color: 'bg-green-500', textColor: 'text-green-700' },
  [ROLES.FELLOW]: { label: 'Fellow', color: 'bg-goldin-orange', textColor: 'text-orange-700' },
  [ROLES.VIEWER]: { label: 'Guest', color: 'bg-gray-400', textColor: 'text-gray-600' },
};

// Check if user has at least the required role level
function hasPermission(userRole, requiredRole) {
  return (ROLE_LEVELS[userRole] || 0) >= (ROLE_LEVELS[requiredRole] || 0);
}

// Determine user role based on email and link user_id on first login
async function determineUserRole(email, userId = null) {
  if (!email) return ROLES.VIEWER;

  const lowerEmail = email.toLowerCase();

  try {
    // 1. Check team_members table first (staff) - check email OR alternate_emails
    const { data: teamMembers } = await supabase
      .from('team_members')
      .select('id, role, user_id, email')
      .eq('is_active', true)
      .or(`email.eq.${lowerEmail},alternate_emails.cs.{${lowerEmail}}`);

    const teamMember = teamMembers?.[0];
    if (teamMember) {
      // Link user_id on first login if not already set
      if (userId && !teamMember.user_id) {
        await supabase
          .from('team_members')
          .update({ user_id: userId, updated_at: new Date().toISOString() })
          .eq('id', teamMember.id);
      }
      return teamMember.role;
    }

    // 2. Check if user is a fellow - check email OR alternate_emails
    const { data: fellows } = await supabase
      .from('fellows')
      .select('id, user_id')
      .or(`email.eq.${lowerEmail},alternate_emails.cs.{${lowerEmail}}`);

    const fellowData = fellows?.[0];
    if (fellowData) {
      // Link user_id on first login if not already set
      if (userId && !fellowData.user_id) {
        await supabase
          .from('fellows')
          .update({ user_id: userId })
          .eq('id', fellowData.id);
      }
      return ROLES.FELLOW;
    }

    // 4. Check domain for staff (auto-grant team role and create record)
    if (lowerEmail.endsWith('@goldininstitute.org') ||
        lowerEmail.endsWith('@chicagopeacefellows.org')) {
      return ROLES.TEAM;
    }

    // 5. Default to viewer
    return ROLES.VIEWER;
  } catch (err) {
    console.error('Error determining user role:', err);
    // Fallback: check domain
    if (lowerEmail.endsWith('@goldininstitute.org') ||
        lowerEmail.endsWith('@chicagopeacefellows.org')) {
      return ROLES.TEAM;
    }
    return ROLES.VIEWER;
  }
}

// ============================================
// GETSTREAM FEED HOOK
// ============================================
function useStreamFeed() {
  const [activities, setActivities] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [hasMore, setHasMore] = useState(true);
  const clientRef = useRef(null);
  const feedRef = useRef(null);
  const nextPageRef = useRef(null);

  const fetchToken = useCallback(async () => {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return null;

    const response = await fetch(
      `${SUPABASE_URL}/functions/v1/stream-token`,
      {
        headers: {
          'Authorization': `Bearer ${session.access_token}`,
          'Content-Type': 'application/json',
        },
      }
    );

    if (!response.ok) {
      throw new Error('Failed to get stream token');
    }

    const { token, api_key } = await response.json();
    return { token, apiKey: api_key, userId: session.user.id };
  }, []);

  const initialize = useCallback(async () => {
    setLoading(true);
    setError(null);

    try {
      const tokenData = await fetchToken();
      if (!tokenData) {
        setError('Not authenticated');
        setLoading(false);
        return;
      }

      const { token, apiKey } = tokenData;

      // Initialize GetStream client (apiKey, userToken, appId)
      const client = window.stream.connect(apiKey, token, '1497007');
      clientRef.current = client;

      // Get community feed
      const feed = client.feed('flat', 'community');
      feedRef.current = feed;

      // Fetch initial activities
      const result = await feed.get({ limit: 20 });
      setActivities(result.results || []);
      nextPageRef.current = result.next;
      setHasMore(!!result.next);
      setLoading(false);
    } catch (err) {
      console.error('Stream feed error:', err);
      setError(err.message);
      setLoading(false);
    }
  }, [fetchToken]);

  const loadMore = useCallback(async () => {
    if (!feedRef.current || !nextPageRef.current || !hasMore) return;

    try {
      const result = await feedRef.current.get({
        limit: 20,
        id_lt: activities[activities.length - 1]?.id
      });
      setActivities(prev => [...prev, ...(result.results || [])]);
      nextPageRef.current = result.next;
      setHasMore(!!result.next);
    } catch (err) {
      console.error('Load more error:', err);
    }
  }, [activities, hasMore]);

  const refresh = useCallback(async () => {
    if (!feedRef.current) {
      await initialize();
      return;
    }

    try {
      const result = await feedRef.current.get({ limit: 20 });
      setActivities(result.results || []);
      nextPageRef.current = result.next;
      setHasMore(!!result.next);
    } catch (err) {
      console.error('Refresh error:', err);
      setError(err.message);
    }
  }, [initialize]);

  return { activities, loading, error, hasMore, initialize, loadMore, refresh };
}

// ============================================
// APP CONTEXT
// ============================================
const AppContext = createContext();

function AppProvider({ children }) {
  const [user, setUser] = useState(null);
  const [userRole, setUserRole] = useState(ROLES.VIEWER);
  const [isOnboarded, setIsOnboarded] = useState(false);
  const [needsProfileClaim, setNeedsProfileClaim] = useState(false);
  const [potentialMatches, setPotentialMatches] = useState({ fellows: [], teamMembers: [] });
  const [fellows, setFellows] = useState([]);
  const [teamMembers, setTeamMembers] = useState([]);
  const [interactions, setInteractions] = useState([]);
  const [loading, setLoading] = useState(true);
  const [authError, setAuthError] = useState(null);
  const [notificationSettings, setNotificationSettings] = useState({
    enabled: false,
    dailySummary: true,
    newActivity: true,
    overdueAlerts: true,
    newsAlerts: true,
  });
  const [focusCategories, setFocusCategories] = useState([]);
  const [focusTags, setFocusTags] = useState([]);
  const [activities, setActivities] = useState([]);
  const [loginEvents, setLoginEvents] = useState([]);
  const [fellowFocusTags, setFellowFocusTags] = useState([]);
  // Current Cohort state
  const [sites, setSites] = useState([]);
  const [currentFellows, setCurrentFellows] = useState([]);
  const [cohortEvents, setCohortEvents] = useState([]);
  const [eventAttendance, setEventAttendance] = useState([]);
  const [selectedSiteId, setSelectedSiteId] = useState(null);
  const [language, setLanguage] = useState('en');
  const [translations, setTranslations] = useState({});
  const [translationVersion, setTranslationVersion] = useState(0);

  // Check Supabase auth state on load
  useEffect(() => {
    // Failsafe: ensure loading never gets stuck
    const loadingTimeout = setTimeout(() => {
      console.warn('Loading timeout - forcing load complete');
      setLoading(false);
    }, 5000);

    // Load non-auth settings immediately
    const loadSettings = () => {
      const savedOnboarded = localStorage.getItem('gather_onboarded');
      const savedNotifs = localStorage.getItem('gather_notifications');

      if (savedOnboarded) setIsOnboarded(true);
      if (savedNotifs) {
        try {
          setNotificationSettings(JSON.parse(savedNotifs));
        } catch (e) {
          console.error('Error parsing notification settings:', e);
          localStorage.removeItem('gather_notifications');
        }
      }

      // Load saved language preference
      const savedLang = localStorage.getItem('gather_language');
      if (savedLang && SUPPORTED_LANGUAGES.some(l => l.code === savedLang)) {
        setLanguage(savedLang);
        document.documentElement.dir = savedLang === 'ar' ? 'rtl' : 'ltr';
        document.documentElement.lang = savedLang;
        // Preload cached translations from DB, then translate UI strings
        if (savedLang !== 'en') {
          loadDBTranslations(savedLang).then(() => {
            batchTranslate(UI_STRINGS, savedLang).then(trans => {
              if (Object.keys(trans).length > 0) setTranslations(trans);
            });
          });
        }
      }
    };

    loadSettings();

    // Handle auth session - use onAuthStateChange as primary mechanism
    const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {
      console.log('Auth event:', event, session?.user?.email);

      if ((event === 'INITIAL_SESSION' || event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') && session?.user) {
        const userData = {
          id: session.user.id,
          email: session.user.email,
          name: session.user.user_metadata?.full_name || session.user.email?.split('@')[0],
          avatar: session.user.user_metadata?.avatar_url,
        };
        setUser(userData);
        localStorage.setItem('gather_user', JSON.stringify(userData));

        try {
          // Fetch user role and link user_id
          const role = await determineUserRole(session.user.email, session.user.id);
          setUserRole(role);
          localStorage.setItem('gather_user_role', role);

          // If user got VIEWER role and isn't a Goldin email, check for profile claim
          const isGoldinEmail = session.user.email?.toLowerCase().endsWith('@goldininstitute.org') ||
                                session.user.email?.toLowerCase().endsWith('@chicagopeacefellows.org');
          if (role === ROLES.VIEWER && !isGoldinEmail) {
            // Find potential matches for this email
            const matches = await findPotentialMatches(session.user.email);
            if (matches.fellows.length > 0 || matches.teamMembers.length > 0) {
              setPotentialMatches(matches);
              setNeedsProfileClaim(true);
            }
          }
        } catch (roleErr) {
          console.error('Role lookup failed, using cached role:', roleErr);
          // Fall back to cached role from localStorage
          const cachedRole = localStorage.getItem('gather_user_role');
          if (cachedRole) setUserRole(cachedRole);
        }

        // Log sign-in event (not token refreshes or session restores)
        if (event === 'SIGNED_IN') {
          supabase.from('login_events').insert({
            user_id: session.user.id,
            email: session.user.email,
            name: session.user.user_metadata?.full_name || session.user.email?.split('@')[0],
          }).then(() => {}).catch(() => {});
        }

        clearTimeout(loadingTimeout);
        setLoading(false);
      } else if (event === 'INITIAL_SESSION' && !session) {
        // No stored session â€” try explicit session recovery first
        // This handles cases where Safari/PWA lost the onAuthStateChange event
        try {
          const { data: { session: recoveredSession } } = await supabase.auth.getSession();
          if (recoveredSession?.user) {
            console.log('Recovered session via getSession():', recoveredSession.user.email);
            const userData = {
              id: recoveredSession.user.id,
              email: recoveredSession.user.email,
              name: recoveredSession.user.user_metadata?.full_name || recoveredSession.user.email?.split('@')[0],
              avatar: recoveredSession.user.user_metadata?.avatar_url,
            };
            setUser(userData);
            localStorage.setItem('gather_user', JSON.stringify(userData));
            const role = await determineUserRole(recoveredSession.user.email, recoveredSession.user.id);
            setUserRole(role);
            localStorage.setItem('gather_user_role', role);
            clearTimeout(loadingTimeout);
            setLoading(false);
            return;
          }
        } catch (e) {
          console.error('getSession() recovery check failed:', e);
        }
        // Truly no session â€” check for guest user in localStorage
        const savedUser = localStorage.getItem('gather_user');
        if (savedUser) {
          try {
            const parsedUser = JSON.parse(savedUser);
            if (parsedUser.email === 'guest@gathertracker.app') {
              setUser(parsedUser);
              setUserRole(ROLES.VIEWER);
            }
          } catch (e) {
            console.error('Error parsing saved user:', e);
          }
        }
        clearTimeout(loadingTimeout);
        setLoading(false);
      } else if (event === 'SIGNED_OUT') {
        setUser(null);
        setUserRole(ROLES.VIEWER);
        setIsOnboarded(false);
        setNeedsProfileClaim(false);
        setPotentialMatches({ fellows: [], teamMembers: [] });
        localStorage.removeItem('gather_user');
        localStorage.removeItem('gather_user_role');
        localStorage.removeItem('gather_onboarded');
      }
    });

    // Re-check session when app returns from background (Safari/PWA loses events)
    const handleVisibilityChange = async () => {
      if (document.visibilityState === 'visible') {
        try {
          const { data: { session: currentSession } } = await supabase.auth.getSession();
          if (currentSession?.user) {
            const userData = {
              id: currentSession.user.id,
              email: currentSession.user.email,
              name: currentSession.user.user_metadata?.full_name || currentSession.user.email?.split('@')[0],
              avatar: currentSession.user.user_metadata?.avatar_url,
            };
            setUser(userData);
            localStorage.setItem('gather_user', JSON.stringify(userData));
          }
        } catch (e) {
          console.error('Visibility session check failed:', e);
        }
      }
    };
    document.addEventListener('visibilitychange', handleVisibilityChange);

    return () => {
      subscription.unsubscribe();
      document.removeEventListener('visibilitychange', handleVisibilityChange);
    };
  }, []);

  const login = async (userData, skipRoleLookup = false) => {
    setUser(userData);
    localStorage.setItem('gather_user', JSON.stringify(userData));

    // For skip/guest users, set viewer role immediately
    if (skipRoleLookup) {
      setUserRole(ROLES.VIEWER);
      localStorage.setItem('gather_user_role', ROLES.VIEWER);
    } else if (userData.email) {
      const role = await determineUserRole(userData.email);
      setUserRole(role);
      localStorage.setItem('gather_user_role', role);
    }
  };
  

  const completeOnboarding = (notifSettings) => {
    setNotificationSettings(notifSettings);
    setIsOnboarded(true);
    localStorage.setItem('gather_onboarded', 'true');
    localStorage.setItem('gather_notifications', JSON.stringify(notifSettings));
  };

  const logout = async () => {
    try {
      await supabase.auth.signOut({ scope: 'local' });
    } catch (e) {
      console.error('Sign out error:', e);
    }
    // Always clear local state even if signOut request fails
    setUser(null);
    setUserRole(ROLES.VIEWER);
    setIsOnboarded(false);
    setNeedsProfileClaim(false);
    setPotentialMatches({ fellows: [], teamMembers: [] });
    localStorage.removeItem('gather_user');
    localStorage.removeItem('gather_user_role');
    localStorage.removeItem('gather_onboarded');
    localStorage.removeItem('gather-auth');
  };

  // Change language and load translations
  const changeLanguage = async (langCode) => {
    setLanguage(langCode);
    localStorage.setItem('gather_language', langCode);

    // Set RTL for Arabic
    document.documentElement.dir = langCode === 'ar' ? 'rtl' : 'ltr';
    document.documentElement.lang = langCode;

    // Load translations
    if (langCode !== 'en') {
      // Step 1: Load DB-cached translations first (instant for returning users)
      await loadDBTranslations(langCode);

      // Step 2: Translate UI strings (menus, buttons, labels)
      const trans = await batchTranslate(UI_STRINGS, langCode);
      if (Object.keys(trans).length === 0) {
        // Translation failed - revert to English
        setLanguage('en');
        localStorage.setItem('gather_language', 'en');
        document.documentElement.dir = 'ltr';
        document.documentElement.lang = 'en';
        setTranslations({});
        alert('Translation service is temporarily unavailable. Please try again later.');
        return;
      }
      setTranslations(trans);

      // Step 3: Signal dynamic content to re-translate (triggers <T> components)
      setTranslationVersion(v => v + 1);
    } else {
      setTranslations({});
      setTranslationVersion(v => v + 1);
    }
  };

  // Translation helper for static UI strings (synchronous)
  const t = useCallback((text) => {
    if (language === 'en') return text;
    return translations[text] || translationCache.get(`${language}:${text}`) || text;
  }, [language, translations]);

  // Translation context value for <T> component
  const translationCtx = useMemo(() => ({ language, version: translationVersion }), [language, translationVersion]);

  // Permission check helper
  const canAccess = (requiredRole) => hasPermission(userRole, requiredRole);

  const fetchData = useCallback(async (forceRefresh = false) => {
    try {
      const [fellowsRes, teamMembersRes, interactionsRes, categoriesRes, tagsRes, activitiesRes] = await Promise.all([
        supabase.from('fellows').select('*').eq('status', 'Alumni'),
        supabase.from('team_members').select('*').eq('is_active', true).order('last_name'),
        supabase.from('interactions').select('*').order('created_at', { ascending: false }).limit(50),
        supabase.from('focus_categories').select('*').order('sort_order'),
        supabase.from('focus_tags').select('*').eq('approved', true).order('name'),
        supabase.from('activities').select('*').eq('dismissed', false).order('discovered_at', { ascending: false }).limit(200)
      ]);

      if (fellowsRes.data) setFellows(fellowsRes.data);
      if (teamMembersRes.data) setTeamMembers(teamMembersRes.data);
      if (interactionsRes.data) setInteractions(interactionsRes.data);
      if (categoriesRes.data) setFocusCategories(categoriesRes.data);
      if (tagsRes.data) setFocusTags(tagsRes.data);
      if (activitiesRes.data) setActivities(activitiesRes.data);

      // Fetch login events separately (non-blocking if table doesn't exist)
      try {
        const loginRes = await supabase.from('login_events').select('*').order('logged_in_at', { ascending: false }).limit(50);
        if (loginRes.data) setLoginEvents(loginRes.data);
      } catch (e) {
        console.log('login_events not available yet');
      }

      // Fetch fellow_focus_tags separately (non-blocking if table doesn't exist)
      try {
        const fellowTagsRes = await supabase.from('fellow_focus_tags').select('fellow_id, tag_id, is_primary');
        if (fellowTagsRes.data) setFellowFocusTags(fellowTagsRes.data);
      } catch (e) {
        console.log('fellow_focus_tags not available yet');
      }

      // Fetch current cohort data (non-blocking if tables don't exist yet)
      try {
        const [sitesRes, currentFellowsRes, eventsRes, attendanceRes] = await Promise.all([
          supabase.from('sites').select('*').order('name'),
          supabase.from('fellows').select('*').eq('status', 'Current'),
          supabase.from('events').select('*').order('start_time', { ascending: false }),
          supabase.from('event_attendance').select('*'),
        ]);
        if (sitesRes.data) setSites(sitesRes.data);
        if (currentFellowsRes.data) setCurrentFellows(currentFellowsRes.data);
        if (eventsRes.data) setCohortEvents(eventsRes.data);
        if (attendanceRes.data) setEventAttendance(attendanceRes.data);
      } catch (e) {
        console.log('Current cohort tables not available yet');
      }

      // If force refresh, also clear service worker cache
      if (forceRefresh && 'serviceWorker' in navigator) {
        const caches = await window.caches?.keys();
        if (caches) {
          await Promise.all(caches.map(cache => window.caches.delete(cache)));
        }
      }
    } catch (err) {
      console.error('Fetch error:', err);
    }
  }, []);

  useEffect(() => {
    if (user && isOnboarded) {
      fetchData();
      
      // Real-time subscription
      const sub = supabase
        .channel('all-changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'interactions' }, fetchData)
        .subscribe();
      
      return () => sub.unsubscribe();
    }
  }, [user, isOnboarded, fetchData]);

  return (
    <TranslationContext.Provider value={translationCtx}>
      <AppContext.Provider value={{
        user, userRole, login, logout, canAccess,
        isOnboarded, completeOnboarding,
        needsProfileClaim, setNeedsProfileClaim, potentialMatches, setPotentialMatches,
        fellows, teamMembers, interactions, activities, loginEvents, fellowFocusTags, fetchData,
        focusCategories, focusTags,
        sites, currentFellows, cohortEvents, eventAttendance,
        selectedSiteId, setSelectedSiteId,
        notificationSettings, setNotificationSettings,
        language, changeLanguage, t,
        loading,
        authError, setAuthError
      }}>
        {children}
      </AppContext.Provider>
    </TranslationContext.Provider>
  );
}

// ============================================
// HELPERS
// ============================================
function getContactStatus(lastContact) {
  if (!lastContact) return { color: 'red', label: 'Overdue', days: null };
  const days = Math.floor((Date.now() - new Date(lastContact)) / (1000*60*60*24));
  if (days <= 30) return { color: 'green', label: 'Recent', days };
  if (days <= 90) return { color: 'yellow', label: 'Follow-up', days };
  return { color: 'red', label: 'Overdue', days };
}

function getTimeAgo(date) {
  const mins = Math.floor((Date.now() - new Date(date)) / 60000);
  if (mins < 60) return `${mins}m ago`;
  const hours = Math.floor(mins / 60);
  if (hours < 24) return `${hours}h ago`;
  const days = Math.floor(hours / 24);
  if (days < 7) return `${days}d ago`;
  return new Date(date).toLocaleDateString();
}

function getInteractionIcon(type) {
  const icons = {
    'Call': 'ðŸ“ž', 'Email': 'ðŸ“§', 'Meeting': 'ðŸ¤', 
    'Note': 'ðŸ“', 'Event': 'ðŸŽ‰', 'Site Visit': 'ðŸ ',
    'News Mention': 'ðŸ“°'
  };
  return icons[type] || 'ðŸ’¬';
}

function getProgramBadge(program) {
  if (!program) return { label: 'â€”', bg: 'bg-gray-400' };

  const p = program.toLowerCase();

  // Team members (staff)
  if (p === 'team' || p === 'staff') {
    return { label: 'Team', bg: 'bg-gray-400' };
  }

  // Normalize program names to 3-letter codes
  if (p === 'cpf' || p.includes('chicago')) {
    return { label: 'CPF', bg: 'bg-blue-700' };
  }
  if (p === 'esp' || p.includes('espanol') || p.includes('espaÃ±ol') || p.includes('spanish')) {
    return { label: 'ESP', bg: 'bg-orange-700' };
  }
  if (p === 'ggf' || p.includes('global') || p.includes('english')) {
    return { label: 'GGF', bg: 'bg-orange-500' };
  }

  // Current cohort site programs
  if (p === 'dar' || p.includes('dar es salaam') || p.includes('tanzania')) {
    return { label: 'DAR', bg: 'bg-emerald-600' };
  }
  if (p === 'mos' || p.includes('mosquera') || p.includes('colombia')) {
    return { label: 'MOS', bg: 'bg-violet-600' };
  }

  // Fallback - show first 3 characters
  return { label: program.substring(0, 3).toUpperCase(), bg: 'bg-gray-500' };
}

// Get all badges for a person (supports multiple badges for staff with fellowships)
function getBadges(person) {
  const badges = [];

  if (person.record_type === 'team_member') {
    // Always show Team badge first for staff
    badges.push({ label: 'Team', bg: 'bg-gray-400' });

    // Add fellowship badges if they were also a fellow
    if (person.fellowships && Array.isArray(person.fellowships)) {
      person.fellowships.forEach(f => {
        if (f.program && f.year) {
          const programBadge = getProgramBadge(f.program);
          badges.push({
            label: `${programBadge.label} '${String(f.year).slice(-2)}`,
            bg: programBadge.bg
          });
        }
      });
    }
  } else {
    // Regular fellow - single badge with year
    const programBadge = getProgramBadge(person.program);
    const year = person.cohort_year || person.year;
    badges.push({
      label: year ? `${programBadge.label} '${String(year).slice(-2)}` : programBadge.label,
      bg: programBadge.bg
    });
  }

  return badges;
}

// ============================================
// FOCUS AREAS EDITOR
// ============================================
function FocusAreasEditor({ fellow, onUpdate }) {
  const { focusCategories, focusTags, canAccess, user } = useContext(AppContext);
  const [fellowTags, setFellowTags] = useState([]);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [selectedTags, setSelectedTags] = useState({});
  const [primaryCommunityArea, setPrimaryCommunityArea] = useState(null);
  const [newTagInputs, setNewTagInputs] = useState({});
  const [fetchError, setFetchError] = useState(null);

  const isStaff = canAccess(ROLES.TEAM);
  const isSelf = user?.email && fellow.email && user.email.toLowerCase() === fellow.email.toLowerCase();
  const canEditFocusAreas = isStaff || isSelf;

  // Check if this is a team member (they don't have focus tags)
  const isTeamMember = fellow?.record_type === 'team_member';

  // Fetch fellow's current tags
  useEffect(() => {
    let isMounted = true;
    let timeoutId;

    const fetchFellowTags = async () => {
      console.log('FocusAreasEditor: fellow.id =', fellow?.id, 'record_type =', fellow?.record_type);

      // Team members don't have focus tags - show empty state immediately
      if (isTeamMember) {
        console.log('FocusAreasEditor: Team member, skipping fetch');
        if (isMounted) setLoading(false);
        return;
      }

      if (!fellow?.id) {
        console.log('FocusAreasEditor: No fellow.id, returning');
        if (isMounted) setLoading(false);
        return;
      }

      if (isMounted) {
        setLoading(true);
        setFetchError(null);
      }

      // Add timeout to prevent infinite loading
      timeoutId = setTimeout(() => {
        if (isMounted && loading) {
          console.error('FocusAreasEditor: Fetch timeout');
          setFetchError('Request timed out');
          setLoading(false);
        }
      }, 10000); // 10 second timeout

      try {
        const { data, error } = await supabase
          .from('fellow_focus_tags')
          .select('tag_id, is_primary')
          .eq('fellow_id', fellow.id);

        console.log('FocusAreasEditor: fetched data =', data, 'error =', error);

        if (!isMounted) return;

        if (error) {
          console.error('FocusAreasEditor: Query error:', error);
          setFetchError(error.message);
        } else if (data) {
          setFellowTags(data);
          // Initialize selected tags state
          const initial = {};
          data.forEach(ft => {
            if (!initial[ft.tag_id]) {
              initial[ft.tag_id] = true;
            }
            if (ft.is_primary) {
              setPrimaryCommunityArea(ft.tag_id);
            }
          });
          console.log('FocusAreasEditor: selectedTags =', initial);
          setSelectedTags(initial);
        }
      } catch (err) {
        console.error('Error fetching fellow tags:', err);
        if (isMounted) setFetchError(err.message || 'Unknown error');
      }

      clearTimeout(timeoutId);
      if (isMounted) setLoading(false);
    };

    fetchFellowTags();

    return () => {
      isMounted = false;
      if (timeoutId) clearTimeout(timeoutId);
    };
  }, [fellow?.id, isTeamMember]);

  // Group tags by category
  const tagsByCategory = useMemo(() => {
    console.log('FocusAreasEditor: focusCategories =', focusCategories?.length, 'focusTags =', focusTags?.length);
    const grouped = {};
    (focusCategories || []).forEach(cat => {
      grouped[cat.id] = {
        category: cat,
        tags: (focusTags || []).filter(tag => tag.category_id === cat.id)
      };
    });
    return grouped;
  }, [focusCategories, focusTags]);

  // Check if category applies to fellow's program
  const categoryApplies = (category) => {
    if (!category.applicable_programs) return true;
    return category.applicable_programs.includes(fellow.program);
  };

  const toggleTag = (tagId) => {
    setSelectedTags(prev => ({
      ...prev,
      [tagId]: !prev[tagId]
    }));
  };

  const handlePrimaryChange = (tagId) => {
    setPrimaryCommunityArea(tagId);
  };

  const handleNewTagAdd = async (categoryId, tagName) => {
    if (!tagName.trim()) return;

    // Create new tag (pending approval if not admin)
    const slug = tagName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
    const isAdmin = canAccess(ROLES.ADMIN);

    const { data, error } = await supabase
      .from('focus_tags')
      .insert({
        category_id: categoryId,
        name: tagName.trim(),
        slug,
        approved: isAdmin,
        created_by: user?.email
      })
      .select()
      .single();

    if (!error && data) {
      // Auto-select the new tag
      setSelectedTags(prev => ({ ...prev, [data.id]: true }));
      // Clear input
      setNewTagInputs(prev => ({ ...prev, [categoryId]: '' }));
      // Refresh will happen on save
    }
  };

  const saveChanges = async () => {
    setSaving(true);
    try {
      // Delete existing tags for this fellow
      await supabase
        .from('fellow_focus_tags')
        .delete()
        .eq('fellow_id', fellow.id);

      // Insert new tags
      const tagsToInsert = Object.entries(selectedTags)
        .filter(([_, selected]) => selected)
        .map(([tagId]) => ({
          fellow_id: fellow.id,
          tag_id: tagId,
          is_primary: tagId === primaryCommunityArea
        }));

      if (tagsToInsert.length > 0) {
        await supabase.from('fellow_focus_tags').insert(tagsToInsert);
      }

      if (onUpdate) onUpdate();
    } catch (err) {
      console.error('Error saving focus tags:', err);
      alert('Error saving changes');
    }
    setSaving(false);
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center py-12">
        <div className="w-8 h-8 border-2 border-goldin-orange border-t-transparent rounded-full animate-spin"></div>
      </div>
    );
  }

  // Show error if fetch failed
  if (fetchError) {
    return (
      <div className="text-center py-8 bg-red-50 rounded-xl border border-red-200">
        <p className="text-red-800 font-medium">Unable to load focus areas</p>
        <p className="text-red-600 text-sm mt-1">{fetchError}</p>
        <button
          onClick={() => window.location.reload()}
          className="mt-4 px-4 py-2 bg-red-100 text-red-700 rounded-lg text-sm font-medium hover:bg-red-200 transition"
        >
          Retry
        </button>
      </div>
    );
  }

  // Team members don't have focus areas
  if (isTeamMember) {
    return (
      <div className="text-center py-8">
        <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg className="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
        </div>
        <p className="text-gray-600">Focus areas are available for fellows only</p>
        <p className="text-gray-400 text-sm mt-1">Team members can view and edit focus areas for fellows</p>
      </div>
    );
  }

  // View mode - just show selected tags
  if (!isEditing) {
    const selectedTagIds = Object.keys(selectedTags).filter(id => selectedTags[id]);
    const hasAnyTags = selectedTagIds.length > 0;

    if (!hasAnyTags) {
      return (
        <div className="text-center py-8">
          <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg className="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
            </svg>
          </div>
          <p className="text-gray-600 mb-4">No focus areas added yet</p>
          {canEditFocusAreas && (
            <button
              onClick={() => setIsEditing(true)}
              style={{ backgroundColor: '#E87722' }}
              className="px-6 py-3 text-white rounded-xl font-semibold shadow-md"
            >
              + Add Focus Areas
            </button>
          )}
        </div>
      );
    }

    return (
      <div className="space-y-6">
        {/* Edit button */}
        {canEditFocusAreas && (
          <div className="flex justify-end">
            <button
              onClick={() => setIsEditing(true)}
              className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-goldin-orange hover:bg-orange-50 rounded-xl transition"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
              </svg>
              Edit
            </button>
          </div>
        )}

        {(focusCategories || []).filter(categoryApplies).map(category => {
          const categoryTags = tagsByCategory[category.id]?.tags || [];
          const selectedInCategory = categoryTags.filter(tag => selectedTags[tag.id]);

          if (selectedInCategory.length === 0) return null;

          return (
            <div key={category.id}>
              <h4 className="text-sm font-semibold text-gray-400 uppercase tracking-wide mb-3">{category.name}</h4>
              <div className="flex flex-wrap gap-2">
                {selectedInCategory.map(tag => {
                  const isPrimary = tag.id === primaryCommunityArea && category.slug === 'community-areas';
                  return (
                    <span
                      key={tag.id}
                      className={`inline-flex items-center gap-1 px-3 py-1.5 rounded-full text-sm font-medium ${
                        isPrimary
                          ? 'bg-goldin-orange text-white'
                          : 'bg-gray-100 text-gray-700'
                      }`}
                    >
                      {isPrimary && <span className="text-xs">â˜…</span>}
                      {tag.icon && <span>{tag.icon}</span>} {tag.name}
                    </span>
                  );
                })}
              </div>
            </div>
          );
        })}
      </div>
    );
  }

  // Edit mode
  return (
    <div className="space-y-6">
      {(focusCategories || []).length === 0 && (
        <div className="text-center py-8 bg-yellow-50 rounded-xl border border-yellow-200">
          <p className="text-yellow-800 font-medium">Loading categories...</p>
          <p className="text-yellow-600 text-sm mt-1">If this persists, check Supabase RLS policies.</p>
        </div>
      )}
      {(focusCategories || []).filter(categoryApplies).map(category => {
        const categoryTags = tagsByCategory[category.id]?.tags || [];
        const isCommunityAreas = category.slug === 'community-areas';

        return (
          <div key={category.id} className="bg-gray-100 rounded-xl p-4 border border-gray-200">
            <h4 className="text-base font-bold text-gray-800 mb-1">{category.name}</h4>
            <p className="text-sm text-gray-600 mb-3">
              {isCommunityAreas
                ? 'Select areas where you work. Mark one as primary (â˜…).'
                : `Select all that apply`}
            </p>

            {categoryTags.length === 0 ? (
              <p className="text-gray-500 text-sm italic mb-3">No tags available in this category</p>
            ) : (
              <div className="flex flex-wrap gap-2 mb-3">
                {categoryTags.map(tag => {
                  const isSelected = selectedTags[tag.id];
                  const isPrimary = tag.id === primaryCommunityArea && isCommunityAreas;

                  return (
                    <button
                      key={tag.id}
                      onClick={() => {
                        if (isCommunityAreas && isSelected && !isPrimary) {
                          handlePrimaryChange(tag.id);
                        } else {
                          toggleTag(tag.id);
                          if (isPrimary && isSelected) {
                            setPrimaryCommunityArea(null);
                          }
                          if (isCommunityAreas && !isSelected) {
                            const currentlySelected = categoryTags.filter(t => selectedTags[t.id]);
                            if (currentlySelected.length === 0) {
                              setPrimaryCommunityArea(tag.id);
                            }
                          }
                        }
                      }}
                      style={isSelected ? { backgroundColor: isPrimary ? '#E87722' : '#3B82F6' } : {}}
                      className={`px-3 py-1.5 rounded-full text-sm font-medium transition-all ${
                        isSelected
                          ? 'text-white shadow-sm'
                          : 'bg-white border border-gray-300 text-gray-700 hover:border-gray-400'
                      }`}
                    >
                      {isPrimary && <span className="mr-1">â˜…</span>}
                      {tag.icon && <span className="mr-1">{tag.icon}</span>}{tag.name}
                    </button>
                  );
                })}
              </div>
            )}

            {/* Add new tag input */}
            <div className="flex gap-2">
              <input
                type="text"
                value={newTagInputs[category.id] || ''}
                onChange={(e) => setNewTagInputs(prev => ({ ...prev, [category.id]: e.target.value }))}
                placeholder={`Add new ${category.name.toLowerCase().replace(/s$/, '')}...`}
                className="flex-1 text-sm px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-800 focus:outline-none focus:border-orange-500"
                onKeyDown={(e) => {
                  if (e.key === 'Enter') {
                    e.preventDefault();
                    handleNewTagAdd(category.id, newTagInputs[category.id] || '');
                  }
                }}
              />
              <button
                onClick={() => handleNewTagAdd(category.id, newTagInputs[category.id] || '')}
                disabled={!newTagInputs[category.id]?.trim()}
                className="px-3 py-2 bg-gray-300 text-gray-700 rounded-lg text-sm font-medium disabled:opacity-50 hover:bg-gray-400"
              >
                Add
              </button>
            </div>
          </div>
        );
      })}

      {/* Save/Cancel buttons */}
      <div className="flex gap-3 pt-4">
        <button
          onClick={() => setIsEditing(false)}
          className="flex-1 py-3 border-2 border-gray-300 rounded-xl font-semibold text-gray-700 bg-white"
        >
          Cancel
        </button>
        <button
          onClick={async () => {
            await saveChanges();
            setIsEditing(false);
          }}
          disabled={saving}
          style={{ backgroundColor: '#E87722' }}
          className="flex-1 py-3 text-white rounded-xl font-semibold disabled:opacity-50 shadow-md"
        >
          {saving ? 'Saving...' : 'Save'}
        </button>
      </div>
    </div>
  );
}

// ============================================
// ONBOARDING SCREENS
// ============================================
function WelcomeScreen({ onNext }) {
  return (
    <div className="min-h-screen flex flex-col items-center justify-center p-8 pb-32 relative overflow-hidden" style={{ backgroundColor: '#000000' }}>
      <div className="fade-in text-center relative z-10">
        {/* Large logo - clean, no glow */}
        <div className="w-56 h-56 mx-auto mb-10">
          <img 
            src={GATHER_LOGO}
            alt="GATHER" 
            className="w-full h-full object-contain"
          />
        </div>
        
        <p className="text-gray-400 text-xl mb-16">Alumni Network CRM</p>
        
        <button 
          onClick={onNext}
          className="w-full max-w-xs bg-goldin-orange text-white font-bold py-5 px-10 rounded-2xl active:scale-95 transition-all text-lg"
        >
          Get Started
        </button>
        
        <p className="text-gray-600 text-sm mt-10">Goldin Institute Staff Portal</p>
      </div>
    </div>
  );
}

function LoginScreen({ onLogin, authError }) {
  const [email, setEmail] = useState('');
  const [loading, setLoading] = useState(false);
  const [otpSent, setOtpSent] = useState(false);
  const [otpCode, setOtpCode] = useState('');
  const [verifying, setVerifying] = useState(false);

  const handleEmailLogin = async (e) => {
    e.preventDefault();
    if (!email || !email.includes('@')) {
      alert('Please enter a valid email address');
      return;
    }
    setLoading(true);

    // Clear any guest state so user doesn't get stuck as guest if callback fails
    const savedUser = localStorage.getItem('gather_user');
    if (savedUser) {
      try {
        const parsed = JSON.parse(savedUser);
        if (parsed.email === 'guest@gathertracker.app') {
          localStorage.removeItem('gather_user');
          localStorage.removeItem('gather_user_role');
          localStorage.removeItem('gather_onboarded');
        }
      } catch (e) {}
    }

    try {
      // Send OTP verification code email (works for staff and fellows with any email)
      const { error } = await supabase.auth.signInWithOtp({ email });

      if (error) {
        if (error.message?.toLowerCase().includes('rate') || error.status === 429) {
          alert('Too many login attempts. Please wait a minute before trying again.');
        } else {
          alert('Error sending code: ' + error.message);
        }
        setLoading(false);
      } else {
        setOtpSent(true);
        setLoading(false);
      }
    } catch (err) {
      console.error('signInWithOtp failed:', err);
      alert('Could not send verification code. Please check your connection and try again.');
      setLoading(false);
    }
  };

  const handleVerifyOtp = async (e) => {
    e.preventDefault();
    if (!otpCode || otpCode.length < 6) {
      alert('Please enter the code from your email');
      return;
    }
    setVerifying(true);
    try {
      const { data, error } = await supabase.auth.verifyOtp({
        email,
        token: otpCode,
        type: 'email'
      });
      if (error) {
        alert('Invalid or expired code. Please try again.');
        setVerifying(false);
      } else if (data?.session?.user) {
        // Explicitly handle success â€” don't rely solely on onAuthStateChange
        const sessionUser = data.session.user;
        const userData = {
          id: sessionUser.id,
          email: sessionUser.email,
          name: sessionUser.user_metadata?.full_name || sessionUser.email?.split('@')[0],
        };
        console.log('OTP verified successfully, calling onLogin for:', userData.email);
        onLogin(userData);
      }
    } catch (err) {
      console.error('verifyOtp failed:', err);
      alert('Verification failed. Please check your connection and try again.');
      setVerifying(false);
    }
  };

  const handleResendCode = async () => {
    setLoading(true);
    setOtpCode('');
    try {
      const { error } = await supabase.auth.signInWithOtp({ email });
      if (error) {
        alert('Error resending code: ' + error.message);
      } else {
        alert('New code sent! Check your email.');
      }
    } catch (err) {
      alert('Could not resend code. Please try again.');
    }
    setLoading(false);
  };

  return (
    <div className="min-h-screen flex flex-col p-6 pb-32 bg-white safe-top">
      <div className="flex-1 flex flex-col justify-center max-w-sm mx-auto w-full">
        <div className="fade-in">
          <div className="w-24 h-24 mb-8">
            <img
              src={GATHER_LOGO}
              alt="GATHER"
              className="w-full h-full object-contain"
            />
          </div>

          <h1 className="text-2xl font-bold text-gray-900 mb-2">Welcome back</h1>
          <p className="text-gray-500 mb-8">Sign in with your email</p>

          {/* Step 1: Email input â€” always visible */}
          <form onSubmit={handleEmailLogin}>
            <input
              type="email"
              placeholder="your@email.com"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="w-full border-2 border-gray-200 rounded-2xl px-4 py-4 text-gray-900 placeholder-gray-400 focus:border-goldin-orange focus:outline-none mb-4"
              disabled={otpSent}
              required
            />
            <button
              type="submit"
              disabled={loading || otpSent}
              className="w-full bg-orange-600 text-white font-semibold py-4 px-6 rounded-2xl active:scale-98 transition disabled:opacity-50 shadow-sm"
            >
              {loading ? 'Sending code...' : otpSent ? 'Code sent â€” check your email' : 'Send Verification Code'}
            </button>
          </form>

          {/* Step 2: Code input â€” always in DOM, shown/hidden via CSS */}
          <div style={{ display: otpSent ? 'block' : 'none' }}>
            <div className="mt-6 pt-6 border-t border-gray-200">
              <p className="text-sm text-gray-600 mb-2">Enter the code sent to <strong>{email}</strong></p>
              <form onSubmit={handleVerifyOtp}>
                <input
                  type="text"
                  inputMode="numeric"
                  pattern="[0-9]*"
                  maxLength={8}
                  placeholder="00000000"
                  value={otpCode}
                  onChange={(e) => setOtpCode(e.target.value.replace(/[^0-9]/g, '').slice(0, 8))}
                  className="w-full border-2 border-gray-200 rounded-2xl px-4 py-4 text-center text-2xl font-mono tracking-widest text-gray-900 placeholder-gray-300 focus:border-goldin-orange focus:outline-none mb-4"
                  autoFocus
                />
                <button
                  type="submit"
                  disabled={verifying || otpCode.length < 6}
                  className="w-full bg-orange-600 text-white font-semibold py-4 px-6 rounded-2xl active:scale-98 transition disabled:opacity-50 shadow-sm"
                >
                  {verifying ? 'Verifying...' : 'Verify Code'}
                </button>
                <div className="flex gap-3 mt-3">
                  <button
                    type="button"
                    onClick={handleResendCode}
                    disabled={loading}
                    className="flex-1 text-sm text-orange-600 font-medium py-2"
                  >
                    {loading ? 'Sending...' : 'Resend code'}
                  </button>
                  <button
                    type="button"
                    onClick={() => { setOtpSent(false); setOtpCode(''); }}
                    className="flex-1 text-sm text-gray-500 py-2"
                  >
                    Different email
                  </button>
                </div>
              </form>
            </div>
          </div>

          <div className="mt-8 pt-6 border-t border-gray-200">
            <button
              onClick={() => onLogin({ email: 'guest@gathertracker.app', name: 'Guest' }, true)}
              className="w-full bg-gray-100 text-gray-700 font-semibold py-4 px-6 rounded-2xl active:scale-95 transition"
            >
              Skip for now â†’
            </button>
            <p className="text-xs text-gray-400 text-center mt-3">View public directory without signing in</p>
          </div>
        </div>
      </div>
    </div>
  );
}

// ============================================
// PROFILE CLAIMING - "Is This You?" Screen
// ============================================

// Find potential profile matches based on email name parts
async function findPotentialMatches(loginEmail) {
  const localPart = loginEmail.split('@')[0];
  const nameParts = localPart
    .replace(/[0-9]/g, '')
    .replace(/[._-]/g, ' ')
    .split(' ')
    .filter(p => p.length > 2);

  if (nameParts.length === 0) {
    return { fellows: [], teamMembers: [] };
  }

  // Build OR query for name matching
  const nameQuery = nameParts
    .map(p => `first_name.ilike.%${p}%,last_name.ilike.%${p}%`)
    .join(',');

  // Search unclaimed fellows
  const { data: fellows } = await supabase
    .from('fellows')
    .select('id, first_name, last_name, email, program, cohort, photo_url')
    .is('user_id', null)
    .or(nameQuery)
    .limit(5);

  // Search unclaimed team members
  const { data: teamMembers } = await supabase
    .from('team_members')
    .select('id, first_name, last_name, email, title, photo_url')
    .is('user_id', null)
    .eq('is_active', true)
    .or(nameQuery)
    .limit(5);

  return { fellows: fellows || [], teamMembers: teamMembers || [] };
}

function IsThisYouScreen({ email, userId, potentialMatches, onClaim, onSkip, onSearch }) {
  const [searchQuery, setSearchQuery] = useState('');
  const [searchResults, setSearchResults] = useState(null);
  const [searching, setSearching] = useState(false);
  const [claiming, setClaiming] = useState(null);
  const [showConfirm, setShowConfirm] = useState(null);

  const allMatches = [
    ...(potentialMatches?.fellows || []).map(f => ({ ...f, type: 'fellow' })),
    ...(potentialMatches?.teamMembers || []).map(t => ({ ...t, type: 'team_member' })),
  ];

  const handleSearch = async () => {
    if (!searchQuery.trim() || searchQuery.length < 2) return;
    setSearching(true);

    const query = searchQuery.toLowerCase();
    const { data: fellows } = await supabase
      .from('fellows')
      .select('id, first_name, last_name, email, program, cohort, photo_url')
      .is('user_id', null)
      .or(`first_name.ilike.%${query}%,last_name.ilike.%${query}%`)
      .limit(10);

    const { data: teamMembers } = await supabase
      .from('team_members')
      .select('id, first_name, last_name, email, title, photo_url')
      .is('user_id', null)
      .eq('is_active', true)
      .or(`first_name.ilike.%${query}%,last_name.ilike.%${query}%`)
      .limit(10);

    setSearchResults([
      ...(fellows || []).map(f => ({ ...f, type: 'fellow' })),
      ...(teamMembers || []).map(t => ({ ...t, type: 'team_member' })),
    ]);
    setSearching(false);
  };

  const handleClaimRequest = async (profile) => {
    setClaiming(profile.id);

    // Create a claim request
    const { error } = await supabase
      .from('profile_claim_requests')
      .insert({
        requesting_email: email,
        requesting_user_id: userId,
        target_type: profile.type,
        target_id: profile.id,
        status: 'pending',
      });

    if (error) {
      alert('Error submitting claim: ' + error.message);
      setClaiming(null);
      return;
    }

    // Show confirmation
    setShowConfirm(profile);
    setClaiming(null);
  };

  if (showConfirm) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
        <div className="bg-white rounded-3xl shadow-xl p-8 max-w-md w-full text-center">
          <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg className="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <h2 className="text-2xl font-bold text-gray-900 mb-2">Claim Request Sent!</h2>
          <p className="text-gray-600 mb-6">
            An admin will review your request to link <strong>{email}</strong> to {showConfirm.first_name} {showConfirm.last_name}'s profile.
          </p>
          <p className="text-sm text-gray-500 mb-6">
            You'll receive an email once it's approved. In the meantime, you can browse the directory.
          </p>
          <button
            onClick={onSkip}
            className="w-full bg-goldin-orange text-white font-semibold py-4 rounded-2xl"
          >
            Continue to Directory
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 flex flex-col">
      {/* Header */}
      <div className="bg-white border-b border-gray-200 px-4 py-4">
        <div className="flex items-center justify-center">
          <img src={GATHER_LOGO} alt="GATHER" className="h-8" />
        </div>
      </div>

      <div className="flex-1 p-4 overflow-auto">
        <div className="max-w-md mx-auto">
          {/* Message */}
          <div className="text-center mb-6">
            <div className="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <span className="text-3xl">ðŸ‘‹</span>
            </div>
            <h2 className="text-2xl font-bold text-gray-900 mb-2">We don't recognize that email</h2>
            <p className="text-gray-600">
              <strong>{email}</strong> isn't linked to a profile yet.
            </p>
          </div>

          {/* Potential Matches */}
          {allMatches.length > 0 && (
            <div className="mb-6">
              <h3 className="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3">
                Are you one of these people?
              </h3>
              <div className="space-y-3">
                {allMatches.map(profile => (
                  <div key={profile.id} className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                    <div className="flex items-center gap-3">
                      <div className="w-12 h-12 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
                        {profile.photo_url ? (
                          <img src={profile.photo_url} alt="" className="w-full h-full object-cover" />
                        ) : (
                          <div className="w-full h-full flex items-center justify-center text-gray-400 font-semibold">
                            {profile.first_name?.[0]}{profile.last_name?.[0]}
                          </div>
                        )}
                      </div>
                      <div className="flex-1 min-w-0">
                        <p className="font-semibold text-gray-900">{profile.first_name} {profile.last_name}</p>
                        <p className="text-sm text-gray-500">
                          {profile.type === 'fellow'
                            ? `${profile.program || 'Fellow'}${profile.cohort_year ? `, ${profile.cohort_year}` : ''}`
                            : profile.title || 'Staff'}
                        </p>
                        <p className="text-xs text-gray-400 truncate">{profile.email}</p>
                      </div>
                      <button
                        onClick={() => handleClaimRequest(profile)}
                        disabled={claiming === profile.id}
                        className="px-4 py-2 bg-goldin-orange text-white text-sm font-semibold rounded-xl disabled:opacity-50"
                      >
                        {claiming === profile.id ? '...' : 'This is me'}
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Search */}
          <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-6">
            <h3 className="text-sm font-semibold text-gray-700 mb-3">
              ðŸ” Search by name
            </h3>
            <div className="flex gap-2">
              <input
                type="text"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && handleSearch()}
                placeholder="Enter your name..."
                className="flex-1 border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-goldin-orange"
              />
              <button
                onClick={handleSearch}
                disabled={searching || searchQuery.length < 2}
                className="px-4 py-3 bg-gray-100 rounded-xl font-medium text-gray-700 disabled:opacity-50"
              >
                {searching ? '...' : 'Search'}
              </button>
            </div>

            {/* Search Results */}
            {searchResults && (
              <div className="mt-4 space-y-2">
                {searchResults.length === 0 ? (
                  <p className="text-sm text-gray-500 text-center py-4">No unclaimed profiles found</p>
                ) : (
                  searchResults.map(profile => (
                    <div key={profile.id} className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
                      <div className="w-10 h-10 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
                        {profile.photo_url ? (
                          <img src={profile.photo_url} alt="" className="w-full h-full object-cover" />
                        ) : (
                          <div className="w-full h-full flex items-center justify-center text-gray-400 text-sm font-semibold">
                            {profile.first_name?.[0]}{profile.last_name?.[0]}
                          </div>
                        )}
                      </div>
                      <div className="flex-1 min-w-0">
                        <p className="font-medium text-gray-900 text-sm">{profile.first_name} {profile.last_name}</p>
                        <p className="text-xs text-gray-500 truncate">{profile.email}</p>
                      </div>
                      <button
                        onClick={() => handleClaimRequest(profile)}
                        disabled={claiming === profile.id}
                        className="px-3 py-1.5 bg-goldin-orange text-white text-xs font-semibold rounded-lg disabled:opacity-50"
                      >
                        {claiming === profile.id ? '...' : 'Claim'}
                      </button>
                    </div>
                  ))
                )}
              </div>
            )}
          </div>

          {/* Skip */}
          <button
            onClick={onSkip}
            className="w-full bg-gray-100 text-gray-700 font-semibold py-4 rounded-2xl mb-4"
          >
            I'm not in the system yet
          </button>
          <p className="text-xs text-gray-400 text-center">
            Browse the public directory without claiming a profile
          </p>
        </div>
      </div>
    </div>
  );
}

function NotificationSetupScreen({ onComplete }) {
  const [settings, setSettings] = useState({
    enabled: false,
    dailySummary: true,
    newActivity: true,
    overdueAlerts: true,
    newsAlerts: true,
  });
  const [permissionAsked, setPermissionAsked] = useState(false);

  const requestPermission = async () => {
    if ('Notification' in window) {
      const permission = await Notification.requestPermission();
      setSettings(s => ({ ...s, enabled: permission === 'granted' }));
      setPermissionAsked(true);
    } else {
      // Notifications not supported, skip to settings
      setPermissionAsked(true);
    }
  };

  const toggleSetting = (key) => {
    setSettings(s => ({ ...s, [key]: !s[key] }));
  };

  return (
    <div className="min-h-screen flex flex-col p-6 pb-32 bg-white safe-top overflow-auto">
      <div className="flex-1 flex flex-col justify-center max-w-sm mx-auto w-full">
        <div className="fade-in">
          <div className="w-16 h-16 bg-amber-100 rounded-2xl flex items-center justify-center mb-8">
            <span className="text-3xl">ðŸ””</span>
          </div>
          
          <h1 className="text-2xl font-bold text-gray-900 mb-2">Stay in the loop</h1>
          <p className="text-gray-500 mb-8">Get notified about important updates and never miss a follow-up</p>
          
          {!permissionAsked ? (
            <>
              <div className="bg-gray-50 rounded-2xl p-5 mb-6">
                <div className="flex items-start gap-4 mb-4">
                  <span className="text-2xl">ðŸ“Š</span>
                  <div>
                    <h3 className="font-semibold text-gray-900">Daily Summary</h3>
                    <p className="text-sm text-gray-500">Morning overview of your priorities</p>
                  </div>
                </div>
                <div className="flex items-start gap-4 mb-4">
                  <span className="text-2xl">âš¡</span>
                  <div>
                    <h3 className="font-semibold text-gray-900">Activity Alerts</h3>
                    <p className="text-sm text-gray-500">When team members log interactions</p>
                  </div>
                </div>
                <div className="flex items-start gap-4">
                  <span className="text-2xl">ðŸ“°</span>
                  <div>
                    <h3 className="font-semibold text-gray-900">News Mentions</h3>
                    <p className="text-sm text-gray-500">When fellows appear in the news</p>
                  </div>
                </div>
              </div>
              
              <button 
                onClick={requestPermission}
                className="w-full bg-goldin-orange text-white font-semibold py-5 px-6 rounded-2xl active:scale-95 transition mb-4"
              >
                Enable Notifications
              </button>
              <button 
                onClick={() => onComplete(settings)}
                className="w-full bg-gray-100 text-gray-600 font-semibold py-5 px-6 rounded-2xl active:scale-95 transition"
              >
                Maybe later
              </button>
            </>
          ) : (
            <>
              <div className="space-y-3 mb-8">
                {[
                  { key: 'dailySummary', label: 'Daily Summary', desc: '8am each morning', icon: 'ðŸ“Š' },
                  { key: 'newActivity', label: 'Team Activity', desc: 'When interactions are logged', icon: 'âš¡' },
                  { key: 'overdueAlerts', label: 'Overdue Alerts', desc: 'When follow-ups become overdue', icon: 'ðŸ”´' },
                  { key: 'newsAlerts', label: 'News Mentions', desc: 'When fellows are in the news', icon: 'ðŸ“°' },
                ].map(item => (
                  <button
                    key={item.key}
                    onClick={() => toggleSetting(item.key)}
                    className={`w-full flex items-center gap-4 p-4 rounded-2xl border-2 transition ${
                      settings[item.key] ? 'border-goldin-orange bg-orange-50' : 'border-gray-200'
                    }`}
                  >
                    <span className="text-2xl">{item.icon}</span>
                    <div className="flex-1 text-left">
                      <h3 className="font-semibold text-gray-900">{item.label}</h3>
                      <p className="text-sm text-gray-500">{item.desc}</p>
                    </div>
                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${
                      settings[item.key] ? 'bg-goldin-orange border-goldin-orange' : 'border-gray-300'
                    }`}>
                      {settings[item.key] && (
                        <svg className="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                        </svg>
                      )}
                    </div>
                  </button>
                ))}
              </div>
              
              <button 
                onClick={() => onComplete(settings)}
                className="w-full bg-goldin-orange text-white font-semibold py-5 px-6 rounded-2xl active:scale-95 transition"
              >
                Continue to GATHER
              </button>
            </>
          )}
        </div>
      </div>
    </div>
  );
}

// Combined Language + Notification Onboarding Screen
function OnboardingSetupScreen({ onComplete }) {
  const [step, setStep] = useState(1); // 1 = language, 2 = notifications
  const [selectedLang, setSelectedLang] = useState('en');
  const [notifSettings, setNotifSettings] = useState({
    enabled: false,
    dailySummary: true,
    newActivity: true,
    overdueAlerts: true,
    newsAlerts: true,
  });
  const [permissionAsked, setPermissionAsked] = useState(false);

  const requestNotificationPermission = async () => {
    if ('Notification' in window) {
      const permission = await Notification.requestPermission();
      setNotifSettings(s => ({ ...s, enabled: permission === 'granted' }));
    }
    setPermissionAsked(true);
  };

  const handleComplete = () => {
    onComplete(selectedLang, notifSettings);
  };

  // Step 1: Language Selection
  if (step === 1) {
    return (
      <div className="min-h-screen flex flex-col p-6 pb-32 bg-white safe-top overflow-auto">
        <div className="flex-1 flex flex-col justify-center max-w-sm mx-auto w-full">
          <div className="fade-in">
            <div className="w-16 h-16 bg-blue-100 rounded-2xl flex items-center justify-center mb-8">
              <span className="text-3xl">ðŸŒ</span>
            </div>

            <h1 className="text-2xl font-bold text-gray-900 mb-2">Choose your language</h1>
            <p className="text-gray-500 mb-8">Select your preferred language for the app</p>

            <div className="grid grid-cols-2 gap-3 mb-8">
              {SUPPORTED_LANGUAGES.map(lang => (
                <button
                  key={lang.code}
                  onClick={() => setSelectedLang(lang.code)}
                  className={`p-4 rounded-2xl border-2 text-left transition-all ${
                    selectedLang === lang.code
                      ? 'border-goldin-orange bg-orange-50'
                      : 'border-gray-200 hover:border-gray-300'
                  }`}
                >
                  <p className="font-semibold text-gray-900">{lang.native}</p>
                  <p className="text-sm text-gray-500">{lang.name}</p>
                </button>
              ))}
            </div>

            <button
              onClick={() => setStep(2)}
              className="w-full text-white font-semibold py-5 px-6 rounded-2xl active:scale-95 transition"
              style={{ backgroundColor: '#E87722' }}
            >
              Continue
            </button>
          </div>
        </div>
      </div>
    );
  }

  // Step 2: Notification Opt-in
  return (
    <div className="min-h-screen flex flex-col p-6 pb-32 bg-white safe-top overflow-auto">
      <div className="flex-1 flex flex-col justify-center max-w-sm mx-auto w-full">
        <div className="fade-in">
          <div className="w-16 h-16 bg-amber-100 rounded-2xl flex items-center justify-center mb-8">
            <span className="text-3xl">ðŸ””</span>
          </div>

          <h1 className="text-2xl font-bold text-gray-900 mb-2">Stay in the loop</h1>
          <p className="text-gray-500 mb-8">Get notified about important updates and never miss a follow-up</p>

          {!permissionAsked ? (
            <>
              <div className="bg-gray-50 rounded-2xl p-5 mb-6">
                <div className="flex items-start gap-4 mb-4">
                  <span className="text-2xl">ðŸ“Š</span>
                  <div>
                    <h3 className="font-semibold text-gray-900">Daily Summary</h3>
                    <p className="text-sm text-gray-500">Morning overview of your priorities</p>
                  </div>
                </div>
                <div className="flex items-start gap-4 mb-4">
                  <span className="text-2xl">âš¡</span>
                  <div>
                    <h3 className="font-semibold text-gray-900">Activity Alerts</h3>
                    <p className="text-sm text-gray-500">When team members log interactions</p>
                  </div>
                </div>
                <div className="flex items-start gap-4">
                  <span className="text-2xl">ðŸ“°</span>
                  <div>
                    <h3 className="font-semibold text-gray-900">News Mentions</h3>
                    <p className="text-sm text-gray-500">When fellows appear in the news</p>
                  </div>
                </div>
              </div>

              <button
                onClick={requestNotificationPermission}
                className="w-full text-white font-semibold py-5 px-6 rounded-2xl active:scale-95 transition mb-4"
                style={{ backgroundColor: '#E87722' }}
              >
                Enable Notifications
              </button>
              <button
                onClick={handleComplete}
                className="w-full bg-gray-100 text-gray-600 font-semibold py-5 px-6 rounded-2xl active:scale-95 transition"
              >
                Maybe later
              </button>
            </>
          ) : (
            <>
              <div className="space-y-3 mb-8">
                {[
                  { key: 'dailySummary', label: 'Daily Summary', desc: '8am each morning', icon: 'ðŸ“Š' },
                  { key: 'newActivity', label: 'Team Activity', desc: 'When interactions are logged', icon: 'âš¡' },
                  { key: 'overdueAlerts', label: 'Overdue Alerts', desc: 'When follow-ups become overdue', icon: 'ðŸ”´' },
                  { key: 'newsAlerts', label: 'News Mentions', desc: 'When fellows are in the news', icon: 'ðŸ“°' },
                ].map(item => (
                  <button
                    key={item.key}
                    onClick={() => setNotifSettings(s => ({ ...s, [item.key]: !s[item.key] }))}
                    className={`w-full flex items-center gap-4 p-4 rounded-2xl border-2 transition ${
                      notifSettings[item.key] ? 'border-goldin-orange bg-orange-50' : 'border-gray-200'
                    }`}
                  >
                    <span className="text-2xl">{item.icon}</span>
                    <div className="flex-1 text-left">
                      <h3 className="font-semibold text-gray-900">{item.label}</h3>
                      <p className="text-sm text-gray-500">{item.desc}</p>
                    </div>
                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${
                      notifSettings[item.key] ? 'bg-goldin-orange border-goldin-orange' : 'border-gray-300'
                    }`}>
                      {notifSettings[item.key] && (
                        <svg className="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                        </svg>
                      )}
                    </div>
                  </button>
                ))}
              </div>

              <button
                onClick={handleComplete}
                className="w-full text-white font-semibold py-5 px-6 rounded-2xl active:scale-95 transition"
                style={{ backgroundColor: '#E87722' }}
              >
                Continue to GATHER
              </button>
            </>
          )}
        </div>
      </div>
    </div>
  );
}

// ============================================
// MAIN APP COMPONENTS
// ============================================
function StatusPill({ color, count, active, onClick }) {
  const colors = {
    green: { bg: 'bg-green-500', text: 'text-green-700', border: 'border-green-200', lightBg: 'bg-green-50' },
    yellow: { bg: 'bg-yellow-500', text: 'text-yellow-700', border: 'border-yellow-200', lightBg: 'bg-yellow-50' },
    red: { bg: 'bg-red-500', text: 'text-red-700', border: 'border-red-200', lightBg: 'bg-red-50' },
  };
  const c = colors[color];
  
  return (
    <button
      onClick={onClick}
      className={`flex-1 flex items-center justify-center gap-1.5 py-2.5 rounded-xl text-sm font-semibold transition-all ${
        active 
          ? `${c.bg} text-white shadow-md` 
          : `${c.lightBg} ${c.text} border ${c.border}`
      }`}
    >
      <span className={`w-2 h-2 rounded-full ${active ? 'bg-white' : c.bg}`}></span>
      {count}
    </button>
  );
}

// Consistent filter bar used across all pages
function StatusFilterBar({ statusFilter, setStatusFilter, statusCounts }) {
  return (
    <div className="flex gap-2 mb-4">
      <button
        onClick={() => setStatusFilter('')}
        className={`flex-1 py-2.5 rounded-xl text-sm font-semibold transition-all ${
          !statusFilter 
            ? 'bg-gray-900 text-white shadow-md' 
            : 'bg-gray-100 text-gray-700 border border-gray-200'
        }`}
      >
        All ({statusCounts.green + statusCounts.yellow + statusCounts.red})
      </button>
      <StatusPill 
        color="green" 
        count={statusCounts.green} 
        active={statusFilter === 'green'} 
        onClick={() => setStatusFilter(statusFilter === 'green' ? '' : 'green')} 
      />
      <StatusPill 
        color="yellow" 
        count={statusCounts.yellow} 
        active={statusFilter === 'yellow'} 
        onClick={() => setStatusFilter(statusFilter === 'yellow' ? '' : 'yellow')} 
      />
      <StatusPill 
        color="red" 
        count={statusCounts.red} 
        active={statusFilter === 'red'} 
        onClick={() => setStatusFilter(statusFilter === 'red' ? '' : 'red')} 
      />
    </div>
  );
}

function Header({ onMenuOpen, pageTitle, onAddInteraction }) {
  const { userRole, canAccess } = useContext(AppContext);
  const roleConfig = ROLE_CONFIG[userRole] || ROLE_CONFIG[ROLES.VIEWER];

  return (
    <header className="bg-white border-b border-gray-100 safe-top fixed top-0 left-0 right-0 z-40">
      <div className="flex items-center gap-3 px-4 py-3">
        {/* Menu Button */}
        <button
          onClick={onMenuOpen}
          className="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-gray-100 transition"
        >
          <svg className="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>

        {/* Logo */}
        <div className="flex items-center gap-2">
          <div className="w-8 h-8 rounded-lg overflow-hidden">
            <img src={GATHER_LOGO} alt="GATHER" className="w-full h-full object-contain" />
          </div>
        </div>

        {/* Page Title + Role Badge */}
        <div className="flex-1 flex items-center gap-2">
          <h1 className="text-lg font-bold text-gray-900">{pageTitle}</h1>
          <span className={`text-xs px-2 py-0.5 rounded-full text-white ${roleConfig.color}`}>
            {roleConfig.label}
          </span>
        </div>

        {/* Add Interaction Button - only show for team+ */}
        {onAddInteraction && canAccess(ROLES.TEAM) && (
          <button
            onClick={onAddInteraction}
            className="w-11 h-11 flex items-center justify-center rounded-xl text-white active:scale-95 transition"
            style={{
              backgroundColor: '#E87722',
              boxShadow: '0 4px 12px rgba(232, 119, 34, 0.5)'
            }}
          >
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={2.5}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
            </svg>
          </button>
        )}
      </div>
    </header>
  );
}

function SlideMenu({ isOpen, onClose, currentPage, onNavigate }) {
  const { user, userRole, logout, notificationSettings, canAccess, t } = useContext(AppContext);
  const roleConfig = ROLE_CONFIG[userRole] || ROLE_CONFIG[ROLES.VIEWER];
  
  // Menu items with optional role requirements
  const menuItems = [
    { id: 'dashboard', label: 'Dashboard', icon: 'ðŸ ', minRole: ROLES.TEAM },
    { id: 'cohorts', label: 'Cohorts', icon: 'ðŸŽ“', minRole: ROLES.TEAM },
    { id: 'directory', label: 'Directory', icon: 'ðŸ‘¥' }, // Public
    { id: 'community', label: 'Community', icon: 'ðŸ“¢' }, // Public - Feed only
    { id: 'library', label: 'Library', icon: 'ðŸ“š' }, // Public - Resources
    { id: 'search', label: 'Search', icon: 'ðŸ”' }, // Public
    { id: 'activity', label: 'Activity', icon: 'ðŸ“‹', minRole: ROLES.TEAM },
    { id: 'broadcast', label: 'Broadcast', icon: 'ðŸ“£', minRole: ROLES.TEAM },
  ].filter(item => !item.minRole || canAccess(item.minRole));

  return (
    <>
      {/* Backdrop */}
      <div 
        className={`fixed inset-0 bg-black/40 z-50 transition-opacity ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}
        onClick={onClose}
      />
      
      {/* Menu */}
      <div className={`slide-menu fixed inset-y-0 left-0 w-72 bg-white z-50 shadow-2xl ${isOpen ? 'open' : ''}`}>
        <div className="safe-top" />
        
        {/* User */}
        <div className="p-5 border-b border-gray-100">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 bg-goldin-orange rounded-xl flex items-center justify-center text-white font-bold text-lg">
              {user?.name?.split(' ').map(n => n[0]).join('') || '?'}
            </div>
            <div className="flex-1 min-w-0">
              <h3 className="font-semibold text-gray-900">{user?.name || 'Guest'}</h3>
              <p className="text-sm text-gray-500 truncate">{user?.email}</p>
              <span className={`inline-block mt-1 text-xs px-2 py-0.5 rounded-full text-white ${roleConfig.color}`}>
                {roleConfig.label}
              </span>
            </div>
          </div>
        </div>
        
        {/* Nav */}
        <nav className="p-3">
          {menuItems.map(item => (
            <button
              key={item.id}
              onClick={() => { onNavigate(item.id); onClose(); }}
              className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition ${
                currentPage === item.id 
                  ? 'bg-goldin-orange/10 text-goldin-orange' 
                  : 'text-gray-700 hover:bg-gray-100'
              }`}
            >
              <span className="text-xl">{item.icon}</span>
              <span className="font-medium">{t(item.label)}</span>
            </button>
          ))}
        </nav>
        
        <div className="border-t border-gray-100 mx-3" />
        
        {/* Settings */}
        <nav className="p-3">
          <button
            onClick={() => { onNavigate('settings'); onClose(); }}
            className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition ${
              currentPage === 'settings' 
                ? 'bg-goldin-orange/10 text-goldin-orange' 
                : 'text-gray-700 hover:bg-gray-100'
            }`}
          >
            <span className="text-xl">âš™ï¸</span>
            <span className="font-medium">Settings</span>
          </button>
          
          <button
            onClick={async () => {
              if (confirm('Are you sure you want to sign out?')) {
                await logout();
                onClose();
              }
            }}
            className="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-red-600 hover:bg-red-50 transition"
          >
            <span className="text-xl">ðŸšª</span>
            <span className="font-medium">Sign Out</span>
          </button>
        </nav>
        
        {/* Version */}
        <div className="absolute bottom-0 left-0 right-0 p-4 text-center text-xs text-gray-400 safe-bottom">
          GATHER v2.0 â€¢ Goldin Institute
        </div>
      </div>
    </>
  );
}

function QuickActionButton({ onClick }) {
  return (
    <button
      onClick={onClick}
      className="fixed bottom-6 right-4 w-16 h-16 bg-goldin-orange text-white rounded-full shadow-2xl flex items-center justify-center z-40 active:scale-95 transition"
      style={{ 
        marginBottom: 'env(safe-area-inset-bottom)',
        boxShadow: '0 8px 30px rgba(232, 119, 34, 0.5)'
      }}
    >
      <svg className="w-8 h-8" fill="none" stroke="currentColor" strokeWidth={3} viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
      </svg>
    </button>
  );
}

function SearchBar({ value, onChange, placeholder = "Search..." }) {
  return (
    <div className="relative">
      <svg className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
      <input
        type="text"
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder={placeholder}
        className="w-full pl-12 pr-4 py-3 bg-gray-100 rounded-2xl text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-goldin-orange/30"
      />
    </div>
  );
}

function ActivityItem({ activity, fellow, onClick }) {
  if (!fellow) return null;
  
  const icon = getInteractionIcon(activity.interaction_type);
  const badge = getProgramBadge(fellow.program);
  const time = getTimeAgo(activity.created_at);
  const staffName = activity.staff_email?.split('@')[0].split('.').map(n => n.charAt(0).toUpperCase() + n.slice(1)).join(' ') || 'Staff';
  
  return (
    <button 
      onClick={() => onClick && onClick(fellow)}
      className="activity-item w-full text-left flex gap-3 p-4 bg-white rounded-2xl shadow-sm border border-gray-100 mb-3 active:bg-gray-50 transition"
    >
      {/* Photo */}
      <div className="w-12 h-12 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
        {fellow.photo_url ? (
          <img src={fellow.photo_url} alt="" className="w-full h-full object-cover" />
        ) : (
          <div className="w-full h-full flex items-center justify-center text-gray-400 text-lg font-semibold">
            {fellow.first_name?.[0]}{fellow.last_name?.[0]}
          </div>
        )}
      </div>
      
      {/* Content */}
      <div className="flex-1 min-w-0">
        <div className="flex items-start justify-between gap-2">
          <div>
            <p className="font-semibold text-gray-900">
              {fellow.first_name} {fellow.last_name}
              <span className={`ml-2 text-xs px-1.5 py-0.5 rounded ${badge.bg} text-white`}>
                {badge.label}
              </span>
            </p>
            <p className="text-sm text-gray-500">
              {icon} <T>{activity.interaction_type}</T> â€¢ {staffName}
            </p>
          </div>
          <span className="text-xs text-gray-400 whitespace-nowrap">{time}</span>
        </div>

        {activity.subject && (
          <p className="text-sm text-gray-700 mt-1 font-medium"><T>{activity.subject}</T></p>
        )}
        {activity.notes && (
          <p className="text-sm text-gray-500 mt-1 line-clamp-2"><T>{activity.notes}</T></p>
        )}
      </div>
      
      {/* Arrow */}
      <div className="flex items-center">
        <svg className="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
        </svg>
      </div>
    </button>
  );
}

// ============================================
// PAGES
// ============================================
function DashboardPage({ onLogInteraction, onSelectFellow }) {
  const { fellows, interactions, activities, fellowFocusTags, focusCategories, focusTags, fetchData, t } = useContext(AppContext);
  const [timeRange, setTimeRange] = useState('month');
  const [aiSearchOpen, setAiSearchOpen] = useState(false);
  const [aiMessages, setAiMessages] = useState([]);
  const [aiInput, setAiInput] = useState('');
  const [aiLoading, setAiLoading] = useState(false);

  // Overall status counts
  const statusCounts = useMemo(() => {
    const counts = { green: 0, yellow: 0, red: 0 };
    fellows.forEach(f => {
      counts[getContactStatus(f.last_contact).color]++;
    });
    return counts;
  }, [fellows]);

  // Status counts by program
  const programHealthStats = useMemo(() => {
    const programs = { CPF: { green: 0, yellow: 0, red: 0, total: 0, color: 'bg-blue-700' },
                       GGF: { green: 0, yellow: 0, red: 0, total: 0, color: 'bg-orange-500' },
                       ESP: { green: 0, yellow: 0, red: 0, total: 0, color: 'bg-orange-700' } };
    fellows.forEach(f => {
      const badge = getProgramBadge(f.program);
      const status = getContactStatus(f.last_contact).color;
      if (programs[badge.label]) {
        programs[badge.label][status]++;
        programs[badge.label].total++;
      }
    });
    return programs;
  }, [fellows]);

  const networkHealth = fellows.length > 0
    ? Math.round((statusCounts.green + statusCounts.yellow * 0.5) / fellows.length * 100)
    : 0;

  // Generate mock trend data for the graph (in production this would come from actual historical data)
  // Calculate health percentage for a group of fellows
  const calculateHealth = (fellowList) => {
    if (fellowList.length === 0) return 0;
    let green = 0, yellow = 0;
    fellowList.forEach(f => {
      const status = getContactStatus(f.last_contact).color;
      if (status === 'green') green++;
      else if (status === 'yellow') yellow++;
    });
    return Math.round((green + yellow * 0.5) / fellowList.length * 100);
  };

  // Current health by program
  const programCurrentHealth = useMemo(() => {
    const cpf = fellows.filter(f => getProgramBadge(f.program).label === 'CPF');
    const ggf = fellows.filter(f => getProgramBadge(f.program).label === 'GGF');
    const esp = fellows.filter(f => getProgramBadge(f.program).label === 'ESP');
    return {
      all: networkHealth,
      CPF: calculateHealth(cpf),
      GGF: calculateHealth(ggf),
      ESP: calculateHealth(esp),
    };
  }, [fellows, networkHealth]);

  // Calculate health score as if measured on a specific date
  const calculateHealthAtDate = (fellowList, asOfDate) => {
    if (fellowList.length === 0) return 0;
    let green = 0, yellow = 0;
    fellowList.forEach(f => {
      if (!f.last_contact) return; // No contact = red
      const daysSince = Math.floor((asOfDate - new Date(f.last_contact)) / (1000 * 60 * 60 * 24));
      if (daysSince <= 30) green++;
      else if (daysSince <= 90) yellow++;
      // else red (not counted)
    });
    return Math.round((green + yellow * 0.5) / fellowList.length * 100);
  };

  const trendData = useMemo(() => {
    const today = new Date();
    today.setHours(23, 59, 59, 999);

    // Only week view has real data - others show "not enough data"
    const hasRealData = timeRange === 'week';

    if (!hasRealData) {
      // Return null data for non-week views
      const dataPoints = timeRange === 'month' ? 4 : 12;
      const labels = timeRange === 'month'
        ? ['Week 1', 'Week 2', 'Week 3', 'Week 4']
        : ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return {
        labels: labels.slice(0, dataPoints),
        all: null, CPF: null, GGF: null, ESP: null,
        noData: true
      };
    }

    // Generate real data for past 7 days
    const labels = [];
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const allData = [], cpfData = [], ggfData = [], espData = [];

    const cpfFellows = fellows.filter(f => getProgramBadge(f.program).label === 'CPF');
    const ggfFellows = fellows.filter(f => getProgramBadge(f.program).label === 'GGF');
    const espFellows = fellows.filter(f => getProgramBadge(f.program).label === 'ESP');

    for (let i = 6; i >= 0; i--) {
      const date = new Date(today);
      date.setDate(date.getDate() - i);
      labels.push(dayNames[date.getDay()]);

      allData.push(calculateHealthAtDate(fellows, date));
      cpfData.push(calculateHealthAtDate(cpfFellows, date));
      ggfData.push(calculateHealthAtDate(ggfFellows, date));
      espData.push(calculateHealthAtDate(espFellows, date));
    }

    return {
      labels,
      all: allData,
      CPF: cpfData,
      GGF: ggfData,
      ESP: espData,
      noData: false
    };
  }, [timeRange, fellows]);

  // AI Search - send query to Edge Function
  const sendAiQuery = async (query) => {
    if (!query.trim() || aiLoading) return;

    const userMsg = { role: 'user', content: query };
    setAiMessages(prev => [...prev, userMsg]);
    setAiInput('');
    setAiLoading(true);

    try {
      const session = await supabase.auth.getSession();
      const response = await fetch(`${SUPABASE_URL}/functions/v1/ai-search`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': session?.data?.session?.access_token
            ? `Bearer ${session.data.session.access_token}`
            : `Bearer ${SUPABASE_ANON_KEY}`,
        },
        body: JSON.stringify({
          query,
          conversation: aiMessages.slice(-6), // Last 3 exchanges for context
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'AI search failed');
      }

      // Resolve fellow IDs to actual fellow objects
      const matchedFellows = (data.fellows || []).map(match => {
        const fellow = fellows.find(f => f.id === match.id);
        return fellow ? { ...match, fellow } : match;
      }).filter(m => m.fellow);

      setAiMessages(prev => [...prev, {
        role: 'assistant',
        content: data.message,
        fellows: matchedFellows,
      }]);
    } catch (err) {
      console.error('AI search error:', err);
      setAiMessages(prev => [...prev, {
        role: 'assistant',
        content: `Sorry, I had trouble searching: ${err.message}. Please try again.`,
        fellows: [],
      }]);
    } finally {
      setAiLoading(false);
    }
  };

  // Multi-line SVG graph
  const renderGraph = () => {
    const width = 300;
    const height = 140;
    const padding = 20;
    const graphWidth = width - padding * 2;
    const graphHeight = height - padding * 2;

    const series = [
      { key: 'all', color: '#E87722', width: 3.5, label: 'All Alumni' },
      { key: 'CPF', color: '#3B82F6', width: 1.5, label: 'CPF' },
      { key: 'GGF', color: '#22C55E', width: 1.5, label: 'GGF' },
      { key: 'ESP', color: '#C2410C', width: 1.5, label: 'ESP' },
    ];

    const getPoints = (data) => {
      return data.map((value, index) => {
        const x = padding + (index / (data.length - 1)) * graphWidth;
        const y = height - padding - (value / 100) * graphHeight;
        return `${x},${y}`;
      }).join(' ');
    };

    return (
      <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-36">
        {/* Grid lines */}
        {[0, 25, 50, 75, 100].map(v => (
          <line
            key={v}
            x1={padding}
            x2={width - padding}
            y1={height - padding - (v / 100) * graphHeight}
            y2={height - padding - (v / 100) * graphHeight}
            stroke="#E5E7EB"
            strokeWidth="1"
          />
        ))}
        {/* Program lines (thinner, drawn first so they're behind) */}
        {series.slice(1).map(s => (
          <polyline
            key={s.key}
            points={getPoints(trendData[s.key])}
            fill="none"
            stroke={s.color}
            strokeWidth={s.width}
            strokeLinecap="round"
            strokeLinejoin="round"
            opacity="0.8"
          />
        ))}
        {/* All Alumni line (bold, on top) */}
        <polyline
          points={getPoints(trendData.all)}
          fill="none"
          stroke="#E87722"
          strokeWidth="3.5"
          strokeLinecap="round"
          strokeLinejoin="round"
        />
      </svg>
    );
  };

  // Legend for the graph
  const graphLegend = [
    { label: 'All Alumni', color: 'bg-goldin-orange', bold: true },
    { label: 'CPF', color: 'bg-blue-700', bold: false },
    { label: 'GGF', color: 'bg-orange-500', bold: false },
    { label: 'ESP', color: 'bg-orange-700', bold: false },
  ];

  return (
    <div className="p-4 pb-24">
      {/* Network Health - Full Width */}
      <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 mb-4">
        <div className="flex items-center justify-between mb-3">
          <div>
            <p className="text-sm text-gray-500">{t('Network Health')}</p>
            <p className="text-4xl font-bold text-gray-900">{networkHealth}%</p>
          </div>
          <div className="flex items-center gap-4 text-sm">
            <div className="flex items-center gap-1.5">
              <div className="w-3 h-3 rounded-full bg-green-500"></div>
              <span className="text-gray-600">{statusCounts.green}</span>
            </div>
            <div className="flex items-center gap-1.5">
              <div className="w-3 h-3 rounded-full bg-yellow-500"></div>
              <span className="text-gray-600">{statusCounts.yellow}</span>
            </div>
            <div className="flex items-center gap-1.5">
              <div className="w-3 h-3 rounded-full bg-red-500"></div>
              <span className="text-gray-600">{statusCounts.red}</span>
            </div>
          </div>
        </div>
        <div className="h-3 bg-gray-100 rounded-full overflow-hidden flex">
          <div className="bg-green-500 h-full" style={{ width: `${(statusCounts.green / fellows.length) * 100}%` }}></div>
          <div className="bg-yellow-500 h-full" style={{ width: `${(statusCounts.yellow / fellows.length) * 100}%` }}></div>
          <div className="bg-red-500 h-full" style={{ width: `${(statusCounts.red / fellows.length) * 100}%` }}></div>
        </div>
      </div>

      {/* Health by Program */}
      <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-4">
        <h3 className="text-sm font-semibold text-gray-700 mb-3">Health by Program</h3>
        <div className="space-y-3">
          {Object.entries(programHealthStats).filter(([_, data]) => data.total > 0).map(([label, data]) => (
            <div key={label} className="flex items-center gap-3">
              <span className={`text-xs px-2.5 py-1 rounded-lg ${data.color} text-white font-bold w-12 text-center`}>{label}</span>
              <div className="flex-1 flex items-center gap-2">
                <div className="flex items-center gap-1">
                  <div className="w-2.5 h-2.5 rounded-full bg-green-500"></div>
                  <span className="text-xs text-gray-600 w-5">{data.green}</span>
                </div>
                <div className="flex items-center gap-1">
                  <div className="w-2.5 h-2.5 rounded-full bg-yellow-500"></div>
                  <span className="text-xs text-gray-600 w-5">{data.yellow}</span>
                </div>
                <div className="flex items-center gap-1">
                  <div className="w-2.5 h-2.5 rounded-full bg-red-500"></div>
                  <span className="text-xs text-gray-600 w-5">{data.red}</span>
                </div>
              </div>
              <span className="text-sm text-gray-500 font-medium">{data.total} total</span>
            </div>
          ))}
        </div>
      </div>

      {/* Health Trend Graph */}
      <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-4">
        <div className="flex items-center justify-between mb-3">
          <h3 className="text-sm font-semibold text-gray-700">Health Trend</h3>
          <div className="flex bg-gray-100 rounded-lg p-0.5">
            {['week', 'month', 'quarter', 'year'].map(range => (
              <button
                key={range}
                onClick={() => setTimeRange(range)}
                className={`px-2.5 py-1 text-xs font-medium rounded-md transition ${
                  timeRange === range
                    ? 'bg-white text-gray-900 shadow-sm'
                    : 'text-gray-500 hover:text-gray-700'
                }`}
              >
                {range.charAt(0).toUpperCase() + range.slice(1)}
              </button>
            ))}
          </div>
        </div>
        {trendData.noData ? (
          <div className="h-36 flex flex-col items-center justify-center text-center">
            <span className="text-2xl mb-2">ðŸ“Š</span>
            <p className="text-sm font-medium" style={{ color: '#6B7280' }}>Not enough historical data</p>
            <p className="text-xs" style={{ color: '#9CA3AF' }}>Select "Week" to see real trend data</p>
          </div>
        ) : (
          <>
            {renderGraph()}
            <div className="flex justify-between text-xs mt-1 px-1" style={{ color: '#9CA3AF' }}>
              {trendData.labels.map((label, i) => (
                <span key={i}>{label}</span>
              ))}
            </div>
          </>
        )}
        {/* Legend */}
        <div className="flex flex-wrap items-center justify-center gap-4 mt-3 pt-3 border-t border-gray-100">
          <div className="flex items-center gap-1.5">
            <div className="w-5 h-1.5 rounded-full" style={{ backgroundColor: '#E87722' }}></div>
            <span className="text-xs font-semibold" style={{ color: '#374151' }}>All Alumni</span>
          </div>
          <div className="flex items-center gap-1.5">
            <div className="w-4 h-1 rounded-full" style={{ backgroundColor: '#3B82F6' }}></div>
            <span className="text-xs" style={{ color: '#6B7280' }}>CPF</span>
          </div>
          <div className="flex items-center gap-1.5">
            <div className="w-4 h-1 rounded-full" style={{ backgroundColor: '#22C55E' }}></div>
            <span className="text-xs" style={{ color: '#6B7280' }}>GGF</span>
          </div>
          <div className="flex items-center gap-1.5">
            <div className="w-4 h-1 rounded-full" style={{ backgroundColor: '#C2410C' }}></div>
            <span className="text-xs" style={{ color: '#6B7280' }}>ESP</span>
          </div>
        </div>
      </div>

      {/* AI Search Button */}
      <button
        onClick={() => setAiSearchOpen(true)}
        className="w-full p-6 rounded-2xl shadow-xl flex items-center justify-center gap-4 active:scale-[0.98] transition mb-4"
        style={{ background: 'linear-gradient(to right, #E87722, #F97316)', border: '3px solid #EA580C' }}
      >
        <span className="text-4xl">âœ¨</span>
        <span className="font-bold text-2xl tracking-wide" style={{ color: '#FFFFFF' }}>{t('Help Me Connect')}</span>
      </button>

      {/* AI Search Chat Modal */}
      {aiSearchOpen && (
        <>
          <div
            className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50"
            onClick={() => setAiSearchOpen(false)}
          />
          <div className="fixed inset-x-0 bottom-0 bg-white rounded-t-3xl z-50 flex flex-col" style={{ maxHeight: '85vh' }}>
            {/* Header */}
            <div className="sticky top-0 bg-white border-b border-gray-100 px-4 py-4 flex items-center justify-between rounded-t-3xl shrink-0">
              <div>
                <h2 className="font-bold text-gray-900 text-lg">{t('Help Me Connect')}</h2>
                <p className="text-sm text-gray-500"><T>Ask anything about your fellow network</T></p>
              </div>
              <div className="flex items-center gap-2">
                {aiMessages.length > 0 && (
                  <button
                    onClick={() => setAiMessages([])}
                    className="text-xs px-3 py-1.5 rounded-lg bg-gray-100 text-gray-500 hover:bg-gray-200 transition"
                  >
                    {t('New chat')}
                  </button>
                )}
                <button
                  onClick={() => setAiSearchOpen(false)}
                  className="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-gray-100 transition"
                >
                  <svg className="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>

            {/* Messages */}
            <div className="flex-1 overflow-auto p-4 space-y-4" ref={el => { if (el) el.scrollTop = el.scrollHeight; }}>
              {aiMessages.length === 0 ? (
                <div className="text-center py-6">
                  <span className="text-5xl mb-4 block">âœ¨</span>
                  <p className="text-gray-700 font-medium mb-2"><T>Ask me anything about your network</T></p>
                  <p className="text-sm text-gray-400 mb-6"><T>I can search across all 292 fellows by expertise, location, program, and more.</T></p>
                  <div className="space-y-2">
                    {[
                      'Who works on youth violence prevention in Chicago?',
                      'Find fellows who speak Spanish and work in education',
                      'Who are the most recent GGF cohort members?',
                      'Fellows working on climate action in Africa',
                    ].map((suggestion, i) => (
                      <button
                        key={i}
                        onClick={() => sendAiQuery(suggestion)}
                        className="w-full text-left px-4 py-3 rounded-xl bg-gray-50 hover:bg-orange-50 text-sm text-gray-600 hover:text-goldin-orange transition border border-gray-100 hover:border-orange-200"
                      >
                        {t(suggestion)}
                      </button>
                    ))}
                  </div>
                </div>
              ) : (
                aiMessages.map((msg, i) => (
                  <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                    <div className={`max-w-[85%] ${msg.role === 'user'
                      ? 'bg-goldin-orange text-white rounded-2xl rounded-br-md px-4 py-3'
                      : 'bg-gray-100 text-gray-800 rounded-2xl rounded-bl-md px-4 py-3'
                    }`}>
                      {msg.role === 'assistant' ? (
                        <>
                          <div className="text-sm whitespace-pre-wrap">{msg.content}</div>
                          {msg.fellows && msg.fellows.length > 0 && (
                            <div className="mt-3 space-y-2">
                              {msg.fellows.map((match, j) => (
                                <button
                                  key={j}
                                  onClick={() => {
                                    setAiSearchOpen(false);
                                    onSelectFellow(match.fellow);
                                  }}
                                  className="w-full flex items-center gap-3 bg-white rounded-xl p-3 text-left hover:shadow-md transition border border-gray-100"
                                >
                                  {match.fellow.photo_url ? (
                                    <img src={match.fellow.photo_url} className="w-10 h-10 rounded-full object-cover" />
                                  ) : (
                                    <div className="w-10 h-10 rounded-full bg-goldin-orange/20 flex items-center justify-center text-goldin-orange font-bold text-sm">
                                      {match.fellow.first_name?.[0]}{match.fellow.last_name?.[0]}
                                    </div>
                                  )}
                                  <div className="flex-1 min-w-0">
                                    <p className="font-semibold text-gray-900 text-sm truncate">{match.name}</p>
                                    <p className="text-xs text-gray-500 truncate">{match.reason}</p>
                                  </div>
                                  <div className="shrink-0">
                                    <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${
                                      match.fellow.program === 'CPF' ? 'bg-blue-100 text-blue-700' :
                                      match.fellow.program === 'GGF' ? 'bg-orange-100 text-orange-700' :
                                      'bg-red-100 text-red-700'
                                    }`}>{match.fellow.program}</span>
                                  </div>
                                </button>
                              ))}
                            </div>
                          )}
                        </>
                      ) : (
                        <p className="text-sm">{msg.content}</p>
                      )}
                    </div>
                  </div>
                ))
              )}
              {aiLoading && (
                <div className="flex justify-start">
                  <div className="bg-gray-100 rounded-2xl rounded-bl-md px-4 py-3">
                    <div className="flex items-center gap-2">
                      <div className="flex gap-1">
                        <span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></span>
                        <span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></span>
                        <span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></span>
                      </div>
                      <span className="text-xs text-gray-400 ml-1"><T>Searching fellows...</T></span>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* Input */}
            <div className="sticky bottom-0 bg-white border-t border-gray-100 px-4 py-3 shrink-0">
              <form onSubmit={(e) => { e.preventDefault(); sendAiQuery(aiInput); }} className="flex gap-2">
                <input
                  type="text"
                  value={aiInput}
                  onChange={(e) => setAiInput(e.target.value)}
                  placeholder={t('Ask about fellows, skills, locations...')}
                  className="flex-1 px-4 py-3 rounded-xl bg-gray-100 border-none text-sm focus:outline-none focus:ring-2 focus:ring-goldin-orange/50"
                  disabled={aiLoading}
                  autoFocus
                />
                <button
                  type="submit"
                  disabled={!aiInput.trim() || aiLoading}
                  className="px-4 py-3 rounded-xl font-medium text-sm text-white transition disabled:opacity-40"
                  style={{ backgroundColor: '#E87722' }}
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                  </svg>
                </button>
              </form>
            </div>
          </div>
        </>
      )}
    </div>
  );
}

function FellowProfileModal({ fellow, isOpen, onClose, onLogInteraction }) {
  const { user, userRole, canAccess, fetchData, interactions, t } = useContext(AppContext);
  const [activeTab, setActiveTab] = useState('overview');
  const [isEditing, setIsEditing] = useState(false);
  const [editData, setEditData] = useState({});
  const [saving, setSaving] = useState(false);
  const [quickLogType, setQuickLogType] = useState(null);
  const [quickLogNotes, setQuickLogNotes] = useState('');
  const [quickLogSubject, setQuickLogSubject] = useState('');
  const [quickLogSaving, setQuickLogSaving] = useState(false);

  // Lock body scroll when modal is open
  useEffect(() => {
    if (isOpen) {
      document.body.style.overflow = 'hidden';
      return () => { document.body.style.overflow = ''; };
    }
  }, [isOpen]);

  // Reset tab when modal opens for a different fellow
  useEffect(() => {
    if (isOpen) {
      setActiveTab('overview');
      setIsEditing(false);
    }
  }, [isOpen, fellow?.id]);

  // Get fellow's recent interactions (must be before early return to satisfy hooks rules)
  const fellowInteractions = useMemo(() => {
    if (!fellow) return [];
    return (interactions || [])
      .filter(i => i.fellow_id === fellow.id)
      .slice(0, 10);
  }, [interactions, fellow?.id]);

  if (!fellow) return null;

  const status = getContactStatus(fellow.last_contact);
  const badges = getBadges(fellow);

  // Permission checks
  const isStaff = canAccess(ROLES.TEAM);
  const isAdmin = canAccess(ROLES.ADMIN);
  const isSelf = user?.email && fellow.email && user.email.toLowerCase() === fellow.email.toLowerCase();
  const canEdit = isStaff || isSelf;
  const canSeeContactInfo = isStaff || isSelf;
  const canLogInteractions = isStaff;

  const onQuickLog = (type) => {
    setQuickLogType(type);
    setQuickLogSubject('');
    setQuickLogNotes('');
  };

  const saveQuickLog = async () => {
    setQuickLogSaving(true);
    try {
      const interaction = {
        fellow_id: fellow.id,
        interaction_type: quickLogType,
        subject: quickLogSubject || `${quickLogType} with ${fellow.first_name}`,
        notes: quickLogNotes || null,
        staff_email: user?.email || 'unknown@goldininstitute.org',
        created_at: new Date().toISOString(),
      };

      const { error } = await supabase.from('interactions').insert(interaction);

      if (!error) {
        await supabase.from('fellows')
          .update({ last_contact: new Date().toISOString() })
          .eq('id', fellow.id);
        fetchData();
      } else {
        console.error('Error saving quick log:', error);
        alert('Error saving interaction: ' + (error.message || 'Unknown error'));
      }
    } catch (err) {
      console.error('Exception saving quick log:', err);
      alert('Error saving interaction: ' + (err.message || 'Unknown error'));
    }

    setQuickLogSaving(false);
    setQuickLogType(null);
  };

  const startEditing = () => {
    const baseData = {
      first_name: fellow.first_name || '',
      last_name: fellow.last_name || '',
      email: fellow.email || '',
      phone: fellow.phone || '',
      organization: fellow.organization || '',
      job_title: fellow.job_title || '',
      city: fellow.city || '',
      country: fellow.country || '',
      biography: fellow.biography || '',
      linkedin: fellow.linkedin || '',
      twitter: fellow.twitter || '',
      website: fellow.website || '',
      languages: fellow.languages || '',
    };
    // Admin can edit additional fields
    if (isAdmin) {
      baseData.program = fellow.program || '';
      baseData.cohort_year = fellow.cohort_year || fellow.year || '';
      baseData.staff_notes = fellow.staff_notes || '';
      baseData.alternate_emails = (fellow.alternate_emails || []).join(', ');
    }
    setEditData(baseData);
    setIsEditing(true);
  };

  const saveEdits = async () => {
    setSaving(true);
    // Prepare update data
    const updateData = { ...editData };
    // Convert alternate_emails from comma-separated string back to array (admin only)
    if (isAdmin && typeof updateData.alternate_emails === 'string') {
      updateData.alternate_emails = updateData.alternate_emails
        .split(',')
        .map(e => e.trim().toLowerCase())
        .filter(e => e.length > 0);
    }

    const { error } = await supabase
      .from('fellows')
      .update(updateData)
      .eq('id', fellow.id);

    if (!error) {
      setIsEditing(false);
      fetchData(); // Refresh data instead of full reload
    } else {
      alert('Error saving changes: ' + error.message);
    }
    setSaving(false);
  };

  return (
    <>
      {/* Backdrop with blur */}
      <div
        className={`fixed inset-0 bg-black/50 backdrop-blur-sm z-50 transition-opacity ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}
        onClick={onClose}
      />

      {/* Bottom Sheet - 90% height */}
      <div className={`bottom-sheet fixed inset-x-0 bottom-0 bg-white rounded-t-3xl z-50 flex flex-col ${isOpen ? 'open' : ''}`} style={{ height: '90vh' }}>
        {/* Header Section with gray background */}
        <div className="bg-gray-50 rounded-t-3xl flex-shrink-0">
          {/* Handle and Close */}
          <div className="flex items-center justify-between px-4 pt-3 pb-2">
            <div className="w-10"></div>
            <div className="w-10 h-1 bg-gray-300 rounded-full"></div>
            <button onClick={onClose} className="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-gray-200 transition">
              <svg className="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>

          {/* Photo and Basic Info */}
          <div className="px-5 pb-4">
            <div className="flex items-start gap-4">
              <div className="w-24 h-24 rounded-2xl bg-gray-200 overflow-hidden flex-shrink-0 shadow-xl border-4 border-white">
                {fellow.photo_url ? (
                  <img src={fellow.photo_url} alt="" className="w-full h-full object-cover" />
                ) : (
                  <div className="w-full h-full flex items-center justify-center text-gray-400 text-2xl font-bold bg-gradient-to-br from-gray-100 to-gray-200">
                    {fellow.first_name?.[0]}{fellow.last_name?.[0]}
                  </div>
                )}
              </div>
              <div className="flex-1 min-w-0 pt-1">
                <h2 className="text-2xl font-bold text-gray-900">{fellow.first_name} {fellow.last_name}</h2>
                {fellow.job_title && <p style={{ color: '#E87722' }} className="font-semibold"><T>{fellow.job_title}</T></p>}
                <p className="text-gray-600"><T>{fellow.organization || 'No organization'}</T></p>
                <div className="flex items-center gap-2 mt-2 flex-wrap">
                  {/* Multiple badges for staff with fellowships */}
                  {badges.map((badge, idx) => {
                    const bgColor = badge.bg === 'bg-blue-700' ? '#1D4ED8'
                      : badge.bg === 'bg-orange-500' ? '#E87722'
                      : badge.bg === 'bg-orange-700' ? '#C2410C'
                      : badge.bg === 'bg-gray-400' ? '#9CA3AF'
                      : '#6B7280';
                    return (
                      <span key={idx} style={{ backgroundColor: bgColor }} className="text-xs px-2.5 py-1 rounded-lg text-white font-bold">
                        {badge.label}
                      </span>
                    );
                  })}
                  {/* Status dot */}
                  <div className="flex items-center gap-1.5">
                    <div className={`w-2.5 h-2.5 rounded-full ${
                      status.color === 'green' ? 'bg-green-500' :
                      status.color === 'yellow' ? 'bg-yellow-500' : 'bg-red-500'
                    }`}></div>
                    <span className="text-xs text-gray-500 font-medium">{status.label}</span>
                  </div>
                </div>
              </div>
            </div>

            {/* Status Bar - Staff only */}
            {isStaff && (
              <div className={`mt-4 p-3 rounded-xl flex items-center justify-between ${
                status.color === 'green' ? 'bg-green-50 border border-green-200' :
                status.color === 'yellow' ? 'bg-yellow-50 border border-yellow-200' :
                'bg-red-50 border border-red-200'
              }`}>
                <div className="flex items-center gap-2">
                  <div className={`w-2.5 h-2.5 rounded-full ${
                    status.color === 'green' ? 'bg-green-500' :
                    status.color === 'yellow' ? 'bg-yellow-500' : 'bg-red-500'
                  }`}></div>
                  <span className={`text-sm font-medium ${
                    status.color === 'green' ? 'text-green-800' :
                    status.color === 'yellow' ? 'text-yellow-800' : 'text-red-800'
                  }`}>
                    {status.days !== null ? `${t('Last contact')} ${status.days} ${t('days ago')}` : t('No contact recorded')}
                  </span>
                </div>
                {canLogInteractions && (
                  <button
                    onClick={() => { onClose(); onLogInteraction(fellow); }}
                    className="text-xs px-3 py-1.5 bg-white rounded-lg border shadow-sm font-semibold hover:shadow transition"
                  >
                    + Log Interaction
                  </button>
                )}
              </div>
            )}

            {/* Quick Action Buttons - Icon Only */}
            {!isEditing && (
              <div className="mt-4 flex items-center justify-center gap-3">
                {canEdit && (
                  <button
                    onClick={startEditing}
                    title="Edit Profile"
                    className="w-12 h-12 flex items-center justify-center bg-white border border-gray-200 rounded-xl text-gray-600 shadow-sm hover:shadow hover:bg-gray-50 transition"
                  >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                  </button>
                )}

                {canSeeContactInfo && fellow.phone && (
                  <button
                    onClick={() => {
                      window.open(`tel:${fellow.phone}`, '_self');
                      if (canLogInteractions) setTimeout(() => onQuickLog('Call'), 500);
                    }}
                    title="Call"
                    className="w-12 h-12 flex items-center justify-center bg-green-500 rounded-xl text-white shadow-sm hover:bg-green-600 transition"
                  >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                    </svg>
                  </button>
                )}

                {canSeeContactInfo && fellow.phone && (
                  <button
                    onClick={() => {
                      const cleanPhone = fellow.phone.replace(/[^0-9+]/g, '');
                      window.open(`https://wa.me/${cleanPhone}`, '_blank');
                      if (canLogInteractions) setTimeout(() => onQuickLog('WhatsApp'), 500);
                    }}
                    title="WhatsApp"
                    className="w-12 h-12 flex items-center justify-center bg-emerald-500 rounded-xl text-white shadow-sm hover:bg-emerald-600 transition"
                  >
                    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                    </svg>
                  </button>
                )}

                {canSeeContactInfo && fellow.email && (
                  <button
                    onClick={() => {
                      window.open(`mailto:${fellow.email}`, '_self');
                      if (canLogInteractions) setTimeout(() => onQuickLog('Email'), 500);
                    }}
                    title="Email"
                    className="w-12 h-12 flex items-center justify-center bg-blue-500 rounded-xl text-white shadow-sm hover:bg-blue-600 transition"
                  >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                  </button>
                )}

                {canSeeContactInfo && fellow.phone && (
                  <button
                    onClick={() => {
                      const cleanPhone = fellow.phone.replace(/[^0-9+]/g, '');
                      window.open(`sms:${cleanPhone}`, '_self');
                      if (canLogInteractions) setTimeout(() => onQuickLog('Text'), 500);
                    }}
                    title="Text"
                    className="w-12 h-12 flex items-center justify-center bg-purple-500 rounded-xl text-white shadow-sm hover:bg-purple-600 transition"
                  >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                    </svg>
                  </button>
                )}

                {!canSeeContactInfo && (
                  <button
                    onClick={() => alert(`To connect with ${fellow.first_name}, please sign in with a staff account or contact Goldin Institute.`)}
                    title="Connect"
                    style={{ backgroundColor: '#E87722' }}
                    className="w-12 h-12 flex items-center justify-center rounded-xl text-white shadow-sm hover:opacity-90 transition"
                  >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                    </svg>
                  </button>
                )}
              </div>
            )}
          </div>
        </div>

        {/* Tabs - Focus Areas visible to all, Activity/Notes staff only */}
        {!isEditing && (
          <div className="flex border-b border-gray-100 px-5">
            <button
              onClick={() => setActiveTab('overview')}
              className={`flex-1 py-3 text-sm font-semibold transition border-b-2 ${
                activeTab === 'overview' ? 'text-goldin-orange border-goldin-orange' : 'text-gray-500 border-transparent'
              }`}
            >
              {t('Overview')}
            </button>
            <button
              onClick={() => setActiveTab('focus')}
              className={`flex-1 py-3 text-sm font-semibold transition border-b-2 ${
                activeTab === 'focus' ? 'text-goldin-orange border-goldin-orange' : 'text-gray-500 border-transparent'
              }`}
            >
              {t('Focus Areas')}
            </button>
            {isStaff && (
              <>
                <button
                  onClick={() => setActiveTab('activity')}
                  className={`flex-1 py-3 text-sm font-semibold transition border-b-2 relative ${
                    activeTab === 'activity' ? 'text-goldin-orange border-goldin-orange' : 'text-gray-500 border-transparent'
                  }`}
                >
                  {t('Activity')}
                  {fellowInteractions.length > 0 && (
                    <span className="absolute top-2 right-1/4 w-5 h-5 bg-gray-200 text-gray-600 text-xs rounded-full flex items-center justify-center">
                      {fellowInteractions.length}
                    </span>
                  )}
                </button>
                <button
                  onClick={() => setActiveTab('notes')}
                  className={`flex-1 py-3 text-sm font-semibold transition border-b-2 ${
                    activeTab === 'notes' ? 'text-goldin-orange border-goldin-orange' : 'text-gray-500 border-transparent'
                  }`}
                >
                  Notes
                </button>
              </>
            )}
          </div>
        )}
        
        {/* Scrollable Content */}
        <div className="flex-1 overflow-auto">
          <div className="p-5">

            {isEditing ? (
              /* Edit Mode */
              <div className="space-y-4">
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="block text-sm text-gray-500 mb-1">First Name</label>
                    <input type="text" value={editData.first_name} onChange={(e) => setEditData(d => ({ ...d, first_name: e.target.value }))} className="w-full border border-gray-200 rounded-xl px-3 py-2 focus:outline-none focus:border-goldin-orange" />
                  </div>
                  <div>
                    <label className="block text-sm text-gray-500 mb-1">Last Name</label>
                    <input type="text" value={editData.last_name} onChange={(e) => setEditData(d => ({ ...d, last_name: e.target.value }))} className="w-full border border-gray-200 rounded-xl px-3 py-2 focus:outline-none focus:border-goldin-orange" />
                  </div>
                </div>
                <div>
                  <label className="block text-sm text-gray-500 mb-1">Title / Role</label>
                  <input type="text" value={editData.job_title} onChange={(e) => setEditData(d => ({ ...d, job_title: e.target.value }))} className="w-full border border-gray-200 rounded-xl px-3 py-2 focus:outline-none focus:border-goldin-orange" />
                </div>
                <div>
                  <label className="block text-sm text-gray-500 mb-1">Organization</label>
                  <input type="text" value={editData.organization} onChange={(e) => setEditData(d => ({ ...d, organization: e.target.value }))} className="w-full border border-gray-200 rounded-xl px-3 py-2 focus:outline-none focus:border-goldin-orange" />
                </div>
                <div>
                  <label className="block text-sm text-gray-500 mb-1">Email</label>
                  <input type="email" value={editData.email} onChange={(e) => setEditData(d => ({ ...d, email: e.target.value }))} className="w-full border border-gray-200 rounded-xl px-3 py-2 focus:outline-none focus:border-goldin-orange" />
                </div>
                <div>
                  <label className="block text-sm text-gray-500 mb-1">Phone</label>
                  <input type="tel" value={editData.phone} onChange={(e) => setEditData(d => ({ ...d, phone: e.target.value }))} className="w-full border border-gray-200 rounded-xl px-3 py-2 focus:outline-none focus:border-goldin-orange" />
                </div>
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="block text-sm text-gray-500 mb-1">City</label>
                    <input type="text" value={editData.city} onChange={(e) => setEditData(d => ({ ...d, city: e.target.value }))} className="w-full border border-gray-200 rounded-xl px-3 py-2 focus:outline-none focus:border-goldin-orange" />
                  </div>
                  <div>
                    <label className="block text-sm text-gray-500 mb-1">Country</label>
                    <input type="text" value={editData.country} onChange={(e) => setEditData(d => ({ ...d, country: e.target.value }))} className="w-full border border-gray-200 rounded-xl px-3 py-2 focus:outline-none focus:border-goldin-orange" />
                  </div>
                </div>
                <div>
                  <label className="block text-sm text-gray-500 mb-1">Bio</label>
                  <textarea value={editData.biography} onChange={(e) => setEditData(d => ({ ...d, biography: e.target.value }))} rows={4} className="w-full border border-gray-200 rounded-xl px-3 py-2 focus:outline-none focus:border-goldin-orange resize-none" />
                </div>
                <div>
                  <label className="block text-sm text-gray-500 mb-1">LinkedIn URL</label>
                  <input type="url" value={editData.linkedin} onChange={(e) => setEditData(d => ({ ...d, linkedin: e.target.value }))} className="w-full border border-gray-200 rounded-xl px-3 py-2 focus:outline-none focus:border-goldin-orange" />
                </div>
                <div>
                  <label className="block text-sm text-gray-500 mb-1">Twitter URL</label>
                  <input type="url" value={editData.twitter} onChange={(e) => setEditData(d => ({ ...d, twitter: e.target.value }))} className="w-full border border-gray-200 rounded-xl px-3 py-2 focus:outline-none focus:border-goldin-orange" />
                </div>
                <div>
                  <label className="block text-sm text-gray-500 mb-1">Website URL</label>
                  <input type="url" value={editData.website} onChange={(e) => setEditData(d => ({ ...d, website: e.target.value }))} className="w-full border border-gray-200 rounded-xl px-3 py-2 focus:outline-none focus:border-goldin-orange" />
                </div>
                <div>
                  <label className="block text-sm text-gray-500 mb-1">Languages (comma separated)</label>
                  <input type="text" value={editData.languages} onChange={(e) => setEditData(d => ({ ...d, languages: e.target.value }))} placeholder="English, Spanish, French" className="w-full border border-gray-200 rounded-xl px-3 py-2 focus:outline-none focus:border-goldin-orange" />
                </div>

                {/* Admin-only fields */}
                {isAdmin && (
                  <>
                    <div className="pt-4 border-t border-gray-200">
                      <p className="text-xs font-semibold text-violet-600 uppercase tracking-wide mb-3">Admin Only</p>
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                      <div>
                        <label className="block text-sm text-gray-500 mb-1">Program</label>
                        <select
                          value={editData.program}
                          onChange={(e) => setEditData(d => ({ ...d, program: e.target.value }))}
                          className="w-full border border-gray-200 rounded-xl px-3 py-2 focus:outline-none focus:border-goldin-orange bg-white"
                        >
                          <option value="">Select...</option>
                          <option value="CPF">CPF - Chicago Peace Fellows</option>
                          <option value="GGF">GGF - Global Grassroots Fellows</option>
                          <option value="ESP">ESP - Spanish Program</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm text-gray-500 mb-1">Cohort Year</label>
                        <input type="text" value={editData.cohort_year} onChange={(e) => setEditData(d => ({ ...d, cohort_year: e.target.value }))} placeholder="2024" className="w-full border border-gray-200 rounded-xl px-3 py-2 focus:outline-none focus:border-goldin-orange" />
                      </div>
                    </div>
                    <div>
                      <label className="block text-sm text-gray-500 mb-1">Alternate Emails (comma separated)</label>
                      <input type="text" value={editData.alternate_emails} onChange={(e) => setEditData(d => ({ ...d, alternate_emails: e.target.value }))} placeholder="other@email.com, work@company.org" className="w-full border border-gray-200 rounded-xl px-3 py-2 focus:outline-none focus:border-goldin-orange" />
                      <p className="text-xs text-gray-400 mt-1">These emails can also be used to log in</p>
                    </div>
                    <div>
                      <label className="block text-sm text-gray-500 mb-1">Staff Notes (not visible to fellow)</label>
                      <textarea value={editData.staff_notes} onChange={(e) => setEditData(d => ({ ...d, staff_notes: e.target.value }))} rows={3} placeholder="Internal notes about this fellow..." className="w-full border border-gray-200 rounded-xl px-3 py-2 focus:outline-none focus:border-violet-500 bg-violet-50/50 resize-none" />
                    </div>
                  </>
                )}

                <div className="flex gap-3 pt-4 pb-8">
                  <button onClick={() => setIsEditing(false)} className="flex-1 py-3 border border-gray-200 rounded-xl font-medium text-gray-600">Cancel</button>
                  <button onClick={saveEdits} disabled={saving} className="flex-1 py-3 bg-goldin-orange text-white rounded-xl font-semibold disabled:opacity-50">{saving ? 'Saving...' : 'Save Changes'}</button>
                </div>
              </div>
            ) : (
              <>
                {/* OVERVIEW TAB */}
                {activeTab === 'overview' && (
                  <>
                    {/* Bio - shown first if exists */}
                    {fellow.biography && (
                      <div className="mb-6">
                        <h3 className="text-sm font-semibold text-gray-400 uppercase tracking-wide mb-3">{t('About')}</h3>
                        <p className="text-gray-700 leading-relaxed whitespace-pre-line"><T>{fellow.biography}</T></p>
                      </div>
                    )}

                    {/* Staff Notes - Admin only */}
                    {isAdmin && fellow.staff_notes && (
                      <div className="mb-6 p-4 bg-violet-50 rounded-xl border border-violet-200">
                        <h3 className="text-xs font-semibold text-violet-600 uppercase tracking-wide mb-2">Staff Notes</h3>
                        <p className="text-gray-700 text-sm whitespace-pre-line">{fellow.staff_notes}</p>
                      </div>
                    )}

                    {/* Contact Details */}
                    <div className="space-y-3 mb-6">
                      <h3 className="text-sm font-semibold text-gray-400 uppercase tracking-wide">Contact</h3>

                      {canSeeContactInfo && fellow.email && (
                        <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
                          <div className="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                            <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                          </div>
                          <div className="flex-1 min-w-0">
                            <p className="text-xs text-gray-500">Email</p>
                            <p className="text-gray-900 truncate font-medium">{fellow.email}</p>
                          </div>
                        </div>
                      )}

                      {canSeeContactInfo && fellow.phone && (
                        <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
                          <div className="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                            <svg className="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                            </svg>
                          </div>
                          <div className="flex-1">
                            <p className="text-xs text-gray-500">Phone</p>
                            <p className="text-gray-900 font-medium">{fellow.phone}</p>
                          </div>
                        </div>
                      )}

                      {!canSeeContactInfo && (
                        <div className="flex items-center gap-3 p-4 bg-gray-100 rounded-xl">
                          <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center">
                            <svg className="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                            </svg>
                          </div>
                          <div className="flex-1">
                            <p className="text-sm text-gray-600 font-medium">Contact info is private</p>
                            <p className="text-xs text-gray-400">Sign in with a staff account to view</p>
                          </div>
                        </div>
                      )}

                      {(fellow.city || fellow.country) && (
                        <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
                          <div className="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center">
                            <svg className="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                          </div>
                          <div className="flex-1">
                            <p className="text-xs text-gray-500">{t('Location')}</p>
                            <p className="text-gray-900 font-medium"><T>{[fellow.city, fellow.country].filter(Boolean).join(', ')}</T></p>
                          </div>
                        </div>
                      )}

                      {fellow.languages && (
                        <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
                          <div className="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center">
                            <svg className="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
                            </svg>
                          </div>
                          <div className="flex-1">
                            <p className="text-xs text-gray-500">Languages</p>
                            <p className="text-gray-900 font-medium">{fellow.languages}</p>
                          </div>
                        </div>
                      )}
                    </div>

                    {/* Social Links */}
                    {(fellow.linkedin || fellow.twitter || fellow.website || fellow.instagram || fellow.facebook) && (
                      <div className="space-y-3 mb-6">
                        <h3 className="text-sm font-semibold text-gray-400 uppercase tracking-wide">Social & Web</h3>
                        <div className="flex flex-wrap gap-2">
                          {fellow.linkedin && (
                            <a href={fellow.linkedin.startsWith('http') ? fellow.linkedin : `https://${fellow.linkedin}`} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-2 px-4 py-2 bg-[#0077b5] text-white rounded-xl font-medium text-sm">
                              <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                              LinkedIn
                            </a>
                          )}
                          {fellow.twitter && (
                            <a href={fellow.twitter.startsWith('http') ? fellow.twitter : `https://${fellow.twitter}`} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-2 px-4 py-2 bg-black text-white rounded-xl font-medium text-sm">
                              <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                              X / Twitter
                            </a>
                          )}
                          {fellow.instagram && (
                            <a href={fellow.instagram.startsWith('http') ? fellow.instagram : `https://instagram.com/${fellow.instagram}`} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-medium text-sm">
                              <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
                              Instagram
                            </a>
                          )}
                          {fellow.facebook && (
                            <a href={fellow.facebook.startsWith('http') ? fellow.facebook : `https://facebook.com/${fellow.facebook}`} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-2 px-4 py-2 bg-[#1877f2] text-white rounded-xl font-medium text-sm">
                              <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                              Facebook
                            </a>
                          )}
                          {fellow.website && (
                            <a href={fellow.website.startsWith('http') ? fellow.website : `https://${fellow.website}`} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-2 px-4 py-2 bg-gray-700 text-white rounded-xl font-medium text-sm">
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" /></svg>
                              Website
                            </a>
                          )}
                        </div>
                      </div>
                    )}

                    {/* Program Details */}
                    <div className="space-y-3 mb-6">
                      <h3 className="text-sm font-semibold text-gray-400 uppercase tracking-wide">Program Details</h3>
                      <div className="grid grid-cols-2 gap-3">
                        {fellow.program && (
                          <div className="bg-gray-50 rounded-xl p-3">
                            <p className="text-xs text-gray-500">Program</p>
                            <p className="text-gray-900 font-semibold">{fellow.program}</p>
                          </div>
                        )}
                        {(fellow.cohort_year || fellow.year || fellow.cohort) && (
                          <div className="bg-gray-50 rounded-xl p-3">
                            <p className="text-xs text-gray-500">Year / Cohort</p>
                            <p className="text-gray-900 font-semibold">{fellow.cohort_year || fellow.year || fellow.cohort}</p>
                          </div>
                        )}
                        {fellow.focus_area && (
                          <div className="bg-gray-50 rounded-xl p-3 col-span-2">
                            <p className="text-xs text-gray-500">Focus Area</p>
                            <p className="text-gray-900 font-semibold">{fellow.focus_area}</p>
                          </div>
                        )}
                        {fellow.community_area && (
                          <div className="bg-gray-50 rounded-xl p-3 col-span-2">
                            <p className="text-xs text-gray-500">Chicago Community Area</p>
                            <p className="text-gray-900 font-semibold">{fellow.community_area}</p>
                          </div>
                        )}
                      </div>
                    </div>
                  </>
                )}

                {/* FOCUS AREAS TAB */}
                {activeTab === 'focus' && (
                  <FocusAreasEditor
                    fellow={fellow}
                    onUpdate={() => fetchData()}
                  />
                )}

                {/* ACTIVITY TAB - Staff only */}
                {activeTab === 'activity' && isStaff && (
                  <div className="space-y-3">
                    {fellowInteractions.length > 0 ? (
                      fellowInteractions.map((activity, idx) => {
                        const icon = getInteractionIcon(activity.interaction_type);
                        const time = getTimeAgo(activity.created_at);
                        const staffName = activity.staff_email?.split('@')[0].split('.').map(n => n.charAt(0).toUpperCase() + n.slice(1)).join(' ') || 'Staff';
                        return (
                          <div key={activity.id || idx} className="bg-gray-50 rounded-xl p-4">
                            <div className="flex items-start gap-3">
                              <div className="w-10 h-10 rounded-full bg-white border border-gray-200 flex items-center justify-center text-lg">
                                {icon}
                              </div>
                              <div className="flex-1 min-w-0">
                                <div className="flex items-center justify-between gap-2">
                                  <p className="font-semibold text-gray-900"><T>{activity.interaction_type}</T></p>
                                  <span className="text-xs text-gray-400">{time}</span>
                                </div>
                                <p className="text-sm text-gray-500">{staffName}</p>
                                {activity.subject && (
                                  <p className="text-sm text-gray-700 mt-1 font-medium"><T>{activity.subject}</T></p>
                                )}
                                {activity.notes && (
                                  <p className="text-sm text-gray-600 mt-1"><T>{activity.notes}</T></p>
                                )}
                              </div>
                            </div>
                          </div>
                        );
                      })
                    ) : (
                      <div className="text-center py-12">
                        <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                          <svg className="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                          </svg>
                        </div>
                        <p className="text-gray-500 font-medium">No activity recorded yet</p>
                        <p className="text-gray-400 text-sm mt-1">Log an interaction to get started</p>
                        <button
                          onClick={() => { onClose(); onLogInteraction(fellow); }}
                          className="mt-4 px-6 py-2 bg-goldin-orange text-white rounded-xl font-medium"
                        >
                          + Log Interaction
                        </button>
                      </div>
                    )}
                  </div>
                )}

                {/* NOTES TAB - Staff only */}
                {activeTab === 'notes' && isStaff && (
                  <div className="space-y-4">
                    <div className="bg-amber-50 border border-amber-200 rounded-xl p-4">
                      <div className="flex items-start gap-3">
                        <svg className="w-5 h-5 text-amber-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div>
                          <p className="text-amber-800 font-medium text-sm">Staff Notes Coming Soon</p>
                          <p className="text-amber-700 text-sm mt-1">Private notes will be stored in a separate table and only visible to staff members.</p>
                        </div>
                      </div>
                    </div>

                    {fellow.notes && (
                      <div className="bg-gray-50 rounded-xl p-4">
                        <h4 className="text-sm font-semibold text-gray-700 mb-2">Legacy Notes</h4>
                        <p className="text-gray-600 text-sm whitespace-pre-line">{fellow.notes}</p>
                      </div>
                    )}

                    {!fellow.notes && (
                      <div className="text-center py-8">
                        <p className="text-gray-400">No notes for this fellow</p>
                      </div>
                    )}
                  </div>
                )}
              </>
            )}
          </div>
        </div>
      </div>
      
      {/* Quick Log Modal */}
      {quickLogType && (
        <div className="fixed inset-0 bg-black/60 z-[60] flex items-end justify-center" onClick={() => setQuickLogType(null)}>
          <div 
            className="bg-white rounded-t-3xl w-full max-w-lg p-6 pb-8"
            onClick={e => e.stopPropagation()}
            style={{ paddingBottom: 'max(32px, env(safe-area-inset-bottom))' }}
          >
            <div className="flex justify-center mb-4">
              <div className="w-10 h-1 bg-gray-300 rounded-full"></div>
            </div>
            
            <h3 className="text-xl font-bold text-gray-900 mb-1">Log {quickLogType}</h3>
            <p className="text-gray-500 mb-4">Add notes about your {quickLogType.toLowerCase()} with {fellow.first_name}</p>
            
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Subject (optional)</label>
                <input
                  type="text"
                  value={quickLogSubject}
                  onChange={(e) => setQuickLogSubject(e.target.value)}
                  placeholder={`${quickLogType} with ${fellow.first_name}`}
                  className="w-full border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-goldin-orange"
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Notes (optional)</label>
                <textarea
                  value={quickLogNotes}
                  onChange={(e) => setQuickLogNotes(e.target.value)}
                  placeholder="What did you discuss?"
                  rows={3}
                  className="w-full border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-goldin-orange resize-none"
                />
              </div>
              
              <div className="flex gap-3 pt-2">
                <button
                  onClick={() => setQuickLogType(null)}
                  className="flex-1 py-3 border border-gray-200 rounded-xl font-medium text-gray-600"
                >
                  Cancel
                </button>
                <button
                  onClick={saveQuickLog}
                  disabled={quickLogSaving}
                  className="flex-1 py-3 bg-goldin-orange text-white rounded-xl font-semibold disabled:opacity-50"
                >
                  {quickLogSaving ? 'Saving...' : 'Save'}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </>
  );
}

// ============================================
// FILTER/SORT PANEL FOR DIRECTORY
// ============================================
const SORT_OPTIONS = [
  { value: 'days_desc', label: 'Days since contact (high to low)', icon: 'ðŸ“…' },
  { value: 'days_asc', label: 'Days since contact (low to high)', icon: 'ðŸ“…' },
  { value: 'name_asc', label: 'Name (A-Z)', icon: 'ðŸ”¤' },
  { value: 'name_desc', label: 'Name (Z-A)', icon: 'ðŸ”¤' },
  { value: 'year_desc', label: 'Year (newest first)', icon: 'ðŸ“†' },
  { value: 'year_asc', label: 'Year (oldest first)', icon: 'ðŸ“†' },
  { value: 'status_desc', label: 'Status (Red â†’ Yellow â†’ Green)', icon: 'ðŸš¦' },
  { value: 'status_asc', label: 'Status (Green â†’ Yellow â†’ Red)', icon: 'ðŸš¦' },
];

const PROGRAM_OPTIONS = [
  { value: 'CPF', label: 'CPF', color: 'bg-blue-700' },        // Chicago - Dark Blue
  { value: 'GGF', label: 'GGF', color: 'bg-orange-500' },      // Global English - Bright Orange
  { value: 'ESP', label: 'ESP', color: 'bg-orange-700' },      // Global Spanish - Dark Orange
];

const REGION_OPTIONS = [
  { value: 'Africa', label: 'Africa' },
  { value: 'Asia', label: 'Asia' },
  { value: 'Latin America', label: 'Latin America' },
  { value: 'Europe', label: 'Europe' },
  { value: 'Middle East', label: 'Middle East' },
  { value: 'North America', label: 'North America' },
];

// Generate year options from 2010 to current year
const currentYear = new Date().getFullYear();
const YEAR_OPTIONS = Array.from({ length: currentYear - 2009 }, (_, i) => ({
  value: String(currentYear - i),
  label: String(currentYear - i),
}));

function FilterSortPanel({ isOpen, onClose, filters, setFilters, sort, setSort }) {
  const [activeTab, setActiveTab] = useState('sort');

  const activeFilterCount = useMemo(() => {
    let count = 0;
    if (filters.programs.length > 0) count += filters.programs.length;
    if (filters.regions.length > 0) count += filters.regions.length;
    if (filters.years.length > 0) count += filters.years.length;
    if (filters.statuses.length > 0) count += filters.statuses.length;
    return count;
  }, [filters]);

  const toggleArrayFilter = (key, value) => {
    setFilters(prev => ({
      ...prev,
      [key]: prev[key].includes(value)
        ? prev[key].filter(v => v !== value)
        : [...prev[key], value]
    }));
  };

  const clearFilters = () => {
    setFilters({
      programs: [],
      regions: [],
      years: [],
      statuses: [],
    });
  };

  return (
    <>
      {/* Backdrop */}
      <div
        className={`fixed inset-0 bg-black/40 z-50 transition-opacity ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}
        onClick={onClose}
      />

      {/* Panel */}
      <div className={`bottom-sheet fixed inset-x-0 bottom-0 bg-white rounded-t-3xl z-50 ${isOpen ? 'open' : ''}`} style={{ maxHeight: '80vh' }}>
        {/* Handle */}
        <div className="flex justify-center pt-3 pb-2">
          <div className="w-10 h-1 bg-gray-300 rounded-full"></div>
        </div>

        {/* Header */}
        <div className="flex items-center justify-between px-5 pb-3 border-b border-gray-100">
          <h2 className="text-lg font-bold text-gray-900">Sort & Filter</h2>
          <div className="flex items-center gap-2">
            {activeFilterCount > 0 && (
              <button onClick={clearFilters} className="text-sm text-goldin-orange font-medium">
                Clear all
              </button>
            )}
            <button onClick={onClose} className="p-2 text-2xl text-gray-400">&times;</button>
          </div>
        </div>

        {/* Tabs */}
        <div className="flex border-b border-gray-100">
          <button
            onClick={() => setActiveTab('sort')}
            className={`flex-1 py-3 text-sm font-semibold transition ${
              activeTab === 'sort' ? 'text-goldin-orange border-b-2 border-goldin-orange' : 'text-gray-500'
            }`}
          >
            Sort
          </button>
          <button
            onClick={() => setActiveTab('filter')}
            className={`flex-1 py-3 text-sm font-semibold transition relative ${
              activeTab === 'filter' ? 'text-goldin-orange border-b-2 border-goldin-orange' : 'text-gray-500'
            }`}
          >
            Filter
            {activeFilterCount > 0 && (
              <span className="absolute top-2 right-1/4 w-5 h-5 bg-goldin-orange text-white text-xs rounded-full flex items-center justify-center">
                {activeFilterCount}
              </span>
            )}
          </button>
        </div>

        {/* Content */}
        <div className="p-4 overflow-auto" style={{ maxHeight: 'calc(80vh - 140px)' }}>
          {activeTab === 'sort' ? (
            <div className="space-y-2">
              {SORT_OPTIONS.map(option => (
                <button
                  key={option.value}
                  onClick={() => { setSort(option.value); onClose(); }}
                  className={`w-full flex items-center gap-3 p-3 rounded-xl transition ${
                    sort === option.value
                      ? 'bg-goldin-orange/10 border-2 border-goldin-orange'
                      : 'bg-gray-50 border-2 border-transparent'
                  }`}
                >
                  <span className="text-lg">{option.icon}</span>
                  <span className={`flex-1 text-left ${sort === option.value ? 'text-goldin-orange font-semibold' : 'text-gray-700'}`}>
                    {option.label}
                  </span>
                  {sort === option.value && (
                    <svg className="w-5 h-5 text-goldin-orange" fill="currentColor" viewBox="0 0 20 20">
                      <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                    </svg>
                  )}
                </button>
              ))}
            </div>
          ) : (
            <div className="space-y-6">
              {/* Program Filter */}
              <div>
                <h3 className="text-sm font-semibold text-gray-700 mb-2">Program</h3>
                <div className="flex flex-wrap gap-2">
                  {PROGRAM_OPTIONS.map(option => (
                    <button
                      key={option.value}
                      onClick={() => toggleArrayFilter('programs', option.value)}
                      className={`px-4 py-2 rounded-full text-sm font-medium transition ${
                        filters.programs.includes(option.value)
                          ? `${option.color} text-white`
                          : 'bg-gray-100 text-gray-700'
                      }`}
                    >
                      {option.label}
                    </button>
                  ))}
                </div>
              </div>

              {/* Region Filter (for GGF/ESP) */}
              <div>
                <h3 className="text-sm font-semibold text-gray-700 mb-2">Region</h3>
                <div className="flex flex-wrap gap-2">
                  {REGION_OPTIONS.map(option => (
                    <button
                      key={option.value}
                      onClick={() => toggleArrayFilter('regions', option.value)}
                      className={`px-3 py-1.5 rounded-full text-sm font-medium transition ${
                        filters.regions.includes(option.value)
                          ? 'bg-goldin-orange text-white'
                          : 'bg-gray-100 text-gray-700'
                      }`}
                    >
                      {option.label}
                    </button>
                  ))}
                </div>
              </div>

              {/* Year Filter */}
              <div>
                <h3 className="text-sm font-semibold text-gray-700 mb-2">Year</h3>
                <div className="flex flex-wrap gap-2 max-h-32 overflow-auto">
                  {YEAR_OPTIONS.map(option => (
                    <button
                      key={option.value}
                      onClick={() => toggleArrayFilter('years', option.value)}
                      className={`px-3 py-1.5 rounded-full text-sm font-medium transition ${
                        filters.years.includes(option.value)
                          ? 'bg-goldin-orange text-white'
                          : 'bg-gray-100 text-gray-700'
                      }`}
                    >
                      {option.label}
                    </button>
                  ))}
                </div>
              </div>

              {/* Status Filter */}
              <div>
                <h3 className="text-sm font-semibold text-gray-700 mb-2">Status</h3>
                <div className="flex flex-wrap gap-2">
                  {[
                    { value: 'green', label: 'Recent', color: 'bg-green-500' },
                    { value: 'yellow', label: 'Follow-up', color: 'bg-yellow-500' },
                    { value: 'red', label: 'Overdue', color: 'bg-red-500' },
                  ].map(option => (
                    <button
                      key={option.value}
                      onClick={() => toggleArrayFilter('statuses', option.value)}
                      className={`px-4 py-2 rounded-full text-sm font-medium transition flex items-center gap-2 ${
                        filters.statuses.includes(option.value)
                          ? `${option.color} text-white`
                          : 'bg-gray-100 text-gray-700'
                      }`}
                    >
                      <span className={`w-2 h-2 rounded-full ${filters.statuses.includes(option.value) ? 'bg-white' : option.color}`}></span>
                      {option.label}
                    </button>
                  ))}
                </div>
              </div>
            </div>
          )}
        </div>

        {/* Apply Button (filter tab only) */}
        {activeTab === 'filter' && (
          <div className="p-4 border-t border-gray-100 safe-bottom">
            <button
              onClick={onClose}
              className="w-full py-4 bg-goldin-orange text-white font-bold rounded-2xl active:scale-98 transition"
            >
              Apply Filters {activeFilterCount > 0 && `(${activeFilterCount})`}
            </button>
          </div>
        )}
      </div>
    </>
  );
}

function DirectoryPage({ onSelectFellow }) {
  const { fellows, teamMembers, userRole, canAccess, t } = useContext(AppContext);
  const [search, setSearch] = useState('');
  const [filterPanelOpen, setFilterPanelOpen] = useState(false);
  const [sort, setSort] = useState('name_asc'); // Default: alphabetical for combined directory
  const [aiSearchOpen, setAiSearchOpen] = useState(false);
  const [aiMessages, setAiMessages] = useState([]);
  const [aiInput, setAiInput] = useState('');
  const [aiLoading, setAiLoading] = useState(false);

  const sendAiQuery = async (query) => {
    if (!query.trim() || aiLoading) return;
    const userMsg = { role: 'user', content: query };
    setAiMessages(prev => [...prev, userMsg]);
    setAiInput('');
    setAiLoading(true);
    try {
      const session = await supabase.auth.getSession();
      const response = await fetch(`${SUPABASE_URL}/functions/v1/ai-search`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': session?.data?.session?.access_token
            ? `Bearer ${session.data.session.access_token}`
            : `Bearer ${SUPABASE_ANON_KEY}`,
        },
        body: JSON.stringify({ query, conversation: aiMessages.slice(-6) }),
      });
      const data = await response.json();
      if (!response.ok) throw new Error(data.error || 'AI search failed');
      const matchedFellows = (data.fellows || []).map(match => {
        const fellow = fellows.find(f => f.id === match.id);
        return fellow ? { ...match, fellow } : match;
      }).filter(m => m.fellow);
      setAiMessages(prev => [...prev, { role: 'assistant', content: data.message, fellows: matchedFellows }]);
    } catch (err) {
      console.error('AI search error:', err);
      setAiMessages(prev => [...prev, { role: 'assistant', content: 'Sorry, I had trouble searching. Please try again.', fellows: [] }]);
    } finally {
      setAiLoading(false);
    }
  };

  const [filters, setFilters] = useState({
    programs: [],
    regions: [],
    years: [],
    statuses: [],
  });

  // Combine fellows and team members into a unified directory
  const allMembers = useMemo(() => {
    // Map team members to match fellow structure for display
    const teamMapped = (teamMembers || []).map(tm => ({
      id: tm.id,
      first_name: tm.first_name,
      last_name: tm.last_name,
      program: 'TEAM',
      cohort_year: null,
      organization: tm.title || 'Goldin Institute',
      photo_url: tm.photo_url,
      bio: tm.bio,
      email: tm.email,
      phone: tm.phone,
      city: null,
      country: null,
      region: null,
      last_contact: null,
      record_type: 'team_member',
      role: tm.role,
      fellowships: tm.fellowships || [], // Include fellowships for multi-badge support
    }));

    // Map fellows with record_type
    const fellowsMapped = (fellows || []).map(f => ({
      ...f,
      record_type: 'fellow',
    }));

    return [...teamMapped, ...fellowsMapped];
  }, [fellows, teamMembers]);

  // Count active filters for badge
  const activeFilterCount = useMemo(() => {
    let count = 0;
    if (filters.programs.length > 0) count += filters.programs.length;
    if (filters.regions.length > 0) count += filters.regions.length;
    if (filters.years.length > 0) count += filters.years.length;
    if (filters.statuses.length > 0) count += filters.statuses.length;
    return count;
  }, [filters]);

  const statusCounts = useMemo(() => {
    const counts = { green: 0, yellow: 0, red: 0 };
    fellows.forEach(f => {
      counts[getContactStatus(f.last_contact).color]++;
    });
    return counts;
  }, [fellows]);

  // Filter and sort all members (fellows + team)
  const filtered = useMemo(() => {
    let result = allMembers.filter(f => {
      // Search filter
      const term = search.toLowerCase();
      const matchSearch = !search ||
        `${f.first_name} ${f.last_name}`.toLowerCase().includes(term) ||
        f.organization?.toLowerCase().includes(term) ||
        f.city?.toLowerCase().includes(term) ||
        f.country?.toLowerCase().includes(term) ||
        f.email?.toLowerCase().includes(term);

      // Program filter - now includes TEAM
      const programLabel = getProgramBadge(f.program).label;
      const matchProgram = filters.programs.length === 0 ||
        filters.programs.includes(programLabel);

      // Region filter (team members have no region, so skip if filtering by region)
      const matchRegion = filters.regions.length === 0 ||
        filters.regions.includes(f.region);

      // Year filter (team members have no year)
      const matchYear = filters.years.length === 0 ||
        filters.years.includes(String(f.cohort_year || f.year));

      // Status filter (team members have no status tracking)
      const memberStatus = f.record_type === 'team_member' ? null : getContactStatus(f.last_contact).color;
      const matchStatus = filters.statuses.length === 0 ||
        (f.record_type === 'team_member') || // Team members pass status filter
        filters.statuses.includes(memberStatus);

      return matchSearch && matchProgram && matchRegion && matchYear && matchStatus;
    });

    // Sort
    result.sort((a, b) => {
      switch (sort) {
        case 'days_desc': {
          const aDays = a.last_contact ? Math.floor((Date.now() - new Date(a.last_contact)) / (1000*60*60*24)) : 9999;
          const bDays = b.last_contact ? Math.floor((Date.now() - new Date(b.last_contact)) / (1000*60*60*24)) : 9999;
          return bDays - aDays;
        }
        case 'days_asc': {
          const aDays = a.last_contact ? Math.floor((Date.now() - new Date(a.last_contact)) / (1000*60*60*24)) : 9999;
          const bDays = b.last_contact ? Math.floor((Date.now() - new Date(b.last_contact)) / (1000*60*60*24)) : 9999;
          return aDays - bDays;
        }
        case 'name_asc':
          return `${a.last_name} ${a.first_name}`.localeCompare(`${b.last_name} ${b.first_name}`);
        case 'name_desc':
          return `${b.last_name} ${b.first_name}`.localeCompare(`${a.last_name} ${a.first_name}`);
        case 'year_desc':
          return (b.cohort_year || b.year || 0) - (a.cohort_year || a.year || 0);
        case 'year_asc':
          return (a.cohort_year || a.year || 0) - (b.cohort_year || b.year || 0);
        case 'status_desc': {
          const statusOrder = { red: 0, yellow: 1, green: 2 };
          return statusOrder[getContactStatus(a.last_contact).color] - statusOrder[getContactStatus(b.last_contact).color];
        }
        case 'status_asc': {
          const statusOrder = { green: 0, yellow: 1, red: 2 };
          return statusOrder[getContactStatus(a.last_contact).color] - statusOrder[getContactStatus(b.last_contact).color];
        }
        default:
          return 0;
      }
    });

    return result;
  }, [fellows, search, filters, sort]);

  // Check if user can see status info (staff only)
  const canSeeStatus = canAccess(ROLES.TEAM);

  return (
    <div className="p-4 pb-24">
      {/* Search + Filter Button */}
      <div className="flex gap-2 mb-4">
        <div className="flex-1 relative">
          <svg className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input
            type="text"
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            placeholder="Search directory..."
            className="w-full pl-12 pr-4 py-3 bg-gray-100 rounded-2xl text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-goldin-orange/30"
          />
        </div>
        <button
          onClick={() => setFilterPanelOpen(true)}
          className="relative w-12 h-12 bg-gray-100 rounded-2xl flex items-center justify-center hover:bg-gray-200 transition"
        >
          <svg className="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
          </svg>
          {activeFilterCount > 0 && (
            <span className="absolute -top-1 -right-1 w-5 h-5 bg-goldin-orange text-white text-xs font-bold rounded-full flex items-center justify-center">
              {activeFilterCount}
            </span>
          )}
        </button>
      </div>

      {/* Active filters summary */}
      {activeFilterCount > 0 && (
        <div className="flex flex-wrap gap-1.5 mb-3">
          {filters.programs.map(p => (
            <span key={p} className="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded-full">{p}</span>
          ))}
          {filters.regions.map(r => (
            <span key={r} className="text-xs px-2 py-1 bg-purple-100 text-purple-700 rounded-full">{r}</span>
          ))}
          {filters.years.map(y => (
            <span key={y} className="text-xs px-2 py-1 bg-gray-200 text-gray-700 rounded-full">{y}</span>
          ))}
          {filters.statuses.map(s => (
            <span key={s} className={`text-xs px-2 py-1 rounded-full ${
              s === 'green' ? 'bg-green-100 text-green-700' :
              s === 'yellow' ? 'bg-yellow-100 text-yellow-700' :
              'bg-red-100 text-red-700'
            }`}>{s === 'green' ? t('Recent') : s === 'yellow' ? t('Follow-up') : t('Overdue')}</span>
          ))}
          <button
            onClick={() => setFilters({ programs: [], regions: [], years: [], statuses: [] })}
            className="text-xs px-2 py-1 text-goldin-orange font-medium"
          >
            Clear
          </button>
        </div>
      )}

      {/* Count + Sort indicator */}
      <div className="flex items-center justify-between mb-3">
        <p className="text-sm text-gray-500">{filtered.length} {filtered.length === 1 ? 'member' : 'members'}</p>
        <p className="text-xs text-gray-400">
          Sorted by: {SORT_OPTIONS.find(o => o.value === sort)?.label.split(' (')[0]}
        </p>
      </div>

      {/* List */}
      <div className="space-y-2">
        {filtered.map(fellow => {
          const status = getContactStatus(fellow.last_contact);
          const badges = getBadges(fellow);
          return (
            <button
              key={fellow.id}
              onClick={() => onSelectFellow(fellow)}
              className="w-full bg-white rounded-2xl p-4 shadow-sm border border-gray-100 flex items-center gap-3 active:bg-gray-50 transition text-left"
            >
              <div className="w-12 h-12 rounded-full bg-gray-200 overflow-hidden flex-shrink-0 relative">
                {fellow.photo_url ? (
                  <img src={fellow.photo_url} alt="" className="w-full h-full object-cover" />
                ) : (
                  <div className="w-full h-full flex items-center justify-center text-gray-400 font-semibold">
                    {fellow.first_name?.[0]}{fellow.last_name?.[0]}
                  </div>
                )}
                {canSeeStatus && (
                  <div className={`absolute bottom-0 right-0 w-3.5 h-3.5 rounded-full border-2 border-white status-${status.color}`}></div>
                )}
              </div>
              <div className="flex-1 min-w-0">
                <p className="font-semibold text-gray-900 truncate">
                  {fellow.first_name} {fellow.last_name}
                </p>
                <p className="text-sm text-gray-500 truncate"><T>{fellow.organization || 'No organization'}</T></p>
              </div>
              {/* Program Badges - supports multiple for staff with fellowships */}
              <div className="flex flex-wrap gap-1 items-end justify-end flex-shrink-0 max-w-[120px]">
                {badges.map((badge, idx) => (
                  <span key={idx} className={`text-xs px-2 py-0.5 rounded-full ${badge.bg} text-white font-semibold whitespace-nowrap`}>
                    {badge.label}
                  </span>
                ))}
              </div>
              <svg className="w-5 h-5 text-gray-300 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
              </svg>
            </button>
          );
        })}

        {filtered.length === 0 && (
          <div className="text-center py-12">
            <p className="text-gray-400 text-lg">No members found</p>
            <p className="text-gray-400 text-sm mt-1">Try adjusting your search or filters</p>
          </div>
        )}
      </div>

      {/* AI Search FAB */}
      <button
        onClick={() => setAiSearchOpen(true)}
        className="fixed bottom-20 left-4 px-4 py-3 rounded-full shadow-lg flex items-center gap-2 z-30 active:scale-95 transition"
        style={{ background: 'linear-gradient(to right, #E87722, #F97316)' }}
      >
        <span className="text-lg">âœ¨</span>
        <span className="text-white font-semibold text-sm">{t('Help Me Connect')}</span>
      </button>

      {/* AI Search Chat Modal */}
      {aiSearchOpen && (
        <>
          <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50" onClick={() => setAiSearchOpen(false)} />
          <div className="fixed inset-x-0 bottom-0 bg-white rounded-t-3xl z-50 flex flex-col" style={{ maxHeight: '85vh' }}>
            <div className="sticky top-0 bg-white border-b border-gray-100 px-4 py-4 flex items-center justify-between rounded-t-3xl shrink-0">
              <div>
                <h2 className="font-bold text-gray-900 text-lg">{t('Help Me Connect')}</h2>
                <p className="text-sm text-gray-500"><T>Ask anything about your fellow network</T></p>
              </div>
              <div className="flex items-center gap-2">
                {aiMessages.length > 0 && (
                  <button onClick={() => setAiMessages([])} className="text-xs px-3 py-1.5 rounded-lg bg-gray-100 text-gray-500 hover:bg-gray-200 transition">{t('New chat')}</button>
                )}
                <button onClick={() => setAiSearchOpen(false)} className="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-gray-100 transition">
                  <svg className="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
              </div>
            </div>
            <div className="flex-1 overflow-auto p-4 space-y-4" ref={el => { if (el) el.scrollTop = el.scrollHeight; }}>
              {aiMessages.length === 0 ? (
                <div className="text-center py-6">
                  <span className="text-5xl mb-4 block">âœ¨</span>
                  <p className="text-gray-700 font-medium mb-2"><T>Ask me anything about your network</T></p>
                  <p className="text-sm text-gray-400 mb-6"><T>I can search across all fellows by expertise, location, program, and more.</T></p>
                  <div className="space-y-2">
                    {['Who works on youth violence prevention in Chicago?','Find fellows who speak Spanish and work in education','Who are the most recent GGF cohort members?','Fellows working on climate action in Africa'].map((s, i) => (
                      <button key={i} onClick={() => sendAiQuery(s)} className="w-full text-left px-4 py-3 rounded-xl bg-gray-50 hover:bg-orange-50 text-sm text-gray-600 hover:text-goldin-orange transition border border-gray-100 hover:border-orange-200">{t(s)}</button>
                    ))}
                  </div>
                </div>
              ) : (
                aiMessages.map((msg, i) => (
                  <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                    <div className={`max-w-[85%] ${msg.role === 'user' ? 'bg-goldin-orange text-white rounded-2xl rounded-br-md px-4 py-3' : 'bg-gray-100 text-gray-800 rounded-2xl rounded-bl-md px-4 py-3'}`}>
                      {msg.role === 'assistant' ? (
                        <>
                          <div className="text-sm whitespace-pre-wrap">{msg.content}</div>
                          {msg.fellows && msg.fellows.length > 0 && (
                            <div className="mt-3 space-y-2">
                              {msg.fellows.map((match, j) => (
                                <button key={j} onClick={() => { setAiSearchOpen(false); onSelectFellow(match.fellow); }}
                                  className="w-full flex items-center gap-3 bg-white rounded-xl p-3 text-left hover:shadow-md transition border border-gray-100">
                                  {match.fellow.photo_url ? (
                                    <img src={match.fellow.photo_url} className="w-10 h-10 rounded-full object-cover" />
                                  ) : (
                                    <div className="w-10 h-10 rounded-full bg-goldin-orange/20 flex items-center justify-center text-goldin-orange font-bold text-sm">{match.fellow.first_name?.[0]}{match.fellow.last_name?.[0]}</div>
                                  )}
                                  <div className="flex-1 min-w-0">
                                    <p className="font-semibold text-gray-900 text-sm truncate">{match.name}</p>
                                    <p className="text-xs text-gray-500 truncate">{match.reason}</p>
                                  </div>
                                  <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${match.fellow.program === 'CPF' ? 'bg-blue-100 text-blue-700' : match.fellow.program === 'GGF' ? 'bg-orange-100 text-orange-700' : 'bg-red-100 text-red-700'}`}>{match.fellow.program}</span>
                                </button>
                              ))}
                            </div>
                          )}
                        </>
                      ) : (
                        <p className="text-sm">{msg.content}</p>
                      )}
                    </div>
                  </div>
                ))
              )}
              {aiLoading && (
                <div className="flex justify-start">
                  <div className="bg-gray-100 rounded-2xl rounded-bl-md px-4 py-3">
                    <div className="flex items-center gap-2">
                      <div className="flex gap-1">
                        <span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></span>
                        <span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></span>
                        <span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></span>
                      </div>
                      <span className="text-xs text-gray-400 ml-1"><T>Searching fellows...</T></span>
                    </div>
                  </div>
                </div>
              )}
            </div>
            <div className="sticky bottom-0 bg-white border-t border-gray-100 px-4 py-3 shrink-0">
              <form onSubmit={(e) => { e.preventDefault(); sendAiQuery(aiInput); }} className="flex gap-2">
                <input type="text" value={aiInput} onChange={(e) => setAiInput(e.target.value)} placeholder={t('Ask about fellows, skills, locations...')}
                  className="flex-1 px-4 py-3 rounded-xl bg-gray-100 border-none text-sm focus:outline-none focus:ring-2 focus:ring-goldin-orange/50" disabled={aiLoading} autoFocus />
                <button type="submit" disabled={!aiInput.trim() || aiLoading} className="px-4 py-3 rounded-xl font-medium text-sm text-white transition disabled:opacity-40" style={{ backgroundColor: '#E87722' }}>
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                </button>
              </form>
            </div>
          </div>
        </>
      )}

      {/* Filter Panel */}
      <FilterSortPanel
        isOpen={filterPanelOpen}
        onClose={() => setFilterPanelOpen(false)}
        filters={filters}
        setFilters={setFilters}
        sort={sort}
        setSort={setSort}
      />
    </div>
  );
}

// Activity Page - shows recent interactions and news mentions
function ActivityPage({ onSelectFellow }) {
  const { fellows, interactions, activities, loginEvents } = useContext(AppContext);
  const [search, setSearch] = useState('');
  const [activeTab, setActiveTab] = useState('interactions');

  // Filter interactions based on search
  const filteredInteractions = useMemo(() => {
    return interactions.filter(activity => {
      const fellow = fellows.find(f => f.id === activity.fellow_id);
      if (!fellow) return false;
      if (search) {
        const term = search.toLowerCase();
        const matchName = `${fellow.first_name} ${fellow.last_name}`.toLowerCase().includes(term);
        const matchSubject = activity.subject?.toLowerCase().includes(term);
        const matchNotes = activity.notes?.toLowerCase().includes(term);
        if (!matchName && !matchSubject && !matchNotes) return false;
      }
      return true;
    });
  }, [interactions, fellows, search]);

  // Filter news activities based on search
  const filteredNews = useMemo(() => {
    return activities.filter(activity => {
      const fellow = fellows.find(f => f.id === activity.fellow_id);
      if (!fellow) return false;
      if (search) {
        const term = search.toLowerCase();
        const matchName = `${fellow.first_name} ${fellow.last_name}`.toLowerCase().includes(term);
        const matchTitle = activity.title?.toLowerCase().includes(term);
        const matchSnippet = activity.snippet?.toLowerCase().includes(term);
        if (!matchName && !matchTitle && !matchSnippet) return false;
      }
      return true;
    });
  }, [activities, fellows, search]);

  return (
    <div className="p-4 pb-24">
      {/* Search */}
      <div className="mb-4">
        <SearchBar value={search} onChange={setSearch} placeholder="Search activity..." />
      </div>

      {/* Tabs */}
      <div className="flex gap-2 mb-4">
        <button
          onClick={() => setActiveTab('interactions')}
          className={`flex-1 py-2.5 rounded-xl text-sm font-semibold transition ${
            activeTab === 'interactions'
              ? 'bg-orange-600 text-white shadow-sm'
              : 'bg-gray-100 text-gray-600'
          }`}
        >
          Interactions ({filteredInteractions.length})
        </button>
        <button
          onClick={() => setActiveTab('news')}
          className={`flex-1 py-2.5 rounded-xl text-sm font-semibold transition ${
            activeTab === 'news'
              ? 'bg-blue-500 text-white shadow-sm'
              : 'bg-gray-100 text-gray-600'
          }`}
        >
          News ({filteredNews.length})
        </button>
        <button
          onClick={() => setActiveTab('logins')}
          className={`flex-1 py-2.5 rounded-xl text-sm font-semibold transition ${
            activeTab === 'logins'
              ? 'bg-green-600 text-white shadow-sm'
              : 'bg-gray-100 text-gray-600'
          }`}
        >
          Logins ({loginEvents.length})
        </button>
      </div>

      {/* Interactions Tab */}
      {activeTab === 'interactions' && (
        <>
          {filteredInteractions.length === 0 ? (
            <div className="bg-white rounded-2xl p-8 text-center border border-gray-100">
              <span className="text-4xl mb-3 block">ðŸ“‹</span>
              <p className="text-gray-500">No interactions found</p>
            </div>
          ) : (
            filteredInteractions.map((activity, i) => (
              <ActivityItem
                key={activity.id}
                activity={activity}
                fellow={fellows.find(f => f.id === activity.fellow_id)}
                onClick={onSelectFellow}
                style={{ animationDelay: `${i * 0.05}s` }}
              />
            ))
          )}
        </>
      )}

      {/* News Tab */}
      {activeTab === 'news' && (
        <>
          {filteredNews.length === 0 ? (
            <div className="bg-white rounded-2xl p-8 text-center border border-gray-100">
              <span className="text-4xl mb-3 block">ðŸ“°</span>
              <p className="text-gray-500">No news mentions found</p>
              <p className="text-xs text-gray-400 mt-2">Use Settings â†’ News Scanner to find mentions</p>
            </div>
          ) : (
            filteredNews.map((activity, i) => {
              const fellow = fellows.find(f => f.id === activity.fellow_id);
              if (!fellow) return null;
              const badge = getProgramBadge(fellow.program);
              return (
                <a
                  key={activity.id}
                  href={activity.source_url}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="activity-item block w-full text-left p-4 bg-white rounded-2xl shadow-sm border border-gray-100 mb-3"
                  style={{ animationDelay: `${i * 0.05}s` }}
                >
                  <div className="flex gap-3">
                    <div className="w-12 h-12 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
                      {fellow.photo_url ? (
                        <img src={fellow.photo_url} alt="" className="w-full h-full object-cover" />
                      ) : (
                        <div className="w-full h-full flex items-center justify-center text-gray-400 text-lg font-semibold">
                          {fellow.first_name?.[0]}{fellow.last_name?.[0]}
                        </div>
                      )}
                    </div>
                    <div className="flex-1 min-w-0">
                      <div className="flex items-start justify-between gap-2">
                        <p className="font-semibold text-gray-900">
                          {fellow.first_name} {fellow.last_name}
                          <span className={`ml-2 text-xs px-1.5 py-0.5 rounded ${badge.bg} text-white`}>
                            {badge.label}
                          </span>
                        </p>
                        <span className="text-xs text-gray-400 whitespace-nowrap">
                          {getTimeAgo(activity.discovered_at)}
                        </span>
                      </div>
                      <p className="text-sm font-medium text-blue-600 mt-1 line-clamp-2"><T>{activity.title}</T></p>
                      <p className="text-xs text-gray-500 mt-1 line-clamp-2"><T>{activity.snippet}</T></p>
                      <p className="text-xs text-gray-400 mt-2 flex items-center gap-1">
                        <span>ðŸ“°</span> {activity.source_name}
                      </p>
                    </div>
                  </div>
                </a>
              );
            })
          )}
        </>
      )}

      {/* Logins Tab */}
      {activeTab === 'logins' && (
        <>
          {loginEvents.length === 0 ? (
            <div className="bg-white rounded-2xl p-8 text-center border border-gray-100">
              <span className="text-4xl mb-3 block">ðŸ”‘</span>
              <p className="text-gray-500">No login activity yet</p>
            </div>
          ) : (
            loginEvents.map((evt, i) => (
              <div
                key={evt.id}
                className="activity-item p-4 bg-white rounded-2xl shadow-sm border border-gray-100 mb-3"
                style={{ animationDelay: `${i * 0.05}s` }}
              >
                <div className="flex gap-3 items-center">
                  <div className="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600 font-bold text-sm flex-shrink-0">
                    {evt.name?.[0]?.toUpperCase() || evt.email?.[0]?.toUpperCase()}
                  </div>
                  <div className="flex-1 min-w-0">
                    <p className="font-semibold text-gray-900 text-sm">{evt.name || evt.email}</p>
                    <p className="text-xs text-gray-400">{evt.email}</p>
                  </div>
                  <span className="text-xs text-gray-400 whitespace-nowrap">
                    {getTimeAgo(evt.logged_in_at)}
                  </span>
                </div>
              </div>
            ))
          )}
        </>
      )}
    </div>
  );
}

// Search Page - Advanced search with sort and filter
function SearchPage({ onSelectFellow }) {
  const { fellows } = useContext(AppContext);
  const [search, setSearch] = useState('');
  const [statusFilter, setStatusFilter] = useState('');
  const [programFilter, setProgramFilter] = useState('');
  const [countryFilter, setCountryFilter] = useState('');
  const [sortBy, setSortBy] = useState('name');
  const [sortOrder, setSortOrder] = useState('asc');
  
  const statusCounts = useMemo(() => {
    const counts = { green: 0, yellow: 0, red: 0 };
    fellows.forEach(f => {
      counts[getContactStatus(f.last_contact).color]++;
    });
    return counts;
  }, [fellows]);

  // Get unique programs and countries for filters
  const programs = useMemo(() => {
    const set = new Set(fellows.map(f => f.program).filter(Boolean));
    return Array.from(set).sort();
  }, [fellows]);

  const countries = useMemo(() => {
    const set = new Set(fellows.map(f => f.country).filter(Boolean));
    return Array.from(set).sort();
  }, [fellows]);

  // Filter and sort fellows
  const filteredFellows = useMemo(() => {
    let result = fellows.filter(f => {
      // Search filter
      if (search) {
        const term = search.toLowerCase();
        const matchName = `${f.first_name} ${f.last_name}`.toLowerCase().includes(term);
        const matchOrg = f.organization?.toLowerCase().includes(term);
        const matchCity = f.city?.toLowerCase().includes(term);
        const matchCountry = f.country?.toLowerCase().includes(term);
        if (!matchName && !matchOrg && !matchCity && !matchCountry) return false;
      }
      
      // Status filter
      if (statusFilter && getContactStatus(f.last_contact).color !== statusFilter) return false;
      
      // Program filter
      if (programFilter && f.program !== programFilter) return false;
      
      // Country filter
      if (countryFilter && f.country !== countryFilter) return false;
      
      return true;
    });

    // Sort
    result.sort((a, b) => {
      let comparison = 0;
      switch (sortBy) {
        case 'name':
          comparison = `${a.last_name} ${a.first_name}`.localeCompare(`${b.last_name} ${b.first_name}`);
          break;
        case 'organization':
          comparison = (a.organization || '').localeCompare(b.organization || '');
          break;
        case 'status':
          const statusOrder = { red: 0, yellow: 1, green: 2 };
          comparison = statusOrder[getContactStatus(a.last_contact).color] - statusOrder[getContactStatus(b.last_contact).color];
          break;
        case 'last_contact':
          comparison = new Date(b.last_contact || 0) - new Date(a.last_contact || 0);
          break;
        default:
          comparison = 0;
      }
      return sortOrder === 'asc' ? comparison : -comparison;
    });

    return result;
  }, [fellows, search, statusFilter, programFilter, countryFilter, sortBy, sortOrder]);

  return (
    <div className="p-4 pb-24">
      {/* Search Bar */}
      <div className="mb-4">
        <SearchBar value={search} onChange={setSearch} placeholder="Search name, organization, city..." />
      </div>
      
      {/* Status Filter Pills */}
      <StatusFilterBar 
        statusFilter={statusFilter} 
        setStatusFilter={setStatusFilter} 
        statusCounts={statusCounts} 
      />
      
      {/* Advanced Filters */}
      <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-4">
        <h3 className="text-sm font-semibold text-gray-700 mb-3">Filters & Sort</h3>
        
        <div className="grid grid-cols-2 gap-3">
          {/* Program Filter */}
          <div>
            <label className="block text-xs text-gray-500 mb-1">Program</label>
            <select
              value={programFilter}
              onChange={(e) => setProgramFilter(e.target.value)}
              className="w-full border border-gray-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-goldin-orange/30"
            >
              <option value="">All Programs</option>
              {programs.map(p => (
                <option key={p} value={p}>{p}</option>
              ))}
            </select>
          </div>
          
          {/* Country Filter */}
          <div>
            <label className="block text-xs text-gray-500 mb-1">Country</label>
            <select
              value={countryFilter}
              onChange={(e) => setCountryFilter(e.target.value)}
              className="w-full border border-gray-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-goldin-orange/30"
            >
              <option value="">All Countries</option>
              {countries.map(c => (
                <option key={c} value={c}>{c}</option>
              ))}
            </select>
          </div>
          
          {/* Sort By */}
          <div>
            <label className="block text-xs text-gray-500 mb-1">Sort By</label>
            <select
              value={sortBy}
              onChange={(e) => setSortBy(e.target.value)}
              className="w-full border border-gray-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-goldin-orange/30"
            >
              <option value="name">Name</option>
              <option value="organization">Organization</option>
              <option value="status">Status (Urgent First)</option>
              <option value="last_contact">Last Contact</option>
            </select>
          </div>
          
          {/* Sort Order */}
          <div>
            <label className="block text-xs text-gray-500 mb-1">Order</label>
            <select
              value={sortOrder}
              onChange={(e) => setSortOrder(e.target.value)}
              className="w-full border border-gray-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-goldin-orange/30"
            >
              <option value="asc">Ascending</option>
              <option value="desc">Descending</option>
            </select>
          </div>
        </div>
        
        {/* Clear Filters */}
        {(programFilter || countryFilter || statusFilter) && (
          <button 
            onClick={() => { setProgramFilter(''); setCountryFilter(''); setStatusFilter(''); }}
            className="mt-3 text-sm text-goldin-orange font-medium"
          >
            Clear all filters
          </button>
        )}
      </div>
      
      {/* Results Count */}
      <p className="text-sm text-gray-500 mb-3">{filteredFellows.length} results</p>
      
      {/* Results List */}
      <div className="space-y-2">
        {filteredFellows.map(fellow => {
          const status = getContactStatus(fellow.last_contact);
          const badge = getProgramBadge(fellow.program);
          return (
            <button 
              key={fellow.id} 
              onClick={() => onSelectFellow(fellow)}
              className="w-full bg-white rounded-2xl p-4 shadow-sm border border-gray-100 flex items-center gap-3 active:bg-gray-50 transition text-left"
            >
              <div className="w-12 h-12 rounded-full bg-gray-200 overflow-hidden flex-shrink-0 relative">
                {fellow.photo_url ? (
                  <img src={fellow.photo_url} alt="" className="w-full h-full object-cover" />
                ) : (
                  <div className="w-full h-full flex items-center justify-center text-gray-400 font-semibold">
                    {fellow.first_name?.[0]}{fellow.last_name?.[0]}
                  </div>
                )}
                <div className={`absolute bottom-0 right-0 w-3.5 h-3.5 rounded-full border-2 border-white status-${status.color}`}></div>
              </div>
              <div className="flex-1 min-w-0">
                <p className="font-semibold text-gray-900 truncate">
                  {fellow.first_name} {fellow.last_name}
                </p>
                <p className="text-sm text-gray-500 truncate"><T>{fellow.organization || 'No organization'}</T></p>
                {fellow.country && <p className="text-xs text-gray-400"><T>{fellow.city ? `${fellow.city}, ${fellow.country}` : fellow.country}</T></p>}
              </div>
              <span className={`text-xs px-2 py-1 rounded-full ${badge.bg} text-white`}>
                {badge.label}
              </span>
            </button>
          );
        })}
      </div>
    </div>
  );
}

// Broadcast Page - In-app Announcements (default) and Email Newsletter
function BroadcastPage() {
  const { user, fellows } = useContext(AppContext);
  const [activeTab, setActiveTab] = useState('announcement'); // 'announcement' or 'newsletter'

  // Announcement state
  const [showNewAnnouncement, setShowNewAnnouncement] = useState(false);
  const [newAnnouncement, setNewAnnouncement] = useState({ title: '', content: '', is_pinned: false });
  const [savingAnnouncement, setSavingAnnouncement] = useState(false);

  // Newsletter state
  const [selectedCohorts, setSelectedCohorts] = useState([]);
  const [statusFilter, setStatusFilter] = useState('');
  const [subject, setSubject] = useState('');
  const [content, setContent] = useState('');
  const [showPreview, setShowPreview] = useState(false);
  const [sending, setSending] = useState(false);
  const [newsletterHistory, setNewsletterHistory] = useState([]);
  const [loadingHistory, setLoadingHistory] = useState(true);

  const statusCounts = useMemo(() => {
    const counts = { green: 0, yellow: 0, red: 0 };
    fellows.forEach(f => {
      counts[getContactStatus(f.last_contact).color]++;
    });
    return counts;
  }, [fellows]);

  const cohorts = useMemo(() => {
    const set = new Set(fellows.map(f => f.cohort).filter(Boolean));
    return Array.from(set).sort();
  }, [fellows]);

  const recipients = useMemo(() => {
    return fellows.filter(f => {
      if (selectedCohorts.length > 0 && !selectedCohorts.includes(f.cohort)) return false;
      if (statusFilter && getContactStatus(f.last_contact).color !== statusFilter) return false;
      return f.email;
    });
  }, [fellows, selectedCohorts, statusFilter]);

  // Fetch newsletter history
  useEffect(() => {
    const fetchHistory = async () => {
      setLoadingHistory(true);
      const { data, error } = await supabase
        .from('newsletter_sends')
        .select('*')
        .order('sent_at', { ascending: false })
        .limit(10);

      if (!error && data) {
        setNewsletterHistory(data);
      }
      setLoadingHistory(false);
    };
    fetchHistory();
  }, []);

  const toggleCohort = (cohort) => {
    setSelectedCohorts(prev =>
      prev.includes(cohort)
        ? prev.filter(c => c !== cohort)
        : [...prev, cohort]
    );
  };

  // Create in-app announcement
  const handleCreateAnnouncement = async () => {
    if (!newAnnouncement.title.trim() || !newAnnouncement.content.trim()) return;
    setSavingAnnouncement(true);

    const { data, error } = await supabase
      .from('announcements')
      .insert({
        title: newAnnouncement.title,
        content: newAnnouncement.content,
        is_pinned: newAnnouncement.is_pinned,
        author_id: user?.id,
        published_at: new Date().toISOString(),
      })
      .select()
      .single();

    if (!error && data) {
      // Also publish to GetStream activity feed (best-effort)
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
          const tokenRes = await fetch(
            `${SUPABASE_URL}/functions/v1/stream-token`,
            {
              headers: {
                'Authorization': `Bearer ${session.access_token}`,
                'Content-Type': 'application/json',
              },
            }
          );
          if (tokenRes.ok) {
            const { token, api_key } = await tokenRes.json();
            const client = window.stream.connect(api_key, token, '1497007');
            const feed = client.feed('flat', 'community');
            await feed.addActivity({
              actor: `user:${session.user.id}`,
              verb: 'announcement',
              object: `announcement:${data.id}`,
              message: data.title,
              announcementId: data.id,
              foreign_id: `announcement:${data.id}`,
              time: new Date().toISOString(),
            });
          }
        }
      } catch (streamErr) {
        console.warn('Failed to publish to activity feed:', streamErr);
        // Don't fail the announcement if GetStream fails
      }

      setNewAnnouncement({ title: '', content: '', is_pinned: false });
      setShowNewAnnouncement(false);
      alert('Announcement posted! It will appear in the Community feed.');
    } else {
      alert('Error creating announcement: ' + (error?.message || 'Unknown error'));
    }
    setSavingAnnouncement(false);
  };

  // Send newsletter email via Buttondown
  const handleSendNewsletter = async () => {
    if (!subject.trim() || !content.trim()) {
      alert('Please fill in subject and content');
      return;
    }
    if (recipients.length === 0) {
      alert('No recipients selected');
      return;
    }

    if (!confirm(`Send newsletter to ${recipients.length} recipients?\n\nSubject: ${subject}`)) {
      return;
    }

    setSending(true);

    try {
      // Log to newsletter_sends table first
      const { data, error } = await supabase
        .from('newsletter_sends')
        .insert({
          subject: subject,
          body_preview: content.substring(0, 200),
          sent_by: user?.id,
          recipient_count: recipients.length,
          target_programs: selectedCohorts,
        })
        .select()
        .single();

      if (error) {
        alert('Error logging newsletter: ' + error.message);
        setSending(false);
        return;
      }

      // Send via Buttondown Edge Function
      const session = await supabase.auth.getSession();
      const token = session?.data?.session?.access_token;

      const sendRes = await fetch(`${SUPABASE_URL}/functions/v1/send-newsletter`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          subject: subject,
          body: content,
          target_programs: selectedCohorts.length > 0 ? selectedCohorts : null,
          newsletter_send_id: data.id,
        }),
      });

      const result = await sendRes.json();

      if (sendRes.ok && result.success) {
        setNewsletterHistory(prev => [data, ...prev]);
        alert(`Newsletter sent to ${recipients.length} recipients!`);
        setSubject('');
        setContent('');
      } else {
        // Remove the log entry if send failed
        await supabase.from('newsletter_sends').delete().eq('id', data.id);
        alert('Failed to send newsletter: ' + (result.error || 'Unknown error'));
      }
    } catch (err) {
      alert('Error sending newsletter: ' + err.message);
    }

    setSending(false);
  };

  const formatDate = (dateStr) => {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Tabs */}
      <div className="bg-white border-b border-gray-200 sticky top-16 z-10">
        <div className="flex">
          <button
            onClick={() => setActiveTab('announcement')}
            className={`flex-1 py-3 text-sm font-medium border-b-2 transition ${
              activeTab === 'announcement'
                ? 'text-orange-600 border-orange-500'
                : 'text-gray-500 border-transparent'
            }`}
          >
            ðŸ“¢ Announcement
          </button>
          <button
            onClick={() => setActiveTab('newsletter')}
            className={`flex-1 py-3 text-sm font-medium border-b-2 transition ${
              activeTab === 'newsletter'
                ? 'text-orange-600 border-orange-500'
                : 'text-gray-500 border-transparent'
            }`}
          >
            âœ‰ï¸ Newsletter
          </button>
        </div>
      </div>

      <div className="p-4">
        {/* ANNOUNCEMENT TAB - In-app messages */}
        {activeTab === 'announcement' && (
          <div className="space-y-4">
            <div className="bg-blue-50 border border-blue-200 rounded-xl p-3 flex items-start gap-2">
              <span className="text-lg">â„¹ï¸</span>
              <p className="text-sm text-blue-800">
                Announcements appear in the <strong>Community</strong> feed for all fellows using the app.
              </p>
            </div>

            {!showNewAnnouncement ? (
              <button
                onClick={() => setShowNewAnnouncement(true)}
                className="w-full py-4 bg-orange-500 text-white rounded-xl font-semibold"
              >
                + Create Announcement
              </button>
            ) : (
              <div className="bg-white rounded-xl p-4 border border-gray-200 space-y-3">
                <input
                  type="text"
                  placeholder="Announcement title..."
                  value={newAnnouncement.title}
                  onChange={(e) => setNewAnnouncement(prev => ({ ...prev, title: e.target.value }))}
                  className="w-full px-3 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-orange-500"
                />
                <textarea
                  placeholder="What would you like to share?"
                  value={newAnnouncement.content}
                  onChange={(e) => setNewAnnouncement(prev => ({ ...prev, content: e.target.value }))}
                  rows={5}
                  className="w-full px-3 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-orange-500 resize-none"
                />
                <label className="flex items-center gap-2">
                  <input
                    type="checkbox"
                    checked={newAnnouncement.is_pinned}
                    onChange={(e) => setNewAnnouncement(prev => ({ ...prev, is_pinned: e.target.checked }))}
                    className="w-4 h-4 text-orange-500"
                  />
                  <span className="text-sm text-gray-600">Pin this announcement</span>
                </label>
                <div className="flex gap-2">
                  <button
                    onClick={() => setShowNewAnnouncement(false)}
                    className="flex-1 py-3 border border-gray-200 rounded-lg text-gray-600"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={handleCreateAnnouncement}
                    disabled={savingAnnouncement || !newAnnouncement.title.trim() || !newAnnouncement.content.trim()}
                    className="flex-1 py-3 bg-orange-500 text-white rounded-lg font-semibold disabled:opacity-50"
                  >
                    {savingAnnouncement ? 'Posting...' : 'Post Announcement'}
                  </button>
                </div>
              </div>
            )}
          </div>
        )}

        {/* NEWSLETTER TAB - Email to fellows */}
        {activeTab === 'newsletter' && (
          <div className="space-y-4">
            <div className="bg-yellow-50 border border-yellow-200 rounded-xl p-3 flex items-start gap-2">
              <span className="text-lg">âœ‰ï¸</span>
              <p className="text-sm text-yellow-800">
                Newsletters are sent via <strong>email</strong> to fellows outside the app.
              </p>
            </div>

            {/* Status Filter Pills */}
            <StatusFilterBar
              statusFilter={statusFilter}
              setStatusFilter={setStatusFilter}
              statusCounts={statusCounts}
            />

            {/* Cohort Selection */}
            <div className="bg-white rounded-xl p-4 border border-gray-200">
              <div className="flex items-center justify-between mb-3">
                <h3 className="text-sm font-semibold text-gray-700">Select Recipients</h3>
                <button
                  onClick={() => setSelectedCohorts(selectedCohorts.length === cohorts.length ? [] : [...cohorts])}
                  className="text-xs text-goldin-orange font-medium"
                >
                  {selectedCohorts.length === cohorts.length ? 'Deselect All' : 'Select All'}
                </button>
              </div>

              <div className="flex flex-wrap gap-2 max-h-32 overflow-auto">
                {cohorts.map(cohort => (
                  <button
                    key={cohort}
                    onClick={() => toggleCohort(cohort)}
                    className={`px-3 py-1.5 rounded-full text-sm font-medium transition ${
                      selectedCohorts.includes(cohort)
                        ? 'bg-goldin-orange text-white'
                        : 'bg-gray-100 text-gray-700'
                    }`}
                  >
                    {cohort}
                  </button>
                ))}
              </div>

              <p className="mt-3 text-sm text-gray-500">
                <span className="font-semibold text-goldin-orange">{recipients.length}</span> recipients with email addresses
              </p>
            </div>

            {/* Email Composition */}
            <div className="bg-white rounded-xl p-4 border border-gray-200 space-y-3">
              <div>
                <label className="block text-xs text-gray-500 mb-1">Subject</label>
                <input
                  type="text"
                  value={subject}
                  onChange={(e) => setSubject(e.target.value)}
                  placeholder="Enter email subject..."
                  className="w-full border border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-goldin-orange/30"
                />
              </div>

              <div>
                <div className="flex items-center justify-between mb-1">
                  <label className="text-xs text-gray-500">Content</label>
                  <button
                    onClick={() => setShowPreview(!showPreview)}
                    className="text-xs text-goldin-orange font-medium"
                  >
                    {showPreview ? 'Edit' : 'Preview'}
                  </button>
                </div>
                {showPreview ? (
                  <div className="w-full border border-gray-200 rounded-lg p-4 min-h-[200px] bg-gray-50">
                    {content || <span className="text-gray-400">No content yet...</span>}
                  </div>
                ) : (
                  <textarea
                    value={content}
                    onChange={(e) => setContent(e.target.value)}
                    placeholder="Write your newsletter here..."
                    rows={8}
                    className="w-full border border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-goldin-orange/30 resize-none"
                  />
                )}
              </div>

              <button
                onClick={handleSendNewsletter}
                disabled={sending || recipients.length === 0 || !subject.trim() || !content.trim()}
                className="w-full bg-goldin-orange text-white font-bold py-4 rounded-xl disabled:opacity-50"
              >
                {sending ? 'Sending...' : `Send to ${recipients.length} Recipients`}
              </button>
            </div>

            {/* Newsletter History */}
            <div>
              <h3 className="font-semibold text-gray-900 mb-3">Recent Sends</h3>
              {loadingHistory ? (
                <div className="text-center py-4 text-gray-500">Loading...</div>
              ) : newsletterHistory.length === 0 ? (
                <div className="text-center py-4 text-gray-500">No newsletters sent yet</div>
              ) : (
                <div className="space-y-2">
                  {newsletterHistory.map(send => (
                    <div key={send.id} className="bg-white rounded-lg p-3 border border-gray-200">
                      <p className="font-medium text-gray-900">{send.subject}</p>
                      <p className="text-sm text-gray-500">
                        {formatDate(send.sent_at)} Â· {send.recipient_count || 0} recipients
                      </p>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

function SettingsPage({ onNavigate }) {
  const { user, userRole, fellows, teamMembers, fetchData, logout, canAccess, language, changeLanguage, t } = useContext(AppContext);
  const [profileModalOpen, setProfileModalOpen] = useState(false);
  const [myFellow, setMyFellow] = useState(null);
  const [myTeamMember, setMyTeamMember] = useState(null);
  const [profileType, setProfileType] = useState(null); // 'fellow' or 'team_member'
  const [editData, setEditData] = useState({});
  const [saving, setSaving] = useState(false);
  const [scanning, setScanning] = useState(false);
  const [scanResults, setScanResults] = useState(null);
  const [langMenuOpen, setLangMenuOpen] = useState(false);
  const [creatingProfile, setCreatingProfile] = useState(false);
  const [notificationModalOpen, setNotificationModalOpen] = useState(false);
  const [notificationSettings, setNotificationSettings] = useState(() => {
    const saved = localStorage.getItem('gatherNotificationSettings');
    return saved ? JSON.parse(saved) : {
      pushEnabled: false,
      emailEnabled: true,
      dailySummary: true,
      weeklySummary: false,
      teamActivity: true,
      overdueAlerts: true,
      newsMentions: false,
    };
  });
  const [savingNotifications, setSavingNotifications] = useState(false);

  const isStaff = canAccess(ROLES.TEAM);
  const isTravis = user?.email?.toLowerCase() === 'travis@goldininstitute.org';
  const isGoldinEmail = user?.email?.toLowerCase().endsWith('@goldininstitute.org') ||
                        user?.email?.toLowerCase().endsWith('@chicagopeacefellows.org');
  const currentLang = SUPPORTED_LANGUAGES.find(l => l.code === language) || SUPPORTED_LANGUAGES[0];

  // Check daily scan limit for non-Travis users
  const getDailyScanCount = () => {
    const today = new Date().toDateString();
    const stored = localStorage.getItem('gather_scan_count');
    if (stored) {
      const { date, count } = JSON.parse(stored);
      if (date === today) return count;
    }
    return 0;
  };

  const incrementScanCount = () => {
    const today = new Date().toDateString();
    const current = getDailyScanCount();
    localStorage.setItem('gather_scan_count', JSON.stringify({ date: today, count: current + 1 }));
  };

  // Track last news scan date
  const getLastScanDate = () => {
    const stored = localStorage.getItem('gather_last_news_scan');
    return stored ? new Date(stored) : null;
  };

  const setLastScanDate = () => {
    localStorage.setItem('gather_last_news_scan', new Date().toISOString());
  };

  const daysSinceLastScan = () => {
    const lastScan = getLastScanDate();
    if (!lastScan) return 999; // Never scanned
    return Math.floor((Date.now() - lastScan.getTime()) / (1000 * 60 * 60 * 24));
  };

  const [dailyScanCount, setDailyScanCount] = useState(getDailyScanCount());
  const [showScanReminder, setShowScanReminder] = useState(daysSinceLastScan() > 7);
  const canScanMore = isTravis || dailyScanCount < 3;
  const [scanPlatforms, setScanPlatforms] = useState(() => {
    const saved = localStorage.getItem('gatherScanPlatforms');
    return saved ? JSON.parse(saved) : {
      google_news: true,
      linkedin: true,
      twitter: true,
      facebook: false,
      instagram: false,
    };
  });
  const [platformsExpanded, setPlatformsExpanded] = useState(false);

  // Custom search terms state
  const [customSearchTerms, setCustomSearchTerms] = useState([]);
  const [newTermInput, setNewTermInput] = useState('');
  const [loadingTerms, setLoadingTerms] = useState(false);
  const isAdmin = canAccess(ROLES.ADMIN);
  const defaultTerms = ['Goldin Institute', 'Chicago Peace Fellows', 'Goldin Global Fellows', 'GATHER'];

  const platformOptions = [
    { id: 'google_news', label: 'Google News', icon: 'ðŸ“°', description: 'Traditional news articles' },
    { id: 'linkedin', label: 'LinkedIn', icon: 'ðŸ’¼', description: 'Professional profiles & posts' },
    { id: 'twitter', label: 'Twitter/X', icon: 'ðŸ¦', description: 'Public tweets & mentions' },
    { id: 'facebook', label: 'Facebook', icon: 'ðŸ‘¥', description: 'Public pages & posts' },
    { id: 'instagram', label: 'Instagram', icon: 'ðŸ“¸', description: 'Public profiles' },
  ];

  const selectedPlatforms = Object.entries(scanPlatforms)
    .filter(([_, enabled]) => enabled)
    .map(([id]) => id);

  const togglePlatform = (platformId) => {
    const updated = { ...scanPlatforms, [platformId]: !scanPlatforms[platformId] };
    setScanPlatforms(updated);
    localStorage.setItem('gatherScanPlatforms', JSON.stringify(updated));
  };

  // Load custom search terms from app_settings
  useEffect(() => {
    if (!isStaff) return;
    const loadTerms = async () => {
      setLoadingTerms(true);
      try {
        const { data, error } = await supabase
          .from('app_settings')
          .select('value')
          .eq('key', 'news_search_terms')
          .single();
        if (error && error.code !== 'PGRST116') {
          console.error('Error loading search terms:', error);
        }
        if (data?.value) {
          setCustomSearchTerms(Array.isArray(data.value) ? data.value : []);
        } else {
          // Use defaults if no setting exists yet
          setCustomSearchTerms(defaultTerms);
        }
      } catch (err) {
        console.error('Failed to load search terms:', err);
        setCustomSearchTerms(defaultTerms);
      }
      setLoadingTerms(false);
    };
    loadTerms();
  }, [isStaff]);

  // Save custom search terms to app_settings
  const saveCustomTerms = async (terms) => {
    try {
      const { error } = await supabase
        .from('app_settings')
        .upsert({
          key: 'news_search_terms',
          value: terms,
          updated_at: new Date().toISOString()
        }, { onConflict: 'key' });
      if (error) console.error('Error saving search terms:', error);
    } catch (err) {
      console.error('Failed to save search terms:', err);
    }
  };

  const addCustomTerm = () => {
    const term = newTermInput.trim();
    if (!term || customSearchTerms.includes(term)) return;
    const updated = [...customSearchTerms, term];
    setCustomSearchTerms(updated);
    setNewTermInput('');
    saveCustomTerms(updated);
  };

  const removeCustomTerm = (term) => {
    const updated = customSearchTerms.filter(t => t !== term);
    setCustomSearchTerms(updated);
    saveCustomTerms(updated);
  };

  // Scan for news about fellows using Supabase Edge Function
  const scanForNews = async (fullScan = false) => {
    if (!isStaff) return;
    if (!isTravis && !canScanMore) return;

    setScanning(true);
    setScanResults({ scanned: 0, found: 0, total: fellows.length, inProgress: true });

    try {
      // Process fellows in small batches to stay within Edge Function timeout
      const BATCH_SIZE = 5;
      const totalFellows = fellows.length;
      let totalScanned = 0;
      let totalFound = 0;

      for (let offset = 0; offset < totalFellows; offset += BATCH_SIZE) {
        const batchSize = Math.min(BATCH_SIZE, totalFellows - offset);

        const response = await fetch(`${SUPABASE_URL}/functions/v1/search-news`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify({
            max_fellows: batchSize,
            platforms: selectedPlatforms,
            customTerms: customSearchTerms
          })
        });

        const result = await response.json();

        if (result.error || result.code) {
          console.error('News scan batch error:', result.error || result.message);
          // Continue to next batch instead of stopping completely
          totalScanned += batchSize;
        } else {
          const batchFound = result.results?.reduce((sum, r) => sum + r.activitiesFound, 0) || 0;
          totalScanned += result.fellowsSearched || batchSize;
          totalFound += batchFound;
        }

        // Update progress after each batch
        setScanResults({
          scanned: totalScanned,
          found: totalFound,
          total: totalFellows,
          inProgress: offset + BATCH_SIZE < totalFellows
        });
      }

      // Final results
      setScanResults({
        scanned: totalScanned,
        found: totalFound,
        total: totalFellows,
        inProgress: false
      });

      // Increment scan count for non-Travis users
      if (!isTravis) {
        incrementScanCount();
        setDailyScanCount(getDailyScanCount() + 1);
      }

      // Update last scan date and dismiss reminder
      setLastScanDate();
      setShowScanReminder(false);
    } catch (err) {
      console.error('News scan failed:', err);
      setScanResults({ scanned: 0, found: 0, inProgress: false, error: err.message });
    }

    setScanning(false);
    fetchData(); // Refresh to show new activities
  };

  // Find user's profile - check team_members first (for staff), then fellows
  useEffect(() => {
    if (!user?.email) return;
    const userEmailLower = user.email.toLowerCase();

    // Check team_members first (for staff)
    if (teamMembers && teamMembers.length > 0) {
      const foundTeam = teamMembers.find(tm => {
        if (tm.email && tm.email.toLowerCase() === userEmailLower) return true;
        // Check alternate_emails
        if (tm.alternate_emails && Array.isArray(tm.alternate_emails)) {
          if (tm.alternate_emails.some(e => e.toLowerCase() === userEmailLower)) return true;
        }
        return false;
      });
      if (foundTeam) {
        setMyTeamMember(foundTeam);
        setProfileType('team_member');
        return;
      }
    }

    // Check fellows
    if (fellows && fellows.length > 0) {
      const foundFellow = fellows.find(f => {
        // Check primary email
        if (f.email && f.email.toLowerCase() === userEmailLower) return true;
        // Check work_email (can be comma-separated list)
        if (f.work_email) {
          const workEmails = f.work_email.toLowerCase().split(',').map(e => e.trim());
          if (workEmails.includes(userEmailLower)) return true;
        }
        // Check alternate_emails
        if (f.alternate_emails && Array.isArray(f.alternate_emails)) {
          if (f.alternate_emails.some(e => e.toLowerCase() === userEmailLower)) return true;
        }
        return false;
      });
      if (foundFellow) {
        setMyFellow(foundFellow);
        setProfileType('fellow');
        return;
      }
    }

    // No profile found
    setMyFellow(null);
    setMyTeamMember(null);
    setProfileType(null);
  }, [user?.email, fellows, teamMembers]);

  const handleLogout = async () => {
    if (confirm('Are you sure you want to sign out?')) {
      await logout();
    }
  };

  // Create a new staff profile
  const createStaffProfile = async () => {
    if (!user?.email) return;
    setCreatingProfile(true);

    // First check if a profile with this email already exists (case insensitive)
    const { data: existing } = await supabase
      .from('fellows')
      .select('*')
      .ilike('email', user.email)
      .single();

    if (existing) {
      // Profile already exists, just link it
      setMyFellow(existing);
      setCreatingProfile(false);
      return;
    }

    // Parse name from email (travis@... -> Travis)
    const emailName = user.email.split('@')[0];
    const firstName = emailName.charAt(0).toUpperCase() + emailName.slice(1).replace(/[._]/g, ' ');

    // Generate a unique ID
    const newId = `staff_${Date.now()}`;

    const { data, error } = await supabase
      .from('fellows')
      .insert({
        id: newId,
        first_name: firstName,
        last_name: '',
        email: user.email.toLowerCase(),
        status: 'Staff',
        program: 'Staff',
        organization: 'Goldin Institute',
        city: 'Chicago',
        country: 'United States'
      })
      .select()
      .single();

    if (!error && data) {
      setMyFellow(data);
      // Open profile editor immediately so they can fill in details
      setEditData({
        first_name: data.first_name || '',
        last_name: data.last_name || '',
        email: data.email || '',
        phone: '',
        organization: data.organization || '',
        job_title: '',
        city: data.city || '',
        country: data.country || '',
        biography: '',
        linkedin: '',
        twitter: '',
        website: '',
        languages: '',
      });
      setProfileModalOpen(true);
      fetchData();
    } else {
      console.error('Error creating profile:', error);
      alert('Error creating profile. Please try again.');
    }
    setCreatingProfile(false);
  };

  const openProfileEditor = () => {
    if (profileType === 'team_member' && myTeamMember) {
      setEditData({
        first_name: myTeamMember.first_name || '',
        last_name: myTeamMember.last_name || '',
        email: myTeamMember.email || '',
        phone: myTeamMember.phone || '',
        title: myTeamMember.title || '',
        bio: myTeamMember.bio || '',
        linkedin_url: myTeamMember.linkedin_url || '',
      });
      setProfileModalOpen(true);
    } else if (myFellow) {
      setEditData({
        first_name: myFellow.first_name || '',
        last_name: myFellow.last_name || '',
        email: myFellow.email || '',
        phone: myFellow.phone || '',
        organization: myFellow.organization || '',
        job_title: myFellow.job_title || '',
        city: myFellow.city || '',
        country: myFellow.country || '',
        biography: myFellow.biography || '',
        linkedin: myFellow.linkedin || '',
        twitter: myFellow.twitter || '',
        website: myFellow.website || '',
        languages: myFellow.languages || '',
      });
      setProfileModalOpen(true);
    }
  };

  const saveProfile = async () => {
    setSaving(true);
    let error = null;

    if (profileType === 'team_member' && myTeamMember) {
      // Save team member profile
      const updateData = {
        phone: editData.phone,
        title: editData.title,
        bio: editData.bio,
        linkedin_url: editData.linkedin_url,
        updated_at: new Date().toISOString(),
      };
      const result = await supabase
        .from('team_members')
        .update(updateData)
        .eq('id', myTeamMember.id);
      error = result.error;
    } else if (myFellow) {
      // Save fellow profile
      const result = await supabase
        .from('fellows')
        .update(editData)
        .eq('id', myFellow.id);
      error = result.error;
    }

    if (!error) {
      setProfileModalOpen(false);
      fetchData();
    } else {
      alert('Error saving changes: ' + error.message);
    }
    setSaving(false);
  };

  return (
    <div className="p-4 pb-24">
      <h1 className="text-2xl font-bold text-gray-900 mb-6">Settings</h1>

      {/* Notifications */}
      <button
        onClick={() => setNotificationModalOpen(true)}
        className="w-full bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-4 text-left active:bg-gray-50 transition"
      >
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center">
              <span className="text-xl">ðŸ””</span>
            </div>
            <div>
              <p className="font-semibold text-gray-900">{t('Notifications')}</p>
              <p className="text-sm text-gray-500">{t('Manage your alerts')}</p>
            </div>
          </div>
          <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
          </svg>
        </div>
      </button>

      {/* Language Selector */}
      <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-4">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
              <span className="text-xl">ðŸŒ</span>
            </div>
            <div>
              <p className="font-semibold text-gray-900">{t('Language')}</p>
              <p className="text-sm text-gray-500">{t('Change your display language')}</p>
            </div>
          </div>
          <button
            onClick={() => setLangMenuOpen(!langMenuOpen)}
            className="flex items-center gap-2 px-3 py-2 rounded-xl bg-gray-100 active:bg-gray-200 transition"
          >
            <span className="text-sm font-medium text-gray-700">{currentLang.native}</span>
            <svg className={`w-4 h-4 text-gray-500 transition ${langMenuOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
            </svg>
          </button>
        </div>

        {/* Language dropdown */}
        {langMenuOpen && (
          <div className="mt-3 pt-3 border-t border-gray-100">
            <div className="grid grid-cols-2 gap-2">
              {SUPPORTED_LANGUAGES.map(lang => (
                <button
                  key={lang.code}
                  onClick={() => {
                    changeLanguage(lang.code);
                    setLangMenuOpen(false);
                  }}
                  className={`p-3 rounded-xl text-left transition ${
                    language === lang.code
                      ? 'bg-orange-50 border-2 border-goldin-orange'
                      : 'bg-gray-50 border-2 border-transparent hover:bg-gray-100'
                  }`}
                >
                  <p className="font-medium text-gray-900">{lang.native}</p>
                  <p className="text-xs text-gray-500">{lang.name}</p>
                </button>
              ))}
            </div>
          </div>
        )}
      </div>

      {/* My Profile */}
      {(myFellow || myTeamMember) ? (
        <button
          onClick={openProfileEditor}
          className="w-full bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-6 text-left active:bg-gray-50"
        >
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-goldin-orange/10 rounded-xl flex items-center justify-center">
                <span className="text-xl">ðŸ‘¤</span>
              </div>
              <div>
                <p className="font-semibold text-gray-900">My Profile</p>
                <p className="text-sm text-gray-500">
                  {profileType === 'team_member' ? 'Edit your staff profile' : 'Edit your profile'}
                </p>
              </div>
            </div>
            <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
            </svg>
          </div>
        </button>
      ) : isGoldinEmail ? (
        <button
          onClick={createStaffProfile}
          disabled={creatingProfile}
          className="w-full bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-6 text-left active:bg-gray-50"
        >
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center">
                <span className="text-xl">âž•</span>
              </div>
              <div>
                <p className="font-semibold text-gray-900">
                  {creatingProfile ? 'Creating...' : 'Create My Profile'}
                </p>
                <p className="text-sm text-gray-500">Add yourself to the directory</p>
              </div>
            </div>
            <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
            </svg>
          </div>
        </button>
      ) : (
        <div className="w-full bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-6 opacity-60">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center">
              <span className="text-xl">ðŸ‘¤</span>
            </div>
            <div>
              <p className="font-semibold text-gray-900">My Profile</p>
              <p className="text-sm text-gray-500">No linked profile found</p>
            </div>
          </div>
        </div>
      )}

      {/* Team Management - Admin only */}
      {canAccess(ROLES.ADMIN) && onNavigate && (
        <button
          onClick={() => onNavigate('team-management')}
          className="w-full bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-4 text-left active:bg-gray-50 transition"
        >
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-violet-100 rounded-xl flex items-center justify-center">
                <span className="text-xl">ðŸ‘¥</span>
              </div>
              <div>
                <p className="font-semibold text-gray-900">Team Management</p>
                <p className="text-sm text-gray-500">Manage staff accounts and permissions</p>
              </div>
            </div>
            <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
            </svg>
          </div>
        </button>
      )}

      {/* News Scan Reminder - Travis only */}
      {isTravis && showScanReminder && (
        <div className="bg-amber-50 rounded-2xl p-4 shadow-sm border border-amber-200 mb-4">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center">
              <span className="text-xl">ðŸ“°</span>
            </div>
            <div className="flex-1">
              <p className="font-semibold text-amber-900">Time to scan for news!</p>
              <p className="text-sm text-amber-700">
                {daysSinceLastScan() === 999
                  ? "You haven't scanned for fellow news yet"
                  : `It's been ${daysSinceLastScan()} days since your last scan`}
              </p>
            </div>
            <button
              onClick={() => setShowScanReminder(false)}
              className="text-amber-400 hover:text-amber-600 p-1"
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>
      )}

      {/* News Scanner - Staff */}
      {isStaff && (
        <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-6">
          <div className="flex items-center justify-between mb-3">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                <span className="text-xl">ðŸ”</span>
              </div>
              <div>
                <p className="font-semibold text-gray-900">News & Social Scanner</p>
                <p className="text-sm text-gray-500">
                  {isTravis ? `Find mentions across ${selectedPlatforms.length} platforms` : 'Find web mentions of fellows'}
                </p>
              </div>
            </div>
          </div>

          {/* Platform Selection (Collapsible) */}
          <div className="mb-4">
            <button
              onClick={() => setPlatformsExpanded(!platformsExpanded)}
              className="w-full flex items-center justify-between p-3 bg-gray-50 rounded-xl text-left"
            >
              <div className="flex items-center gap-2">
                <span className="text-sm font-medium text-gray-700">Sources to search:</span>
                <span className="text-xs px-2 py-0.5 bg-goldin-orange/10 text-goldin-orange rounded-full font-medium">
                  {selectedPlatforms.length} selected
                </span>
              </div>
              <svg className={`w-5 h-5 text-gray-400 transition ${platformsExpanded ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
              </svg>
            </button>

            {platformsExpanded && (
              <div className="mt-2 space-y-2">
                {platformOptions.map(platform => (
                  <label
                    key={platform.id}
                    className={`flex items-center justify-between p-3 rounded-xl border-2 cursor-pointer transition-all ${
                      scanPlatforms[platform.id]
                        ? 'bg-orange-50 border-orange-300'
                        : 'bg-white border-gray-200 hover:border-gray-300'
                    }`}
                  >
                    <div className="flex items-center gap-3">
                      <span className="text-xl">{platform.icon}</span>
                      <div>
                        <span className="font-medium text-gray-900">{platform.label}</span>
                        <p className="text-xs text-gray-500">{platform.description}</p>
                      </div>
                    </div>
                    <div className="relative">
                      <input
                        type="checkbox"
                        checked={scanPlatforms[platform.id]}
                        onChange={() => togglePlatform(platform.id)}
                        className="sr-only"
                      />
                      <div className={`w-10 h-6 rounded-full transition-colors ${
                        scanPlatforms[platform.id] ? 'bg-goldin-orange' : 'bg-gray-300'
                      }`}>
                        <div className={`absolute top-1 w-4 h-4 bg-white rounded-full shadow transition-transform ${
                          scanPlatforms[platform.id] ? 'translate-x-5' : 'translate-x-1'
                        }`} />
                      </div>
                    </div>
                  </label>
                ))}

                {/* API Usage Note */}
                <div className="bg-amber-50 border border-amber-200 rounded-xl p-3 text-sm mt-3">
                  <p className="text-amber-800">
                    <strong>API Usage:</strong> Each platform = 1 credit per fellow.
                    {isTravis && ` Full scan: ${fellows.length} Ã— ${selectedPlatforms.length} = ~${fellows.length * selectedPlatforms.length} credits.`}
                  </p>
                </div>
              </div>
            )}
          </div>

          {/* Custom Search Terms */}
          <div className="mb-4">
            <p className="text-sm font-semibold text-gray-700 mb-1">Custom Search Terms</p>
            <p className="text-xs text-gray-500 mb-3">Add organizational keywords to search alongside fellow names</p>

            {/* Term chips */}
            <div className="flex flex-wrap gap-2 mb-3">
              {loadingTerms ? (
                <span className="text-sm text-gray-400">Loading terms...</span>
              ) : customSearchTerms.length === 0 ? (
                <span className="text-sm text-gray-400">No custom terms added</span>
              ) : customSearchTerms.map(term => (
                <span key={term} className="inline-flex items-center gap-1 px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-sm">
                  {term}
                  {isAdmin && (
                    <button onClick={() => removeCustomTerm(term)} className="text-orange-400 hover:text-orange-600 ml-1">
                      &times;
                    </button>
                  )}
                </span>
              ))}
            </div>

            {/* Add new term (admin only) */}
            {isAdmin && (
              <div className="flex gap-2">
                <input
                  type="text"
                  value={newTermInput}
                  onChange={(e) => setNewTermInput(e.target.value)}
                  onKeyDown={(e) => { if (e.key === 'Enter') addCustomTerm(); }}
                  placeholder="Add a search term..."
                  className="flex-1 px-3 py-2 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none"
                />
                <button
                  onClick={addCustomTerm}
                  disabled={!newTermInput.trim()}
                  className="px-4 py-2 rounded-xl font-semibold text-sm transition"
                  style={{
                    backgroundColor: newTermInput.trim() ? '#E87722' : '#E5E7EB',
                    color: newTermInput.trim() ? '#FFFFFF' : '#6B7280'
                  }}
                >
                  Add
                </button>
              </div>
            )}
          </div>

          {/* Full scan button for all staff (Travis unlimited, others 3/day) */}
          <button
            onClick={() => scanForNews(true)}
            disabled={scanning || (!isTravis && !canScanMore) || selectedPlatforms.length === 0}
            className="w-full py-3 rounded-xl font-semibold transition"
            style={{
              backgroundColor: (scanning || (!isTravis && !canScanMore) || selectedPlatforms.length === 0) ? '#E5E7EB' : '#3B82F6',
              color: (scanning || (!isTravis && !canScanMore) || selectedPlatforms.length === 0) ? '#6B7280' : '#FFFFFF'
            }}
          >
            {selectedPlatforms.length === 0
              ? 'Select at least one platform'
              : !isTravis && !canScanMore
                ? 'Daily limit reached (3/3)'
                : scanning
                  ? `Scanning... ${scanResults?.scanned || 0}/${scanResults?.total || fellows.length}`
                  : `Scan All Fellows (${fellows.length} Ã— ${selectedPlatforms.length} platforms)${!isTravis ? ` - ${3 - dailyScanCount} left today` : ''}`}
          </button>

          {scanResults && (
            <div className={`mt-3 p-3 rounded-xl text-sm ${scanResults.inProgress ? 'bg-blue-50' : 'bg-green-50'}`}
                 style={{ color: scanResults.inProgress ? '#1E40AF' : '#166534' }}>
              {scanResults.inProgress
                ? `Scanning... ${scanResults.scanned}/${scanResults.total} fellows, ${scanResults.found} mentions found so far`
                : scanResults.error
                  ? `Error: ${scanResults.error}`
                  : `Done! Scanned ${scanResults.scanned} fellows across ${selectedPlatforms.length} platforms, found ${scanResults.found} new mentions`}
            </div>
          )}

          {isTravis && (
            <p className="text-xs text-gray-400 mt-2">Full scan may take 5-10 minutes depending on platforms selected</p>
          )}
        </div>
      )}

      {/* About */}
      <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-6">
        <h2 className="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3">About</h2>
        <div className="space-y-3">
          <div className="flex justify-between">
            <span className="text-gray-600">Version</span>
            <span className="text-gray-900 font-medium">2.1.0 (PWA)</span>
          </div>
          <div className="flex justify-between">
            <span className="text-gray-600">Organization</span>
            <span className="text-gray-900 font-medium">Goldin Institute</span>
          </div>
        </div>
      </div>

      {/* Sign Out */}
      <button
        onClick={handleLogout}
        className="w-full bg-red-50 text-red-600 font-semibold py-4 rounded-2xl"
      >
        Sign Out
      </button>

      {/* Profile Edit Modal */}
      {profileModalOpen && (
        <>
          <div
            className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50"
            onClick={() => setProfileModalOpen(false)}
          />
          <div className="fixed inset-x-0 bottom-0 bg-white rounded-t-3xl z-50 max-h-[90vh] overflow-auto">
            <div className="sticky top-0 bg-white border-b border-gray-100 px-4 py-3 flex items-center justify-between rounded-t-3xl">
              <button
                onClick={() => setProfileModalOpen(false)}
                className="text-gray-500 font-medium"
              >
                Cancel
              </button>
              <h2 className="font-bold text-gray-900">Edit Profile</h2>
              <button
                onClick={saveProfile}
                disabled={saving}
                className="text-goldin-orange font-semibold disabled:opacity-50"
              >
                {saving ? 'Saving...' : 'Save'}
              </button>
            </div>

            <div className="p-4 space-y-4 pb-8">
              {/* Name fields - read only for self-editing */}
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="text-sm font-medium text-gray-700 block mb-1">First Name</label>
                  <input
                    type="text"
                    value={editData.first_name}
                    disabled
                    className="w-full px-3 py-2 border border-gray-200 rounded-xl bg-gray-50 text-gray-500"
                  />
                </div>
                <div>
                  <label className="text-sm font-medium text-gray-700 block mb-1">Last Name</label>
                  <input
                    type="text"
                    value={editData.last_name}
                    disabled
                    className="w-full px-3 py-2 border border-gray-200 rounded-xl bg-gray-50 text-gray-500"
                  />
                </div>
              </div>

              {/* Email - read only for self-editing */}
              <div>
                <label className="text-sm font-medium text-gray-700 block mb-1">Email</label>
                <input
                  type="email"
                  value={editData.email}
                  disabled
                  className="w-full px-3 py-2 border border-gray-200 rounded-xl bg-gray-50 text-gray-500"
                />
                <p className="text-xs text-gray-400 mt-1">Contact an admin to change your email</p>
              </div>

              {/* Phone - editable */}
              <div>
                <label className="text-sm font-medium text-gray-700 block mb-1">Phone</label>
                <input
                  type="tel"
                  value={editData.phone || ''}
                  onChange={(e) => setEditData(d => ({...d, phone: e.target.value}))}
                  className="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-goldin-orange/30"
                />
              </div>

              {/* Team member specific fields */}
              {profileType === 'team_member' && (
                <>
                  <div>
                    <label className="text-sm font-medium text-gray-700 block mb-1">Job Title</label>
                    <input
                      type="text"
                      value={editData.title || ''}
                      onChange={(e) => setEditData(d => ({...d, title: e.target.value}))}
                      className="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-goldin-orange/30"
                    />
                  </div>

                  <div>
                    <label className="text-sm font-medium text-gray-700 block mb-1">Bio</label>
                    <textarea
                      value={editData.bio || ''}
                      onChange={(e) => setEditData(d => ({...d, bio: e.target.value}))}
                      rows={3}
                      className="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-goldin-orange/30 resize-none"
                    />
                  </div>

                  <div>
                    <label className="text-sm font-medium text-gray-700 block mb-1">LinkedIn URL</label>
                    <input
                      type="url"
                      value={editData.linkedin_url || ''}
                      onChange={(e) => setEditData(d => ({...d, linkedin_url: e.target.value}))}
                      placeholder="https://linkedin.com/in/..."
                      className="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-goldin-orange/30"
                    />
                  </div>
                </>
              )}

              {/* Fellow specific fields */}
              {profileType === 'fellow' && (
                <>
                  <div>
                    <label className="text-sm font-medium text-gray-700 block mb-1">Job Title</label>
                    <input
                      type="text"
                      value={editData.job_title || ''}
                      onChange={(e) => setEditData(d => ({...d, job_title: e.target.value}))}
                      className="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-goldin-orange/30"
                    />
                  </div>

                  <div>
                    <label className="text-sm font-medium text-gray-700 block mb-1">Organization</label>
                    <input
                      type="text"
                      value={editData.organization || ''}
                      onChange={(e) => setEditData(d => ({...d, organization: e.target.value}))}
                      className="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-goldin-orange/30"
                    />
                  </div>

                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="text-sm font-medium text-gray-700 block mb-1">City</label>
                      <input
                        type="text"
                        value={editData.city || ''}
                        onChange={(e) => setEditData(d => ({...d, city: e.target.value}))}
                        className="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-goldin-orange/30"
                      />
                    </div>
                    <div>
                      <label className="text-sm font-medium text-gray-700 block mb-1">Country</label>
                      <input
                        type="text"
                        value={editData.country || ''}
                        onChange={(e) => setEditData(d => ({...d, country: e.target.value}))}
                        className="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-goldin-orange/30"
                      />
                    </div>
                  </div>

                  <div>
                    <label className="text-sm font-medium text-gray-700 block mb-1">Biography</label>
                    <textarea
                      value={editData.biography || ''}
                      onChange={(e) => setEditData(d => ({...d, biography: e.target.value}))}
                      rows={3}
                      className="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-goldin-orange/30 resize-none"
                    />
                  </div>

                  <div>
                    <label className="text-sm font-medium text-gray-700 block mb-1">LinkedIn URL</label>
                    <input
                      type="url"
                      value={editData.linkedin || ''}
                      onChange={(e) => setEditData(d => ({...d, linkedin: e.target.value}))}
                      placeholder="https://linkedin.com/in/..."
                      className="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-goldin-orange/30"
                    />
                  </div>

                  <div>
                    <label className="text-sm font-medium text-gray-700 block mb-1">Website</label>
                    <input
                      type="url"
                      value={editData.website || ''}
                      onChange={(e) => setEditData(d => ({...d, website: e.target.value}))}
                      placeholder="https://..."
                      className="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-goldin-orange/30"
                    />
                  </div>

                  <div>
                    <label className="text-sm font-medium text-gray-700 block mb-1">Languages</label>
                    <input
                      type="text"
                      value={editData.languages || ''}
                      onChange={(e) => setEditData(d => ({...d, languages: e.target.value}))}
                      placeholder="English, Spanish, ..."
                      className="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-goldin-orange/30"
                    />
                  </div>
                </>
              )}
            </div>
          </div>
        </>
      )}

      {/* Notification Settings Modal - Fixed for mobile overflow */}
      {notificationModalOpen && (
        <>
          <div
            className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50"
            onClick={() => setNotificationModalOpen(false)}
          />
          <div className="fixed inset-x-0 bottom-0 bg-white rounded-t-3xl z-50 max-h-[90vh] overflow-auto">
            <div className="sticky top-0 bg-white border-b border-gray-100 px-4 py-3 flex items-center justify-between rounded-t-3xl">
              <button
                onClick={() => setNotificationModalOpen(false)}
                className="text-gray-500 font-medium"
              >
                {t('Cancel')}
              </button>
              <h2 className="font-bold text-gray-900">{t('Notifications')}</h2>
              <button
                onClick={async () => {
                  setSavingNotifications(true);
                  // Save to localStorage
                  localStorage.setItem('gatherNotificationSettings', JSON.stringify(notificationSettings));

                  // Request push permission if enabled
                  if (notificationSettings.pushEnabled && 'Notification' in window) {
                    const permission = await Notification.requestPermission();
                    if (permission !== 'granted') {
                      setNotificationSettings(s => ({ ...s, pushEnabled: false }));
                      alert('Push notifications were denied. You can enable them in browser settings.');
                    }
                  }

                  setSavingNotifications(false);
                  setNotificationModalOpen(false);
                }}
                disabled={savingNotifications || (!notificationSettings.pushEnabled && !notificationSettings.emailEnabled)}
                className="text-goldin-orange font-semibold disabled:opacity-50"
              >
                {savingNotifications ? 'Saving...' : t('Save')}
              </button>
            </div>

            <div className="p-4 pb-8">
              {/* Delivery Method - Fixed: flex-1 min-w-0 for proper shrinking */}
              <div className="mb-6">
                <h3 className="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">
                  Delivery Method
                </h3>
                <div className="flex gap-3">
                  <button
                    onClick={() => setNotificationSettings(s => ({ ...s, pushEnabled: !s.pushEnabled }))}
                    className={`flex-1 min-w-0 flex items-center justify-center gap-2 py-3 px-4 rounded-xl font-medium transition-all ${
                      notificationSettings.pushEnabled
                        ? 'bg-orange-50 text-orange-600 border-2 border-goldin-orange'
                        : 'bg-white text-gray-600 border-2 border-gray-200'
                    }`}
                  >
                    <svg className="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                    </svg>
                    <span className="truncate">Push</span>
                  </button>
                  <button
                    onClick={() => setNotificationSettings(s => ({ ...s, emailEnabled: !s.emailEnabled }))}
                    className={`flex-1 min-w-0 flex items-center justify-center gap-2 py-3 px-4 rounded-xl font-medium transition-all ${
                      notificationSettings.emailEnabled
                        ? 'bg-orange-50 text-orange-600 border-2 border-goldin-orange'
                        : 'bg-white text-gray-600 border-2 border-gray-200'
                    }`}
                  >
                    <svg className="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    <span className="truncate">Email</span>
                  </button>
                </div>
                {!notificationSettings.pushEnabled && !notificationSettings.emailEnabled && (
                  <p className="text-sm text-red-500 mt-2">Select at least one delivery method</p>
                )}
              </div>

              {/* Notification Types - Fixed: min-w-0 on text container, flex-shrink-0 on toggle */}
              <div className="mb-6">
                <h3 className="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">
                  What to Notify
                </h3>
                <div className="space-y-3">
                  {/* Daily Summary */}
                  <div
                    className={`flex items-center gap-3 p-4 rounded-xl border transition-all ${
                      notificationSettings.dailySummary
                        ? 'bg-orange-50 border-orange-200'
                        : 'bg-white border-gray-200'
                    }`}
                  >
                    <span className="text-2xl flex-shrink-0">ðŸ“Š</span>
                    <div className="flex-1 min-w-0">
                      <h4 className="font-semibold text-gray-900 truncate">{t('Daily Summary')}</h4>
                      <p className="text-sm text-gray-500 truncate">{t('Morning overview of your priorities')}</p>
                    </div>
                    <button
                      onClick={() => setNotificationSettings(s => ({ ...s, dailySummary: !s.dailySummary }))}
                      className={`relative w-12 h-7 rounded-full transition-colors flex-shrink-0 overflow-hidden ${
                        notificationSettings.dailySummary ? 'bg-orange-600 ring-2 ring-orange-600/30' : 'bg-gray-300'
                      }`}
                    >
                      <span
                        className={`absolute top-1 w-5 h-5 bg-white rounded-full shadow transition-transform ${
                          notificationSettings.dailySummary ? 'translate-x-4' : 'translate-x-1'
                        }`}
                      />
                    </button>
                  </div>

                  {/* Weekly Summary */}
                  <div
                    className={`flex items-center gap-3 p-4 rounded-xl border transition-all ${
                      notificationSettings.weeklySummary
                        ? 'bg-orange-50 border-orange-200'
                        : 'bg-white border-gray-200'
                    }`}
                  >
                    <span className="text-2xl flex-shrink-0">ðŸ“…</span>
                    <div className="flex-1 min-w-0">
                      <h4 className="font-semibold text-gray-900 truncate">Weekly Summary</h4>
                      <p className="text-sm text-gray-500 truncate">Week recap every Monday</p>
                    </div>
                    <button
                      onClick={() => setNotificationSettings(s => ({ ...s, weeklySummary: !s.weeklySummary }))}
                      className={`relative w-12 h-7 rounded-full transition-colors flex-shrink-0 overflow-hidden ${
                        notificationSettings.weeklySummary ? 'bg-orange-600 ring-2 ring-orange-600/30' : 'bg-gray-300'
                      }`}
                    >
                      <span
                        className={`absolute top-1 w-5 h-5 bg-white rounded-full shadow transition-transform ${
                          notificationSettings.weeklySummary ? 'translate-x-4' : 'translate-x-1'
                        }`}
                      />
                    </button>
                  </div>

                  {/* Team Activity */}
                  <div
                    className={`flex items-center gap-3 p-4 rounded-xl border transition-all ${
                      notificationSettings.teamActivity
                        ? 'bg-orange-50 border-orange-200'
                        : 'bg-white border-gray-200'
                    }`}
                  >
                    <span className="text-2xl flex-shrink-0">âš¡</span>
                    <div className="flex-1 min-w-0">
                      <h4 className="font-semibold text-gray-900 truncate">{t('Activity Alerts')}</h4>
                      <p className="text-sm text-gray-500 truncate">{t('When team members log interactions')}</p>
                    </div>
                    <button
                      onClick={() => setNotificationSettings(s => ({ ...s, teamActivity: !s.teamActivity }))}
                      className={`relative w-12 h-7 rounded-full transition-colors flex-shrink-0 overflow-hidden ${
                        notificationSettings.teamActivity ? 'bg-orange-600 ring-2 ring-orange-600/30' : 'bg-gray-300'
                      }`}
                    >
                      <span
                        className={`absolute top-1 w-5 h-5 bg-white rounded-full shadow transition-transform ${
                          notificationSettings.teamActivity ? 'translate-x-4' : 'translate-x-1'
                        }`}
                      />
                    </button>
                  </div>

                  {/* Overdue Alerts */}
                  <div
                    className={`flex items-center gap-3 p-4 rounded-xl border transition-all ${
                      notificationSettings.overdueAlerts
                        ? 'bg-orange-50 border-orange-200'
                        : 'bg-white border-gray-200'
                    }`}
                  >
                    <span className="text-2xl flex-shrink-0">ðŸ”´</span>
                    <div className="flex-1 min-w-0">
                      <h4 className="font-semibold text-gray-900 truncate">{t('Overdue Alerts')}</h4>
                      <p className="text-sm text-gray-500 truncate">{t('When follow-ups become overdue')}</p>
                    </div>
                    <button
                      onClick={() => setNotificationSettings(s => ({ ...s, overdueAlerts: !s.overdueAlerts }))}
                      className={`relative w-12 h-7 rounded-full transition-colors flex-shrink-0 overflow-hidden ${
                        notificationSettings.overdueAlerts ? 'bg-orange-600 ring-2 ring-orange-600/30' : 'bg-gray-300'
                      }`}
                    >
                      <span
                        className={`absolute top-1 w-5 h-5 bg-white rounded-full shadow transition-transform ${
                          notificationSettings.overdueAlerts ? 'translate-x-4' : 'translate-x-1'
                        }`}
                      />
                    </button>
                  </div>

                  {/* News Mentions */}
                  <div
                    className={`flex items-center gap-3 p-4 rounded-xl border transition-all ${
                      notificationSettings.newsMentions
                        ? 'bg-orange-50 border-orange-200'
                        : 'bg-white border-gray-200'
                    }`}
                  >
                    <span className="text-2xl flex-shrink-0">ðŸ“°</span>
                    <div className="flex-1 min-w-0">
                      <h4 className="font-semibold text-gray-900 truncate">{t('News Mentions')}</h4>
                      <p className="text-sm text-gray-500 truncate">{t('When fellows appear in the news')}</p>
                    </div>
                    <button
                      onClick={() => setNotificationSettings(s => ({ ...s, newsMentions: !s.newsMentions }))}
                      className={`relative w-12 h-7 rounded-full transition-colors flex-shrink-0 overflow-hidden ${
                        notificationSettings.newsMentions ? 'bg-orange-600 ring-2 ring-orange-600/30' : 'bg-gray-300'
                      }`}
                    >
                      <span
                        className={`absolute top-1 w-5 h-5 bg-white rounded-full shadow transition-transform ${
                          notificationSettings.newsMentions ? 'translate-x-4' : 'translate-x-1'
                        }`}
                      />
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </>
      )}
    </div>
  );
}

// ============================================
// TEAM MANAGEMENT PAGE
// ============================================
function TeamManagementPage({ onBack }) {
  const { teamMembers, fellows, userRole, canAccess, fetchData } = useContext(AppContext);
  const [modalOpen, setModalOpen] = useState(false);
  const [editingMember, setEditingMember] = useState(null);
  const [formData, setFormData] = useState({
    email: '',
    first_name: '',
    last_name: '',
    title: '',
    role: 'team',
    phone: '',
    bio: '',
  });
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState('');
  const [pendingClaims, setPendingClaims] = useState([]);
  const [processingClaim, setProcessingClaim] = useState(null);

  // Fetch pending claims
  useEffect(() => {
    const fetchClaims = async () => {
      const { data } = await supabase
        .from('profile_claim_requests')
        .select('*')
        .eq('status', 'pending')
        .order('created_at', { ascending: false });
      setPendingClaims(data || []);
    };
    fetchClaims();
  }, []);

  // Get target profile info for a claim
  const getClaimTarget = (claim) => {
    if (claim.target_type === 'fellow') {
      return fellows?.find(f => f.id === claim.target_id);
    } else {
      return teamMembers?.find(tm => tm.id === claim.target_id);
    }
  };

  // Approve a claim
  const approveClaim = async (claim) => {
    setProcessingClaim(claim.id);
    const target = getClaimTarget(claim);
    if (!target) {
      alert('Target profile not found');
      setProcessingClaim(null);
      return;
    }

    // Add requesting email to alternate_emails and link user_id
    const table = claim.target_type === 'fellow' ? 'fellows' : 'team_members';
    const currentAlternates = target.alternate_emails || [];
    const newAlternates = [...currentAlternates, claim.requesting_email.toLowerCase()];

    const { error: updateError } = await supabase
      .from(table)
      .update({
        alternate_emails: newAlternates,
        user_id: claim.requesting_user_id,
      })
      .eq('id', claim.target_id);

    if (updateError) {
      alert('Error updating profile: ' + updateError.message);
      setProcessingClaim(null);
      return;
    }

    // Mark claim as approved
    await supabase
      .from('profile_claim_requests')
      .update({ status: 'approved', reviewed_at: new Date().toISOString() })
      .eq('id', claim.id);

    // Remove from pending list
    setPendingClaims(claims => claims.filter(c => c.id !== claim.id));
    setProcessingClaim(null);
    fetchData(); // Refresh data
  };

  // Reject a claim
  const rejectClaim = async (claim) => {
    setProcessingClaim(claim.id);
    await supabase
      .from('profile_claim_requests')
      .update({ status: 'rejected', reviewed_at: new Date().toISOString() })
      .eq('id', claim.id);

    setPendingClaims(claims => claims.filter(c => c.id !== claim.id));
    setProcessingClaim(null);
  };

  const isAdmin = canAccess(ROLES.ADMIN);
  const isSuperAdmin = userRole === ROLES.SUPER_ADMIN;

  // Role options based on current user's role
  const roleOptions = useMemo(() => {
    const options = [
      { value: 'team', label: 'Team', description: 'Basic staff access' },
      { value: 'manager', label: 'Manager', description: 'Can assign tasks to others' },
      { value: 'admin', label: 'Admin', description: 'Full access except super admin settings' },
    ];
    if (isSuperAdmin) {
      options.push({ value: 'super_admin', label: 'Super Admin', description: 'Full access to everything' });
    }
    return options;
  }, [isSuperAdmin]);

  // Role badge colors
  const getRoleBadge = (role) => {
    switch (role) {
      case 'super_admin': return { label: 'Super Admin', bg: 'bg-violet-500', text: 'text-violet-700' };
      case 'admin': return { label: 'Admin', bg: 'bg-blue-500', text: 'text-blue-700' };
      case 'manager': return { label: 'Manager', bg: 'bg-teal-500', text: 'text-teal-700' };
      default: return { label: 'Team', bg: 'bg-gray-400', text: 'text-gray-600' };
    }
  };

  const openAddModal = () => {
    setEditingMember(null);
    setFormData({
      email: '',
      first_name: '',
      last_name: '',
      title: '',
      role: 'team',
      phone: '',
      bio: '',
    });
    setError('');
    setModalOpen(true);
  };

  const openEditModal = (member) => {
    setEditingMember(member);
    setFormData({
      email: member.email,
      first_name: member.first_name,
      last_name: member.last_name,
      title: member.title || '',
      role: member.role,
      phone: member.phone || '',
      bio: member.bio || '',
    });
    setError('');
    setModalOpen(true);
  };

  const handleSave = async () => {
    if (!formData.email || !formData.first_name || !formData.last_name) {
      setError('Email, first name, and last name are required');
      return;
    }

    setSaving(true);
    setError('');

    try {
      if (editingMember) {
        // Update existing member
        const { error: updateError } = await supabase
          .from('team_members')
          .update({
            first_name: formData.first_name,
            last_name: formData.last_name,
            title: formData.title || null,
            role: formData.role,
            phone: formData.phone || null,
            bio: formData.bio || null,
            updated_at: new Date().toISOString(),
          })
          .eq('id', editingMember.id);

        if (updateError) throw updateError;
      } else {
        // Create new member
        const { error: insertError } = await supabase
          .from('team_members')
          .insert({
            email: formData.email.toLowerCase(),
            first_name: formData.first_name,
            last_name: formData.last_name,
            title: formData.title || null,
            role: formData.role,
            phone: formData.phone || null,
            bio: formData.bio || null,
          });

        if (insertError) throw insertError;
      }

      await fetchData();
      setModalOpen(false);
    } catch (err) {
      console.error('Save error:', err);
      setError(err.message || 'Failed to save team member');
    }

    setSaving(false);
  };

  const handleDeactivate = async (member) => {
    if (!confirm(`Deactivate ${member.first_name} ${member.last_name}? They will be removed from the directory.`)) {
      return;
    }

    try {
      await supabase
        .from('team_members')
        .update({ is_active: false, updated_at: new Date().toISOString() })
        .eq('id', member.id);
      await fetchData();
    } catch (err) {
      console.error('Deactivate error:', err);
      alert('Failed to deactivate member');
    }
  };

  const isGoldinEmail = (email) => {
    return email?.toLowerCase().endsWith('@goldininstitute.org') ||
           email?.toLowerCase().endsWith('@chicagopeacefellows.org');
  };

  if (!isAdmin) {
    return (
      <div className="p-4 text-center">
        <p className="text-gray-500">You don't have permission to access this page.</p>
        <button onClick={onBack} className="mt-4 text-goldin-orange font-medium">Go Back</button>
      </div>
    );
  }

  return (
    <div className="p-4 pb-24">
      {/* Header */}
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-3">
          <button onClick={onBack} className="p-2 -ml-2 rounded-xl hover:bg-gray-100">
            <svg className="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
            </svg>
          </button>
          <h1 className="text-2xl font-bold text-gray-900">Team Management</h1>
        </div>
        <button
          onClick={openAddModal}
          className="flex items-center gap-2 px-4 py-2 bg-goldin-orange text-white rounded-xl font-semibold hover:bg-goldin-orange-dark transition"
        >
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
          </svg>
          Add
        </button>
      </div>

      {/* Pending Profile Claims */}
      {pendingClaims.length > 0 && (
        <div className="mb-6">
          <h2 className="text-sm font-semibold text-amber-600 uppercase tracking-wide mb-3 flex items-center gap-2">
            <span>â³</span> Pending Profile Claims ({pendingClaims.length})
          </h2>
          <div className="space-y-3">
            {pendingClaims.map(claim => {
              const target = getClaimTarget(claim);
              const timeAgo = claim.created_at
                ? Math.floor((Date.now() - new Date(claim.created_at)) / (1000 * 60 * 60))
                : 0;
              const timeLabel = timeAgo < 1 ? 'Just now' : timeAgo < 24 ? `${timeAgo}h ago` : `${Math.floor(timeAgo / 24)}d ago`;

              return (
                <div key={claim.id} className="bg-amber-50 rounded-2xl p-4 border border-amber-200">
                  <div className="flex items-start gap-3">
                    <div className="w-10 h-10 rounded-full bg-amber-200 flex items-center justify-center flex-shrink-0">
                      <span className="text-lg">â³</span>
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="font-semibold text-gray-900">{claim.requesting_email}</p>
                      <p className="text-sm text-gray-600">
                        wants to claim: {target ? `${target.first_name} ${target.last_name}` : 'Unknown profile'}
                        {target?.program && ` (${target.program})`}
                        {target?.title && ` - ${target.title}`}
                      </p>
                      {target?.email && (
                        <p className="text-xs text-gray-500">Original email: {target.email}</p>
                      )}
                      <p className="text-xs text-gray-400 mt-1">Requested: {timeLabel}</p>
                    </div>
                  </div>
                  <div className="flex gap-2 mt-3 pt-3 border-t border-amber-200">
                    <button
                      onClick={() => approveClaim(claim)}
                      disabled={processingClaim === claim.id}
                      className="flex-1 py-2 bg-green-500 text-white rounded-xl font-semibold text-sm disabled:opacity-50"
                    >
                      {processingClaim === claim.id ? '...' : 'âœ“ Approve'}
                    </button>
                    <button
                      onClick={() => rejectClaim(claim)}
                      disabled={processingClaim === claim.id}
                      className="flex-1 py-2 bg-red-500 text-white rounded-xl font-semibold text-sm disabled:opacity-50"
                    >
                      {processingClaim === claim.id ? '...' : 'âœ• Reject'}
                    </button>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      )}

      {/* Team Member List */}
      <div className="space-y-3">
        {(teamMembers || []).map(member => {
          const roleBadge = getRoleBadge(member.role);
          const hasLoggedIn = !!member.user_id;
          const needsMagicLink = !isGoldinEmail(member.email);

          return (
            <button
              key={member.id}
              onClick={() => openEditModal(member)}
              className="w-full bg-white rounded-2xl p-4 shadow-sm border border-gray-100 text-left active:bg-gray-50 transition"
            >
              <div className="flex items-start gap-3">
                {/* Avatar */}
                <div className="w-12 h-12 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
                  {member.photo_url ? (
                    <img src={member.photo_url} alt="" className="w-full h-full object-cover" />
                  ) : (
                    <div className="w-full h-full flex items-center justify-center text-gray-400 font-semibold">
                      {member.first_name?.[0]}{member.last_name?.[0]}
                    </div>
                  )}
                </div>

                {/* Info */}
                <div className="flex-1 min-w-0">
                  <p className="font-semibold text-gray-900 truncate">
                    {member.first_name} {member.last_name}
                  </p>
                  <p className="text-sm text-gray-500 truncate">{member.title || 'Staff'}</p>
                  <p className="text-xs text-gray-400 truncate">{member.email}</p>
                </div>

                {/* Status & Role */}
                <div className="flex flex-col items-end gap-1 flex-shrink-0">
                  <span className={`text-xs px-2 py-0.5 rounded-full ${roleBadge.bg} text-white font-medium`}>
                    {roleBadge.label}
                  </span>
                  <div className="flex items-center gap-1 text-xs">
                    {hasLoggedIn ? (
                      <span className="text-green-600 flex items-center gap-1">
                        <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                        Active
                      </span>
                    ) : (
                      <span className="text-gray-400 flex items-center gap-1">
                        <span className="w-2 h-2 bg-gray-300 rounded-full"></span>
                        Pending
                      </span>
                    )}
                  </div>
                  {!hasLoggedIn && needsMagicLink && (
                    <span className="text-xs text-amber-600 flex items-center gap-1">
                      âš ï¸ Magic link
                    </span>
                  )}
                </div>
              </div>
            </button>
          );
        })}

        {(!teamMembers || teamMembers.length === 0) && (
          <div className="text-center py-12">
            <p className="text-gray-400 text-lg">No team members yet</p>
            <p className="text-gray-400 text-sm mt-1">Add your first team member above</p>
          </div>
        )}
      </div>

      {/* Add/Edit Modal */}
      {modalOpen && (
        <>
          <div
            className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50"
            onClick={() => setModalOpen(false)}
          />
          <div className="fixed inset-x-0 bottom-0 bg-white rounded-t-3xl z-50 max-h-[90vh] overflow-auto">
            <div className="sticky top-0 bg-white border-b border-gray-100 px-4 py-3 flex items-center justify-between rounded-t-3xl">
              <button
                onClick={() => setModalOpen(false)}
                className="text-gray-500 font-medium"
              >
                Cancel
              </button>
              <h2 className="font-bold text-gray-900">
                {editingMember ? 'Edit Team Member' : 'Add Team Member'}
              </h2>
              <button
                onClick={handleSave}
                disabled={saving}
                className="text-goldin-orange font-semibold disabled:opacity-50"
              >
                {saving ? 'Saving...' : 'Save'}
              </button>
            </div>

            <div className="p-4 pb-8 space-y-4">
              {error && (
                <div className="bg-red-50 border border-red-200 rounded-xl p-3 text-sm text-red-700">
                  {error}
                </div>
              )}

              {/* Email */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                <input
                  type="email"
                  value={formData.email}
                  onChange={(e) => setFormData(d => ({ ...d, email: e.target.value }))}
                  disabled={!!editingMember}
                  className="w-full px-4 py-3 bg-gray-100 rounded-xl text-gray-900 disabled:opacity-60"
                  placeholder="jane@goldininstitute.org"
                />
                {!editingMember && formData.email && !isGoldinEmail(formData.email) && (
                  <p className="text-xs text-amber-600 mt-1">
                    âš ï¸ Non-Goldin emails require magic link for login
                  </p>
                )}
                {!editingMember && formData.email && isGoldinEmail(formData.email) && (
                  <p className="text-xs text-green-600 mt-1">
                    âœ“ Can use Google sign-in
                  </p>
                )}
              </div>

              {/* Name */}
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                  <input
                    type="text"
                    value={formData.first_name}
                    onChange={(e) => setFormData(d => ({ ...d, first_name: e.target.value }))}
                    className="w-full px-4 py-3 bg-gray-100 rounded-xl text-gray-900"
                    placeholder="Jane"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                  <input
                    type="text"
                    value={formData.last_name}
                    onChange={(e) => setFormData(d => ({ ...d, last_name: e.target.value }))}
                    className="w-full px-4 py-3 bg-gray-100 rounded-xl text-gray-900"
                    placeholder="Smith"
                  />
                </div>
              </div>

              {/* Title */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Title</label>
                <input
                  type="text"
                  value={formData.title}
                  onChange={(e) => setFormData(d => ({ ...d, title: e.target.value }))}
                  className="w-full px-4 py-3 bg-gray-100 rounded-xl text-gray-900"
                  placeholder="Program Manager"
                />
              </div>

              {/* Role */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Role</label>
                <select
                  value={formData.role}
                  onChange={(e) => setFormData(d => ({ ...d, role: e.target.value }))}
                  className="w-full px-4 py-3 bg-gray-100 rounded-xl text-gray-900"
                >
                  {roleOptions.map(opt => (
                    <option key={opt.value} value={opt.value}>{opt.label}</option>
                  ))}
                </select>
                <p className="text-xs text-gray-500 mt-1">
                  {roleOptions.find(o => o.value === formData.role)?.description}
                </p>
              </div>

              {/* Phone */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                <input
                  type="tel"
                  value={formData.phone}
                  onChange={(e) => setFormData(d => ({ ...d, phone: e.target.value }))}
                  className="w-full px-4 py-3 bg-gray-100 rounded-xl text-gray-900"
                  placeholder="+1 (555) 123-4567"
                />
              </div>

              {/* Bio */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Bio</label>
                <textarea
                  value={formData.bio}
                  onChange={(e) => setFormData(d => ({ ...d, bio: e.target.value }))}
                  rows={3}
                  className="w-full px-4 py-3 bg-gray-100 rounded-xl text-gray-900 resize-none"
                  placeholder="Brief bio..."
                />
              </div>

              {/* Deactivate option for existing members */}
              {editingMember && (
                <div className="pt-4 border-t border-gray-200">
                  <button
                    onClick={() => {
                      setModalOpen(false);
                      handleDeactivate(editingMember);
                    }}
                    className="w-full py-3 text-red-500 font-medium rounded-xl border border-red-200 hover:bg-red-50 transition"
                  >
                    Deactivate Team Member
                  </button>
                </div>
              )}
            </div>
          </div>
        </>
      )}
    </div>
  );
}

// ============================================
// STREAM ACTIVITY ITEM COMPONENT
// ============================================
function StreamActivityItem({ activity }) {
  const formatTime = (time) => {
    if (!time) return '';
    const date = new Date(time);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  };

  const getActivityIcon = (verb) => {
    switch (verb) {
      case 'announcement': return 'ðŸ“¢';
      case 'resource': return 'ðŸ“„';
      case 'post': return 'ðŸ’¬';
      case 'join': return 'ðŸ‘‹';
      default: return 'ðŸ“Œ';
    }
  };

  return (
    <div className="bg-white rounded-xl p-4 border border-gray-200 activity-item">
      <div className="flex items-start gap-3">
        <div className="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-lg">
          {activity.actor?.data?.image ? (
            <img
              src={activity.actor.data.image}
              alt=""
              className="w-10 h-10 rounded-full object-cover"
            />
          ) : (
            getActivityIcon(activity.verb)
          )}
        </div>
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2">
            <span className="font-medium text-gray-900">
              {activity.actor?.data?.name || 'GATHER'}
            </span>
            <span className="text-xs text-gray-400">
              {formatTime(activity.time)}
            </span>
          </div>
          {activity.object?.data?.title && (
            <h4 className="font-semibold text-gray-900 mt-1">
              {activity.object.data.title}
            </h4>
          )}
          <p className="text-gray-600 mt-1 line-clamp-3">
            {activity.object?.data?.content || activity.message || ''}
          </p>
        </div>
      </div>
    </div>
  );
}

// ============================================
// ACTIVITY FEED SECTION COMPONENT
// ============================================
function ActivityFeedSection() {
  const { user } = useContext(AppContext);
  const { activities, loading, error, hasMore, initialize, loadMore, refresh } = useStreamFeed();
  const [initialized, setInitialized] = useState(false);

  useEffect(() => {
    if (user && user.email !== 'guest@gathertracker.app' && !initialized) {
      initialize();
      setInitialized(true);
    }
  }, [user, initialized, initialize]);

  if (!user || user.email === 'guest@gathertracker.app') {
    return (
      <div className="text-center py-12">
        <p className="text-4xl mb-3">ðŸ”</p>
        <p className="text-gray-600">Sign in to see network activity</p>
      </div>
    );
  }

  if (loading && activities.length === 0) {
    return (
      <div className="text-center py-8 text-gray-500">
        Loading activity feed...
      </div>
    );
  }

  if (error) {
    return (
      <div className="text-center py-8">
        <p className="text-gray-500 mb-3">Could not load activity feed</p>
        <button
          onClick={refresh}
          className="text-orange-500 font-medium"
        >
          Try again
        </button>
      </div>
    );
  }

  if (activities.length === 0) {
    return (
      <div className="text-center py-8 text-gray-500">
        <p className="text-4xl mb-2">ðŸŒ±</p>
        <p>No activity yet</p>
        <p className="text-sm mt-1">Check back soon for network updates</p>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {activities.map(activity => (
        <StreamActivityItem key={activity.id} activity={activity} />
      ))}
      {hasMore && (
        <button
          onClick={loadMore}
          className="w-full py-3 text-orange-500 font-medium"
        >
          Load more
        </button>
      )}
    </div>
  );
}

// ============================================
// COMMUNITY PAGE
// ============================================
function CommunityPage() {
  const { user, canAccess, t } = useContext(AppContext);
  const isGuest = !user || user.email === 'guest@gathertracker.app';

  // Tab state
  const [activeTab, setActiveTab] = useState('announcements');

  // Announcements state
  const [announcements, setAnnouncements] = useState([]);
  const [loadingAnnouncements, setLoadingAnnouncements] = useState(true);
  const [announcementsError, setAnnouncementsError] = useState(null);

  // Fetch announcements
  useEffect(() => {
    const fetchAnnouncements = async () => {
      setLoadingAnnouncements(true);
      setAnnouncementsError(null);
      try {
        const { data, error } = await supabase
          .from('announcements')
          .select('*')
          .lte('published_at', new Date().toISOString())
          .order('is_pinned', { ascending: false })
          .order('published_at', { ascending: false });

        if (error) {
          console.error('Error fetching announcements:', error);
          setAnnouncementsError(error.message);
        } else {
          setAnnouncements(data || []);
        }
      } catch (err) {
        console.error('Exception fetching announcements:', err);
        setAnnouncementsError(err.message);
      }
      setLoadingAnnouncements(false);
    };
    fetchAnnouncements();
  }, []);

  const formatDate = (dateStr) => {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  };

  const tabs = [
    { id: 'announcements', label: 'Announcements' },
    { id: 'activity', label: 'Activity', requiresAuth: true },
  ];

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Tabs */}
      <div className="bg-white border-b border-gray-200 sticky top-0 z-10">
        <div className="flex">
          {tabs.map(tab => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`flex-1 py-3 text-sm font-medium border-b-2 transition-colors ${
                activeTab === tab.id
                  ? 'text-orange-500 border-orange-500'
                  : 'text-gray-500 border-transparent hover:text-gray-700'
              } ${tab.requiresAuth && isGuest ? 'opacity-50' : ''}`}
            >
              {t(tab.label)}
              {tab.requiresAuth && isGuest && (
                <span className="ml-1 text-xs">ðŸ”’</span>
              )}
            </button>
          ))}
        </div>
      </div>

      <div className="p-4">
        {activeTab === 'announcements' ? (
          <div className="space-y-4">
            {/* Announcements List */}
            {loadingAnnouncements ? (
              <div className="text-center py-8 text-gray-500">Loading announcements...</div>
            ) : announcementsError ? (
              <div className="text-center py-8 text-gray-500">
                <p className="text-4xl mb-2">âš ï¸</p>
                <p>Could not load announcements</p>
                <p className="text-sm text-gray-400 mt-1">{announcementsError}</p>
              </div>
            ) : announcements.length === 0 ? (
              <div className="text-center py-8 text-gray-500">
                <p className="text-4xl mb-2">ðŸ“¢</p>
                <p>No announcements yet</p>
              </div>
            ) : (
              announcements.map(announcement => (
                <div
                  key={announcement.id}
                  className={`bg-white rounded-xl p-4 border ${
                    announcement.is_pinned ? 'border-orange-300 bg-orange-50' : 'border-gray-200'
                  }`}
                >
                  <div className="flex items-start gap-2">
                    {announcement.is_pinned && (
                      <span className="text-orange-500">ðŸ“Œ</span>
                    )}
                    <div className="flex-1">
                      <h3 className="font-semibold text-gray-900"><T>{announcement.title}</T></h3>
                      <p className="text-gray-600 mt-1 whitespace-pre-wrap"><T>{announcement.content}</T></p>
                      <p className="text-xs text-gray-400 mt-2">{formatDate(announcement.published_at)}</p>
                    </div>
                  </div>
                </div>
              ))
            )}
          </div>
        ) : (
          <ActivityFeedSection />
        )}
      </div>
    </div>
  );
}

// ============================================
// LIBRARY PAGE (Resources)
// ============================================
function LibraryPage() {
  const { user, canAccess } = useContext(AppContext);
  const isStaff = canAccess(ROLES.TEAM);

  const [resources, setResources] = useState([]);
  const [loadingResources, setLoadingResources] = useState(true);
  const [resourceFilter, setResourceFilter] = useState('all');
  const [showNewResource, setShowNewResource] = useState(false);
  const [newResource, setNewResource] = useState({ title: '', description: '', url: '', category: 'link' });
  const [savingResource, setSavingResource] = useState(false);

  useEffect(() => {
    const fetchResources = async () => {
      setLoadingResources(true);
      const { data, error } = await supabase
        .from('resources')
        .select('*')
        .order('created_at', { ascending: false });

      if (!error && data) {
        setResources(data);
      }
      setLoadingResources(false);
    };
    fetchResources();
  }, []);

  const handleCreateResource = async () => {
    if (!newResource.title.trim() || !newResource.url.trim()) return;
    setSavingResource(true);

    const { data, error } = await supabase
      .from('resources')
      .insert({
        title: newResource.title,
        description: newResource.description,
        url: newResource.url,
        category: newResource.category,
        uploaded_by: user?.id,
      })
      .select()
      .single();

    if (!error && data) {
      setResources(prev => [data, ...prev]);
      setNewResource({ title: '', description: '', url: '', category: 'link' });
      setShowNewResource(false);
    } else {
      alert('Error creating resource: ' + (error?.message || 'Unknown error'));
    }
    setSavingResource(false);
  };

  const filteredResources = resourceFilter === 'all'
    ? resources
    : resources.filter(r => r.category === resourceFilter);

  const resourceCategories = [
    { id: 'all', label: 'All', icon: 'ðŸ“' },
    { id: 'document', label: 'Docs', icon: 'ðŸ“„' },
    { id: 'link', label: 'Links', icon: 'ðŸ”—' },
    { id: 'video', label: 'Videos', icon: 'ðŸŽ¬' },
    { id: 'template', label: 'Templates', icon: 'ðŸ“‹' },
  ];

  return (
    <div className="min-h-screen bg-gray-50 p-4">
      <div className="space-y-4">
        {/* Category Filter */}
        <div className="flex gap-2 overflow-x-auto pb-2">
          {resourceCategories.map(cat => (
            <button
              key={cat.id}
              onClick={() => setResourceFilter(cat.id)}
              className={`flex items-center gap-1 px-3 py-2 rounded-full text-sm whitespace-nowrap transition ${
                resourceFilter === cat.id
                  ? 'bg-orange-500 text-white'
                  : 'bg-white text-gray-600 border border-gray-200'
              }`}
            >
              <span>{cat.icon}</span>
              <span>{cat.label}</span>
            </button>
          ))}
        </div>

        {/* New Resource Button (Staff only) */}
        {isStaff && !showNewResource && (
          <button
            onClick={() => setShowNewResource(true)}
            className="w-full py-3 bg-orange-500 text-white rounded-xl font-semibold"
          >
            + Add Resource
          </button>
        )}

        {/* New Resource Form */}
        {isStaff && showNewResource && (
          <div className="bg-white rounded-xl p-4 border border-gray-200 space-y-3">
            <input
              type="text"
              placeholder="Resource title..."
              value={newResource.title}
              onChange={(e) => setNewResource(prev => ({ ...prev, title: e.target.value }))}
              className="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-orange-500"
            />
            <input
              type="url"
              placeholder="URL (https://...)"
              value={newResource.url}
              onChange={(e) => setNewResource(prev => ({ ...prev, url: e.target.value }))}
              className="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-orange-500"
            />
            <textarea
              placeholder="Description (optional)"
              value={newResource.description}
              onChange={(e) => setNewResource(prev => ({ ...prev, description: e.target.value }))}
              rows={2}
              className="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-orange-500 resize-none"
            />
            <select
              value={newResource.category}
              onChange={(e) => setNewResource(prev => ({ ...prev, category: e.target.value }))}
              className="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-orange-500"
            >
              <option value="link">ðŸ”— Link</option>
              <option value="document">ðŸ“„ Document</option>
              <option value="video">ðŸŽ¬ Video</option>
              <option value="template">ðŸ“‹ Template</option>
            </select>
            <div className="flex gap-2">
              <button
                onClick={() => setShowNewResource(false)}
                className="flex-1 py-2 border border-gray-200 rounded-lg text-gray-600"
              >
                Cancel
              </button>
              <button
                onClick={handleCreateResource}
                disabled={savingResource || !newResource.title.trim() || !newResource.url.trim()}
                className="flex-1 py-2 bg-orange-500 text-white rounded-lg font-semibold disabled:opacity-50"
              >
                {savingResource ? 'Adding...' : 'Add'}
              </button>
            </div>
          </div>
        )}

        {/* Resources List */}
        {loadingResources ? (
          <div className="text-center py-8 text-gray-500">Loading resources...</div>
        ) : filteredResources.length === 0 ? (
          <div className="text-center py-8 text-gray-500">
            <p className="text-4xl mb-2">ðŸ“š</p>
            <p>No resources yet</p>
          </div>
        ) : (
          filteredResources.map(resource => (
            <a
              key={resource.id}
              href={resource.url}
              target="_blank"
              rel="noopener noreferrer"
              className="block bg-white rounded-xl p-4 border border-gray-200 hover:border-orange-300 transition"
            >
              <div className="flex items-start gap-3">
                <span className="text-2xl">
                  {resource.category === 'document' ? 'ðŸ“„' :
                   resource.category === 'video' ? 'ðŸŽ¬' :
                   resource.category === 'template' ? 'ðŸ“‹' : 'ðŸ”—'}
                </span>
                <div className="flex-1 min-w-0">
                  <h3 className="font-semibold text-gray-900">{resource.title}</h3>
                  {resource.description && (
                    <p className="text-sm text-gray-600 mt-1">{resource.description}</p>
                  )}
                  <p className="text-xs text-gray-400 mt-2 truncate">{resource.url}</p>
                </div>
                <svg className="w-5 h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
              </div>
            </a>
          ))
        )}
      </div>
    </div>
  );
}

// ============================================
// LOG INTERACTION MODAL
// ============================================
function LogInteractionModal({ isOpen, onClose, preSelectedFellow }) {
  const { fellows, fetchData, user } = useContext(AppContext);
  const [step, setStep] = useState(1); // 1: select fellow, 2: form
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedFellow, setSelectedFellow] = useState(null);
  const [formData, setFormData] = useState({
    interaction_type: 'Call',
    subject: '',
    notes: '',
  });
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [success, setSuccess] = useState(false);

  // Handle pre-selected fellow
  useEffect(() => {
    if (isOpen && preSelectedFellow) {
      setSelectedFellow(preSelectedFellow);
      setStep(2);
    }
  }, [isOpen, preSelectedFellow]);

  const filteredFellows = useMemo(() => {
    if (!searchTerm) return fellows.slice(0, 20);
    const term = searchTerm.toLowerCase();
    return fellows.filter(f => 
      `${f.first_name} ${f.last_name}`.toLowerCase().includes(term) ||
      f.organization?.toLowerCase().includes(term)
    ).slice(0, 20);
  }, [fellows, searchTerm]);

  const handleSubmit = async () => {
    if (!selectedFellow) return;
    setIsSubmitting(true);

    try {
      const interaction = {
        fellow_id: selectedFellow.id,
        interaction_type: formData.interaction_type,
        subject: formData.subject || null,
        notes: formData.notes || null,
        staff_email: user?.email || 'unknown@goldininstitute.org',
        created_at: new Date().toISOString(),
      };

      const { error } = await supabase.from('interactions').insert(interaction);

      if (!error) {
        await supabase.from('fellows')
          .update({ last_contact: new Date().toISOString() })
          .eq('id', selectedFellow.id);

        setSuccess(true);
        setTimeout(() => {
          fetchData();
          onClose();
          // Reset state
          setStep(1);
          setSearchTerm('');
          setSelectedFellow(null);
          setFormData({ interaction_type: 'Call', subject: '', notes: '' });
          setSuccess(false);
          setIsSubmitting(false);
        }, 1500);
      } else {
        console.error('Error saving interaction:', error);
        setIsSubmitting(false);
        alert('Error saving interaction: ' + (error.message || 'Unknown error'));
      }
    } catch (err) {
      console.error('Exception saving interaction:', err);
      setIsSubmitting(false);
      alert('Error saving interaction: ' + (err.message || 'Unknown error'));
    }
  };

  const reset = () => {
    setStep(1);
    setSearchTerm('');
    setSelectedFellow(null);
    setFormData({ interaction_type: 'Call', subject: '', notes: '' });
    setSuccess(false);
    setIsSubmitting(false);
  };

  useEffect(() => {
    if (!isOpen) reset();
  }, [isOpen]);

  // Prevent body scroll when modal is open
  useEffect(() => {
    if (isOpen) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = '';
    }
    return () => { document.body.style.overflow = ''; };
  }, [isOpen]);

  return (
    <>
      {/* Full screen backdrop - blocks all interaction with content behind */}
      <div 
        className={`fixed inset-0 bg-black/60 z-50 transition-opacity ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}
        onClick={onClose}
      />
      
      {/* Full screen modal container */}
      <div className={`fixed inset-0 z-50 flex flex-col justify-end pointer-events-none ${isOpen ? '' : ''}`}>
        {/* Bottom Sheet */}
        <div 
          className={`bottom-sheet bg-white rounded-t-3xl max-h-[90vh] overflow-hidden pointer-events-auto ${isOpen ? 'open' : ''}`}
          onClick={(e) => e.stopPropagation()}
        >
          {/* Handle */}
          <div className="flex justify-center pt-3 pb-2">
            <div className="w-10 h-1 bg-gray-300 rounded-full"></div>
          </div>
          
          {success ? (
            <div className="p-12 text-center">
              <div className="text-6xl mb-4">âœ…</div>
              <p className="text-xl font-semibold text-gray-900">Logged!</p>
            </div>
          ) : step === 1 ? (
            <>
              {/* Header */}
              <div className="flex items-center justify-between px-5 pb-3 border-b border-gray-100">
                <h2 className="text-xl font-bold text-gray-900">Log Interaction</h2>
                <button onClick={onClose} className="p-2 text-2xl text-gray-400">&times;</button>
              </div>
              
              {/* Search */}
              <div className="p-4">
                <SearchBar value={searchTerm} onChange={setSearchTerm} placeholder="Search fellow..." />
              </div>
              
              {/* Fellow List */}
              <div className="max-h-[50vh] overflow-auto px-4 pb-safe">
                {filteredFellows.map(fellow => {
                  const status = getContactStatus(fellow.last_contact);
                  return (
                    <button
                      key={fellow.id}
                      onClick={() => { setSelectedFellow(fellow); setStep(2); }}
                      className="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 active:bg-gray-100 transition"
                    >
                      <div className="w-11 h-11 rounded-full bg-gray-200 overflow-hidden flex-shrink-0 relative">
                        {fellow.photo_url ? (
                          <img src={fellow.photo_url} alt="" className="w-full h-full object-cover" />
                        ) : (
                          <div className="w-full h-full flex items-center justify-center text-gray-400 font-medium">
                            {fellow.first_name?.[0]}{fellow.last_name?.[0]}
                          </div>
                      )}
                      <div className={`absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white status-${status.color}`}></div>
                    </div>
                    <div className="flex-1 text-left">
                      <p className="font-semibold text-gray-900">{fellow.first_name} {fellow.last_name}</p>
                      <p className="text-sm text-gray-500"><T>{fellow.organization || 'No organization'}</T></p>
                    </div>
                    <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                    </svg>
                  </button>
                );
              })}
            </div>
          </>
        ) : (
          <>
            {/* Header */}
            <div className="flex items-center gap-3 px-5 pb-3 border-b border-gray-100">
              <button onClick={() => setStep(1)} className="p-1">
                <svg className="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                </svg>
              </button>
              <div className="flex-1">
                <h2 className="text-lg font-bold text-gray-900">{selectedFellow?.first_name} {selectedFellow?.last_name}</h2>
                <p className="text-sm text-gray-500">{selectedFellow?.organization}</p>
              </div>
              <button onClick={onClose} className="p-2 text-2xl text-gray-400">&times;</button>
            </div>
            
            {/* Form */}
            <div className="p-4 space-y-4 overflow-auto max-h-[60vh]">
              {/* Type */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Type</label>
                <div className="grid grid-cols-3 gap-2">
                  {[
                    { value: 'Call', icon: 'ðŸ“ž' },
                    { value: 'Email', icon: 'ðŸ“§' },
                    { value: 'Meeting', icon: 'ðŸ¤' },
                    { value: 'Note', icon: 'ðŸ“' },
                    { value: 'Event', icon: 'ðŸŽ‰' },
                    { value: 'Site Visit', icon: 'ðŸ ' },
                  ].map(type => {
                    const isSelected = formData.interaction_type === type.value;
                    return (
                      <button
                        key={type.value}
                        onClick={() => setFormData(d => ({ ...d, interaction_type: type.value }))}
                        className="p-3 rounded-xl text-center transition border-2"
                        style={{
                          backgroundColor: isSelected ? '#E87722' : '#f3f4f6',
                          color: isSelected ? '#ffffff' : '#374151',
                          borderColor: isSelected ? '#E87722' : '#f3f4f6',
                          boxShadow: isSelected ? '0 4px 12px rgba(232, 119, 34, 0.3)' : 'none'
                        }}
                      >
                        <span className="text-xl block mb-1">{type.icon}</span>
                        <span className="text-xs font-semibold">{type.value}</span>
                      </button>
                    );
                  })}
                </div>
              </div>
              
              {/* Subject */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Subject (optional)</label>
                <input
                  type="text"
                  value={formData.subject}
                  onChange={(e) => setFormData(d => ({ ...d, subject: e.target.value }))}
                  placeholder="e.g., Quarterly check-in"
                  className="w-full border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-goldin-orange/30"
                />
              </div>
              
              {/* Notes */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Notes (optional)</label>
                <textarea
                  value={formData.notes}
                  onChange={(e) => setFormData(d => ({ ...d, notes: e.target.value }))}
                  placeholder="What did you discuss?"
                  rows={4}
                  className="w-full border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-goldin-orange/30 resize-none"
                />
              </div>
            </div>
            
            {/* Submit */}
            <div className="p-4 border-t border-gray-100 bg-white safe-bottom">
              <button
                onClick={handleSubmit}
                disabled={isSubmitting}
                className="w-full font-bold py-4 rounded-2xl active:scale-98 transition disabled:opacity-50"
                style={{ 
                  backgroundColor: '#E87722',
                  color: '#ffffff',
                  boxShadow: '0 4px 14px rgba(232, 119, 34, 0.5)' 
                }}
              >
                {isSubmitting ? 'Saving...' : 'âœ“ Log Interaction'}
              </button>
            </div>
          </>
        )}
        </div>
      </div>
    </>
  );
}

// ============================================
// CURRENT COHORT PAGES
// ============================================

// Site flag/icon helper
function getSiteIcon(program) {
  const icons = { CPF: 'ðŸ‡ºðŸ‡¸', GGF: 'ðŸ‡¹ðŸ‡¿', ESP: 'ðŸ‡¨ðŸ‡´' };
  return icons[program] || 'ðŸŒ';
}

function getSiteProgramColor(program) {
  const colors = { CPF: 'blue', GGF: 'orange', ESP: 'purple', DAR: 'emerald', MOS: 'violet' };
  return colors[program] || 'gray';
}

// ---- Cohort Dashboard (overview of all sites) ----
function CohortDashboardPage({ onNavigate }) {
  const { sites, currentFellows, cohortEvents, eventAttendance, setSelectedSiteId, t } = useContext(AppContext);

  const siteStats = useMemo(() => {
    return sites.map(site => {
      const fellows = currentFellows.filter(f => f.site_id === site.id);
      const events = cohortEvents.filter(e => e.site_id === site.id);
      const upcomingEvents = events.filter(e => new Date(e.start_time) > new Date());
      const pastEvents = events.filter(e => new Date(e.start_time) <= new Date());

      // Calculate average attendance rate for past events
      let attendanceRate = 0;
      if (pastEvents.length > 0 && fellows.length > 0) {
        const totalPresent = pastEvents.reduce((sum, evt) => {
          const evtAttendance = eventAttendance.filter(a => a.event_id === evt.id && (a.status === 'present' || a.status === 'late'));
          return sum + evtAttendance.length;
        }, 0);
        attendanceRate = Math.round((totalPresent / (pastEvents.length * fellows.length)) * 100);
      }

      return {
        ...site,
        fellowCount: fellows.length,
        totalEvents: events.length,
        upcomingCount: upcomingEvents.length,
        pastEventCount: pastEvents.length,
        attendanceRate,
        nextEvent: upcomingEvents.sort((a, b) => new Date(a.start_time) - new Date(b.start_time))[0],
      };
    });
  }, [sites, currentFellows, cohortEvents, eventAttendance]);

  const totalFellows = currentFellows.length;
  const totalEvents = cohortEvents.length;

  const handleSiteClick = (siteId) => {
    setSelectedSiteId(siteId);
    onNavigate('cohort-detail');
  };

  return (
    <div className="p-4 pb-24">
      {/* Header stats */}
      <div className="grid grid-cols-3 gap-3 mb-6">
        <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 text-center">
          <p className="text-2xl font-bold text-gray-900">{sites.length}</p>
          <p className="text-xs text-gray-500 mt-1">{t('Sites')}</p>
        </div>
        <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 text-center">
          <p className="text-2xl font-bold text-gray-900">{totalFellows}</p>
          <p className="text-xs text-gray-500 mt-1">{t('Fellows')}</p>
        </div>
        <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 text-center">
          <p className="text-2xl font-bold text-gray-900">{totalEvents}</p>
          <p className="text-xs text-gray-500 mt-1">{t('Events')}</p>
        </div>
      </div>

      {/* Site Cards */}
      <h2 className="font-semibold text-gray-900 text-lg mb-3">{t('Program Sites')}</h2>

      {sites.length === 0 ? (
        <div className="bg-white rounded-2xl p-8 shadow-sm border border-gray-100 text-center">
          <p className="text-4xl mb-3">ðŸŽ“</p>
          <p className="text-gray-500 font-medium">{t('No sites configured yet')}</p>
          <p className="text-gray-400 text-sm mt-1">Run migration 016 in Supabase SQL Editor to create the sites table and seed data.</p>
        </div>
      ) : (
        <div className="space-y-3">
          {siteStats.map(site => {
            const color = getSiteProgramColor(site.program);
            const badge = getProgramBadge(site.program);
            return (
              <button
                key={site.id}
                onClick={() => handleSiteClick(site.id)}
                className="w-full bg-white rounded-2xl p-5 shadow-sm border border-gray-100 text-left active:bg-gray-50 transition"
              >
                <div className="flex items-center gap-3 mb-3">
                  <span className="text-2xl">{getSiteIcon(site.program)}</span>
                  <div className="flex-1">
                    <h3 className="font-bold text-gray-900 text-lg">{site.name}</h3>
                    <p className="text-sm text-gray-500">{site.city}, {site.country}</p>
                  </div>
                  <span className={`text-xs px-2.5 py-1 rounded-full ${badge.bg} text-white font-semibold`}>
                    {badge.label} '{String(site.cohort_year).slice(-2)}
                  </span>
                </div>

                {/* Stats row */}
                <div className="grid grid-cols-3 gap-2">
                  <div className={`rounded-xl p-2.5 text-center bg-${color}-50`}>
                    <p className={`text-lg font-bold text-${color}-700`}>{site.fellowCount}</p>
                    <p className="text-xs text-gray-500">Fellows</p>
                  </div>
                  <div className={`rounded-xl p-2.5 text-center bg-${color}-50`}>
                    <p className={`text-lg font-bold text-${color}-700`}>{site.totalEvents}</p>
                    <p className="text-xs text-gray-500">Events</p>
                  </div>
                  <div className={`rounded-xl p-2.5 text-center ${
                    site.attendanceRate >= 80 ? 'bg-green-50' : site.attendanceRate >= 50 ? 'bg-yellow-50' : 'bg-gray-50'
                  }`}>
                    <p className={`text-lg font-bold ${
                      site.attendanceRate >= 80 ? 'text-green-700' : site.attendanceRate >= 50 ? 'text-yellow-700' : 'text-gray-400'
                    }`}>{site.pastEventCount > 0 ? `${site.attendanceRate}%` : 'â€”'}</p>
                    <p className="text-xs text-gray-500">Attendance</p>
                  </div>
                </div>

                {/* Next event preview */}
                {site.nextEvent && (
                  <div className="mt-3 pt-3 border-t border-gray-100 flex items-center gap-2">
                    <span className="text-sm">ðŸ“…</span>
                    <p className="text-sm text-gray-600 flex-1 truncate">
                      <span className="font-medium">Next:</span> {site.nextEvent.title}
                    </p>
                    <p className="text-xs text-gray-400">
                      {new Date(site.nextEvent.start_time).toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}
                    </p>
                  </div>
                )}

                {site.fellowCount === 0 && !site.nextEvent && (
                  <div className="mt-3 pt-3 border-t border-gray-100">
                    <p className="text-sm text-gray-400 text-center">No fellows or events yet â€” add fellows with status 'Current'</p>
                  </div>
                )}
              </button>
            );
          })}
        </div>
      )}
    </div>
  );
}

// ---- Create Event Modal ----
function CreateEventModal({ isOpen, onClose, siteId }) {
  const { fetchData, t } = useContext(AppContext);
  const [title, setTitle] = useState('');
  const [description, setDescription] = useState('');
  const [location, setLocation] = useState('');
  const [meetingLink, setMeetingLink] = useState('');
  const [startTime, setStartTime] = useState('');
  const [endTime, setEndTime] = useState('');
  const [notes, setNotes] = useState('');
  const [saving, setSaving] = useState(false);

  const handleSave = async () => {
    if (!title.trim() || !startTime) return;
    setSaving(true);
    try {
      const session = await supabase.auth.getSession();
      const { error } = await supabase.from('events').insert({
        site_id: siteId,
        title: title.trim(),
        description: description.trim() || null,
        location: location.trim() || null,
        meeting_link: meetingLink.trim() || null,
        start_time: new Date(startTime).toISOString(),
        end_time: endTime ? new Date(endTime).toISOString() : null,
        notes: notes.trim() || null,
        created_by: session?.data?.session?.user?.id,
      });
      if (error) throw error;
      await fetchData(true);
      onClose();
      setTitle(''); setDescription(''); setLocation(''); setMeetingLink('');
      setStartTime(''); setEndTime(''); setNotes('');
    } catch (err) {
      console.error('Error creating event:', err);
      alert('Failed to create event: ' + err.message);
    } finally {
      setSaving(false);
    }
  };

  if (!isOpen) return null;
  return (
    <>
      <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50" onClick={onClose} />
      <div className="fixed inset-x-0 bottom-0 bg-white rounded-t-3xl z-50 max-h-[90vh] overflow-y-auto">
        <div className="p-5">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-lg font-bold text-gray-900">{t('New Event')}</h2>
            <button onClick={onClose} className="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-gray-100">
              <svg className="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
          </div>

          <div className="space-y-3">
            <div>
              <label className="text-sm font-medium text-gray-700 block mb-1">{t('Title')} *</label>
              <input type="text" value={title} onChange={e => setTitle(e.target.value)} placeholder="Workshop, Meeting, etc." className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none" />
            </div>
            <div>
              <label className="text-sm font-medium text-gray-700 block mb-1">{t('Description')}</label>
              <textarea value={description} onChange={e => setDescription(e.target.value)} rows={2} className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none resize-none" />
            </div>
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="text-sm font-medium text-gray-700 block mb-1">{t('Start')} *</label>
                <input type="datetime-local" value={startTime} onChange={e => setStartTime(e.target.value)} className="w-full px-3 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none text-sm" />
              </div>
              <div>
                <label className="text-sm font-medium text-gray-700 block mb-1">{t('End')}</label>
                <input type="datetime-local" value={endTime} onChange={e => setEndTime(e.target.value)} className="w-full px-3 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none text-sm" />
              </div>
            </div>
            <div>
              <label className="text-sm font-medium text-gray-700 block mb-1">{t('Location')}</label>
              <input type="text" value={location} onChange={e => setLocation(e.target.value)} placeholder="Room, address, etc." className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none" />
            </div>
            <div>
              <label className="text-sm font-medium text-gray-700 block mb-1">{t('Meeting Link')}</label>
              <input type="url" value={meetingLink} onChange={e => setMeetingLink(e.target.value)} placeholder="https://zoom.us/..." className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none" />
            </div>
            <div>
              <label className="text-sm font-medium text-gray-700 block mb-1">{t('Notes')}</label>
              <textarea value={notes} onChange={e => setNotes(e.target.value)} rows={2} className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none resize-none" />
            </div>
          </div>

          <button onClick={handleSave} disabled={saving || !title.trim() || !startTime} className="w-full mt-4 py-4 bg-goldin-orange text-white font-semibold rounded-xl hover:bg-goldin-orange-dark transition disabled:opacity-50 disabled:cursor-not-allowed">
            {saving ? t('Creating...') : t('Create Event')}
          </button>
        </div>
      </div>
    </>
  );
}

// ---- Attendance Modal ----
function AttendanceModal({ isOpen, onClose, event, siteFellows }) {
  const { eventAttendance, fetchData, t } = useContext(AppContext);
  const [localAttendance, setLocalAttendance] = useState({});
  const [saving, setSaving] = useState(false);

  // Initialize local state from existing attendance
  useEffect(() => {
    if (event && isOpen) {
      const existing = {};
      eventAttendance
        .filter(a => a.event_id === event.id)
        .forEach(a => { existing[a.fellow_id] = a.status; });
      // Default all fellows to their existing status or 'absent'
      const init = {};
      siteFellows.forEach(f => { init[f.id] = existing[f.id] || 'absent'; });
      setLocalAttendance(init);
    }
  }, [event, isOpen, eventAttendance, siteFellows]);

  const handleSave = async () => {
    setSaving(true);
    try {
      const session = await supabase.auth.getSession();
      const userId = session?.data?.session?.user?.id;

      // Upsert attendance records
      const records = Object.entries(localAttendance).map(([fellowId, status]) => ({
        event_id: event.id,
        fellow_id: fellowId,
        status,
        recorded_by: userId,
      }));

      const { error } = await supabase.from('event_attendance').upsert(records, { onConflict: 'event_id,fellow_id' });
      if (error) throw error;
      await fetchData(true);
      onClose();
    } catch (err) {
      console.error('Error saving attendance:', err);
      alert('Failed to save attendance: ' + err.message);
    } finally {
      setSaving(false);
    }
  };

  const markAll = (status) => {
    const updated = {};
    siteFellows.forEach(f => { updated[f.id] = status; });
    setLocalAttendance(updated);
  };

  const presentCount = Object.values(localAttendance).filter(s => s === 'present' || s === 'late').length;

  if (!isOpen || !event) return null;
  return (
    <>
      <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50" onClick={onClose} />
      <div className="fixed inset-x-0 bottom-0 bg-white rounded-t-3xl z-50 flex flex-col" style={{ maxHeight: '90vh' }}>
        <div className="p-5 border-b border-gray-100 shrink-0">
          <div className="flex items-center justify-between mb-2">
            <h2 className="text-lg font-bold text-gray-900">{t('Take Attendance')}</h2>
            <button onClick={onClose} className="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-gray-100">
              <svg className="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
          </div>
          <p className="text-sm text-gray-600 font-medium">{event.title}</p>
          <p className="text-xs text-gray-400">{new Date(event.start_time).toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}</p>

          {/* Quick actions */}
          <div className="flex gap-2 mt-3">
            <button onClick={() => markAll('present')} className="text-xs px-3 py-1.5 bg-green-100 text-green-700 rounded-lg font-medium hover:bg-green-200 transition">{t('All Present')}</button>
            <button onClick={() => markAll('absent')} className="text-xs px-3 py-1.5 bg-red-100 text-red-700 rounded-lg font-medium hover:bg-red-200 transition">{t('All Absent')}</button>
            <span className="ml-auto text-sm text-gray-500">{presentCount}/{siteFellows.length} present</span>
          </div>
        </div>

        <div className="overflow-y-auto flex-1 p-4">
          <div className="space-y-2">
            {siteFellows.map(fellow => {
              const status = localAttendance[fellow.id] || 'absent';
              return (
                <div key={fellow.id} className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
                  <div className="w-10 h-10 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
                    {fellow.photo_url ? (
                      <img src={fellow.photo_url} alt="" className="w-full h-full object-cover" />
                    ) : (
                      <div className="w-full h-full flex items-center justify-center text-gray-400 font-semibold text-sm">
                        {fellow.first_name?.[0]}{fellow.last_name?.[0]}
                      </div>
                    )}
                  </div>
                  <p className="flex-1 font-medium text-gray-900 text-sm">{fellow.first_name} {fellow.last_name}</p>
                  <div className="flex gap-1">
                    {['present', 'late', 'excused', 'absent'].map(s => (
                      <button
                        key={s}
                        onClick={() => setLocalAttendance(prev => ({ ...prev, [fellow.id]: s }))}
                        className={`text-xs px-2 py-1.5 rounded-lg font-medium transition ${
                          status === s
                            ? s === 'present' ? 'bg-green-500 text-white'
                              : s === 'late' ? 'bg-yellow-500 text-white'
                              : s === 'excused' ? 'bg-blue-500 text-white'
                              : 'bg-red-500 text-white'
                            : 'bg-white text-gray-500 border border-gray-200'
                        }`}
                      >
                        {s === 'present' ? 'P' : s === 'late' ? 'L' : s === 'excused' ? 'E' : 'A'}
                      </button>
                    ))}
                  </div>
                </div>
              );
            })}
          </div>
        </div>

        <div className="p-4 border-t border-gray-100 shrink-0">
          <button onClick={handleSave} disabled={saving} className="w-full py-4 bg-goldin-orange text-white font-semibold rounded-xl hover:bg-goldin-orange-dark transition disabled:opacity-50">
            {saving ? t('Saving...') : t('Save Attendance')}
          </button>
        </div>
      </div>
    </>
  );
}

// ---- Cohort Site Detail Page ----
function CohortSiteDetailPage({ onNavigate, onSelectFellow }) {
  const { sites, currentFellows, cohortEvents, eventAttendance, interactions, selectedSiteId, setSelectedSiteId, fetchData, canAccess, t } = useContext(AppContext);
  const [activeTab, setActiveTab] = useState('directory');
  const [createEventOpen, setCreateEventOpen] = useState(false);
  const [attendanceEvent, setAttendanceEvent] = useState(null);
  const [search, setSearch] = useState('');

  const site = sites.find(s => s.id === selectedSiteId);
  const siteFellows = useMemo(() =>
    currentFellows.filter(f => f.site_id === selectedSiteId).sort((a, b) =>
      `${a.last_name} ${a.first_name}`.localeCompare(`${b.last_name} ${b.first_name}`)
    ), [currentFellows, selectedSiteId]);

  const siteEvents = useMemo(() =>
    cohortEvents.filter(e => e.site_id === selectedSiteId).sort((a, b) =>
      new Date(b.start_time) - new Date(a.start_time)
    ), [cohortEvents, selectedSiteId]);

  const upcomingEvents = siteEvents.filter(e => new Date(e.start_time) > new Date());
  const pastEvents = siteEvents.filter(e => new Date(e.start_time) <= new Date());

  // Calculate per-fellow attendance stats
  const fellowAttendanceStats = useMemo(() => {
    const stats = {};
    siteFellows.forEach(f => {
      const attended = eventAttendance.filter(a => a.fellow_id === f.id && (a.status === 'present' || a.status === 'late'));
      const total = pastEvents.length;
      stats[f.id] = { attended: attended.length, total, rate: total > 0 ? Math.round((attended.length / total) * 100) : 0 };
    });
    return stats;
  }, [siteFellows, eventAttendance, pastEvents]);

  // Calculate per-event attendance stats
  const eventAttendanceStats = useMemo(() => {
    const stats = {};
    siteEvents.forEach(evt => {
      const records = eventAttendance.filter(a => a.event_id === evt.id);
      const present = records.filter(a => a.status === 'present' || a.status === 'late').length;
      stats[evt.id] = { present, total: siteFellows.length, rate: siteFellows.length > 0 ? Math.round((present / siteFellows.length) * 100) : 0 };
    });
    return stats;
  }, [siteEvents, eventAttendance, siteFellows]);

  // Fellow health scores (simplified: based on attendance + staff interaction recency)
  const fellowHealthScores = useMemo(() => {
    const scores = {};
    siteFellows.forEach(f => {
      const attRate = fellowAttendanceStats[f.id]?.rate || 0;

      // Interaction recency score
      const fellowInteractions = interactions.filter(i => i.fellow_id === f.id);
      const lastInteraction = fellowInteractions.length > 0
        ? Math.max(...fellowInteractions.map(i => new Date(i.interaction_date || i.created_at).getTime()))
        : 0;
      const daysSinceInteraction = lastInteraction ? Math.floor((Date.now() - lastInteraction) / (1000*60*60*24)) : 999;
      const interactionScore = daysSinceInteraction <= 14 ? 100 : daysSinceInteraction <= 30 ? 75 : daysSinceInteraction <= 60 ? 50 : 25;

      // Combined score: 60% attendance + 40% interaction
      const score = Math.round(attRate * 0.6 + interactionScore * 0.4);
      const status = score >= 70 ? 'green' : score >= 40 ? 'yellow' : 'red';
      scores[f.id] = { score, status, attRate, interactionScore, daysSinceInteraction };
    });
    return scores;
  }, [siteFellows, fellowAttendanceStats, interactions]);

  if (!site) {
    return (
      <div className="p-4 text-center py-20">
        <p className="text-gray-400">Site not found</p>
        <button onClick={() => onNavigate('cohorts')} className="mt-4 text-goldin-orange font-medium">{t('Back to Cohorts')}</button>
      </div>
    );
  }

  const badge = getProgramBadge(site.program);
  const tabs = [
    { id: 'directory', label: 'Directory' },
    { id: 'events', label: 'Events' },
    { id: 'health', label: 'Health' },
  ];

  // Filtered fellows for directory tab
  const filteredFellows = siteFellows.filter(f => {
    if (!search) return true;
    const term = search.toLowerCase();
    return `${f.first_name} ${f.last_name}`.toLowerCase().includes(term) ||
      f.organization?.toLowerCase().includes(term) ||
      f.email?.toLowerCase().includes(term);
  });

  return (
    <div className="p-4 pb-24">
      {/* Back + Site Header */}
      <div className="flex items-center gap-3 mb-4">
        <button onClick={() => onNavigate('cohorts')} className="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-gray-100 transition">
          <svg className="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>
        </button>
        <span className="text-2xl">{getSiteIcon(site.program)}</span>
        <div className="flex-1">
          <h1 className="font-bold text-gray-900 text-xl">{site.name}</h1>
          <p className="text-sm text-gray-500">{site.city}, {site.country}</p>
        </div>
        <span className={`text-xs px-2.5 py-1 rounded-full ${badge.bg} text-white font-semibold`}>
          {badge.label} '{String(site.cohort_year).slice(-2)}
        </span>
      </div>

      {/* Tabs */}
      <div className="flex gap-1 mb-4 bg-gray-100 rounded-xl p-1">
        {tabs.map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            className={`flex-1 py-2.5 text-sm font-medium rounded-lg transition ${
              activeTab === tab.id ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500'
            }`}
          >
            {t(tab.label)}
          </button>
        ))}
      </div>

      {/* ---- DIRECTORY TAB ---- */}
      {activeTab === 'directory' && (
        <div>
          <div className="flex gap-2 mb-4">
            <div className="flex-1 relative">
              <svg className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              <input
                type="text"
                value={search}
                onChange={e => setSearch(e.target.value)}
                placeholder="Search fellows..."
                className="w-full pl-12 pr-4 py-3 bg-gray-100 rounded-2xl text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-goldin-orange/30"
              />
            </div>
          </div>

          <p className="text-sm text-gray-500 mb-3">{filteredFellows.length} {filteredFellows.length === 1 ? 'fellow' : 'fellows'}</p>

          <div className="space-y-2">
            {filteredFellows.map(fellow => {
              const health = fellowHealthScores[fellow.id];
              const att = fellowAttendanceStats[fellow.id];
              return (
                <button
                  key={fellow.id}
                  onClick={() => onSelectFellow(fellow)}
                  className="w-full bg-white rounded-2xl p-4 shadow-sm border border-gray-100 flex items-center gap-3 active:bg-gray-50 transition text-left"
                >
                  <div className="w-12 h-12 rounded-full bg-gray-200 overflow-hidden flex-shrink-0 relative">
                    {fellow.photo_url ? (
                      <img src={fellow.photo_url} alt="" className="w-full h-full object-cover" />
                    ) : (
                      <div className="w-full h-full flex items-center justify-center text-gray-400 font-semibold">
                        {fellow.first_name?.[0]}{fellow.last_name?.[0]}
                      </div>
                    )}
                    {health && (
                      <div className={`absolute bottom-0 right-0 w-3.5 h-3.5 rounded-full border-2 border-white status-${health.status}`}></div>
                    )}
                  </div>
                  <div className="flex-1 min-w-0">
                    <p className="font-semibold text-gray-900 truncate">{fellow.first_name} {fellow.last_name}</p>
                    <p className="text-sm text-gray-500 truncate">{fellow.organization || fellow.email || 'No info'}</p>
                  </div>
                  <div className="text-right flex-shrink-0">
                    {att && att.total > 0 && (
                      <p className={`text-sm font-semibold ${att.rate >= 80 ? 'text-green-600' : att.rate >= 50 ? 'text-yellow-600' : 'text-red-600'}`}>
                        {att.rate}%
                      </p>
                    )}
                    <p className="text-xs text-gray-400">{att?.attended || 0}/{att?.total || 0}</p>
                  </div>
                  <svg className="w-5 h-5 text-gray-300 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                  </svg>
                </button>
              );
            })}

            {filteredFellows.length === 0 && (
              <div className="text-center py-12">
                <p className="text-gray-400 text-lg">No fellows found</p>
                <p className="text-gray-400 text-sm mt-1">Add fellows with status 'Current' and this site's site_id</p>
              </div>
            )}
          </div>
        </div>
      )}

      {/* ---- EVENTS TAB ---- */}
      {activeTab === 'events' && (
        <div>
          <button
            onClick={() => setCreateEventOpen(true)}
            className="w-full mb-4 py-3 bg-goldin-orange text-white font-semibold rounded-xl hover:bg-goldin-orange-dark transition flex items-center justify-center gap-2"
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
            {t('New Event')}
          </button>

          {/* Upcoming Events */}
          {upcomingEvents.length > 0 && (
            <>
              <h3 className="font-semibold text-gray-900 mb-2">{t('Upcoming')}</h3>
              <div className="space-y-2 mb-4">
                {upcomingEvents.sort((a,b) => new Date(a.start_time) - new Date(b.start_time)).map(evt => (
                  <div key={evt.id} className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                    <div className="flex items-start gap-3">
                      <div className="w-12 h-12 bg-orange-50 rounded-xl flex flex-col items-center justify-center flex-shrink-0">
                        <span className="text-xs font-bold text-orange-600">{new Date(evt.start_time).toLocaleDateString(undefined, { month: 'short' }).toUpperCase()}</span>
                        <span className="text-lg font-bold text-orange-700">{new Date(evt.start_time).getDate()}</span>
                      </div>
                      <div className="flex-1 min-w-0">
                        <p className="font-semibold text-gray-900">{evt.title}</p>
                        <p className="text-sm text-gray-500">
                          {new Date(evt.start_time).toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' })}
                          {evt.end_time && ` â€” ${new Date(evt.end_time).toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' })}`}
                        </p>
                        {evt.location && <p className="text-xs text-gray-400 mt-1">ðŸ“ {evt.location}</p>}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </>
          )}

          {/* Past Events */}
          <h3 className="font-semibold text-gray-900 mb-2">{t('Past Events')}{pastEvents.length > 0 ? ` (${pastEvents.length})` : ''}</h3>
          {pastEvents.length === 0 ? (
            <p className="text-gray-400 text-sm text-center py-8">No past events yet</p>
          ) : (
            <div className="space-y-2">
              {pastEvents.map(evt => {
                const stats = eventAttendanceStats[evt.id] || { present: 0, total: 0, rate: 0 };
                return (
                  <div key={evt.id} className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                    <div className="flex items-start gap-3">
                      <div className="w-12 h-12 bg-gray-50 rounded-xl flex flex-col items-center justify-center flex-shrink-0">
                        <span className="text-xs font-bold text-gray-500">{new Date(evt.start_time).toLocaleDateString(undefined, { month: 'short' }).toUpperCase()}</span>
                        <span className="text-lg font-bold text-gray-600">{new Date(evt.start_time).getDate()}</span>
                      </div>
                      <div className="flex-1 min-w-0">
                        <p className="font-semibold text-gray-900">{evt.title}</p>
                        <p className="text-sm text-gray-500">
                          {new Date(evt.start_time).toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' })}
                        </p>
                        {/* Attendance bar */}
                        <div className="flex items-center gap-2 mt-2">
                          <div className="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden">
                            <div className={`h-full rounded-full ${stats.rate >= 80 ? 'bg-green-500' : stats.rate >= 50 ? 'bg-yellow-500' : 'bg-red-500'}`} style={{ width: `${stats.rate}%` }} />
                          </div>
                          <span className="text-xs font-medium text-gray-500">{stats.present}/{stats.total}</span>
                        </div>
                      </div>
                      <button
                        onClick={() => setAttendanceEvent(evt)}
                        className="text-xs px-3 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition flex-shrink-0"
                      >
                        {stats.present > 0 ? t('Edit') : t('Take')}
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      )}

      {/* ---- HEALTH TAB ---- */}
      {activeTab === 'health' && (
        <div>
          {/* Summary stats */}
          <div className="grid grid-cols-3 gap-2 mb-4">
            {['green', 'yellow', 'red'].map(status => {
              const count = Object.values(fellowHealthScores).filter(h => h.status === status).length;
              const colors = { green: { bg: 'bg-green-50', text: 'text-green-700', label: 'Healthy' }, yellow: { bg: 'bg-yellow-50', text: 'text-yellow-700', label: 'At Risk' }, red: { bg: 'bg-red-50', text: 'text-red-700', label: 'Needs Help' } };
              return (
                <div key={status} className={`${colors[status].bg} rounded-xl p-3 text-center`}>
                  <p className={`text-2xl font-bold ${colors[status].text}`}>{count}</p>
                  <p className="text-xs text-gray-500">{t(colors[status].label)}</p>
                </div>
              );
            })}
          </div>

          {/* Fellow health list, sorted worst first */}
          <h3 className="font-semibold text-gray-900 mb-2">{t('Fellow Health')}</h3>
          <div className="space-y-2">
            {siteFellows
              .sort((a, b) => (fellowHealthScores[a.id]?.score || 0) - (fellowHealthScores[b.id]?.score || 0))
              .map(fellow => {
                const health = fellowHealthScores[fellow.id] || { score: 0, status: 'red', attRate: 0, daysSinceInteraction: 999 };
                return (
                  <button
                    key={fellow.id}
                    onClick={() => onSelectFellow(fellow)}
                    className="w-full bg-white rounded-2xl p-4 shadow-sm border border-gray-100 text-left active:bg-gray-50 transition"
                  >
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
                        {fellow.photo_url ? (
                          <img src={fellow.photo_url} alt="" className="w-full h-full object-cover" />
                        ) : (
                          <div className="w-full h-full flex items-center justify-center text-gray-400 font-semibold text-sm">
                            {fellow.first_name?.[0]}{fellow.last_name?.[0]}
                          </div>
                        )}
                      </div>
                      <div className="flex-1 min-w-0">
                        <p className="font-semibold text-gray-900 text-sm">{fellow.first_name} {fellow.last_name}</p>
                        <div className="flex items-center gap-3 mt-1">
                          <span className="text-xs text-gray-500">Att: {health.attRate}%</span>
                          <span className="text-xs text-gray-500">Last contact: {health.daysSinceInteraction < 999 ? `${health.daysSinceInteraction}d` : 'Never'}</span>
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm ${
                          health.status === 'green' ? 'bg-green-100 text-green-700' :
                          health.status === 'yellow' ? 'bg-yellow-100 text-yellow-700' :
                          'bg-red-100 text-red-700'
                        }`}>
                          {health.score}
                        </div>
                      </div>
                    </div>
                  </button>
                );
            })}
          </div>

          {siteFellows.length === 0 && (
            <div className="text-center py-12">
              <p className="text-gray-400">No fellows in this site yet</p>
            </div>
          )}
        </div>
      )}

      {/* Modals */}
      <CreateEventModal isOpen={createEventOpen} onClose={() => setCreateEventOpen(false)} siteId={selectedSiteId} />
      <AttendanceModal isOpen={!!attendanceEvent} onClose={() => setAttendanceEvent(null)} event={attendanceEvent} siteFellows={siteFellows} />
    </div>
  );
}

// ============================================
// MAIN APP
// ============================================
function MainApp() {
  const { user, userRole, isOnboarded, loading, login, completeOnboarding, canAccess, changeLanguage, fetchData, needsProfileClaim, setNeedsProfileClaim, potentialMatches, t, authError, setAuthError } = useContext(AppContext);
  const [onboardingStep, setOnboardingStep] = useState(() => {
    // Initialize based on existing state
    const savedUser = localStorage.getItem('gather_user');
    const savedOnboarded = localStorage.getItem('gather_onboarded');
    if (savedUser && savedOnboarded) return 3; // Fully onboarded
    if (savedUser) return 2; // User exists but not onboarded
    return 0;
  });
  // Default page based on role: staff sees dashboard, others see directory
  const getDefaultPage = () => {
    const savedRole = localStorage.getItem('gather_user_role');
    return hasPermission(savedRole || ROLES.VIEWER, ROLES.TEAM) ? 'dashboard' : 'directory';
  };
  const [currentPage, setCurrentPage] = useState(getDefaultPage);
  const [menuOpen, setMenuOpen] = useState(false);
  const [logModalOpen, setLogModalOpen] = useState(false);
  const [selectedFellow, setSelectedFellow] = useState(null);
  const [profileModalOpen, setProfileModalOpen] = useState(false);

  // Pull-to-refresh state
  const [pullDistance, setPullDistance] = useState(0);
  const [isRefreshing, setIsRefreshing] = useState(false);
  const touchStartY = useRef(0);
  const mainRef = useRef(null);

  const handleTouchStart = (e) => {
    if (window.scrollY === 0 && !isRefreshing) {
      touchStartY.current = e.touches[0].clientY;
    }
  };

  const handleTouchMove = (e) => {
    if (window.scrollY === 0 && touchStartY.current > 0 && !isRefreshing) {
      const currentY = e.touches[0].clientY;
      const diff = currentY - touchStartY.current;
      if (diff > 0) {
        // Reduce pull distance with resistance
        setPullDistance(Math.min(diff * 0.4, 100));
      }
    }
  };

  const handleTouchEnd = async () => {
    if (pullDistance > 60 && !isRefreshing) {
      // Trigger hard refresh
      setIsRefreshing(true);
      setPullDistance(60);

      try {
        await fetchData(true); // true = force refresh, clears caches
      } catch (e) {
        console.error('Refresh failed:', e);
      }

      setIsRefreshing(false);
    }
    setPullDistance(0);
    touchStartY.current = 0;
  };

  // Update onboarding step when user state changes (e.g., after OAuth return or session expiry)
  useEffect(() => {
    if (user && isOnboarded) {
      setOnboardingStep(3);
    } else if (user && !isOnboarded && onboardingStep < 2) {
      // After OAuth return, go to language/notification setup
      setOnboardingStep(2);
    } else if (!user && !isOnboarded) {
      // Session expired or logged out - reset to welcome
      setOnboardingStep(0);
    }
  }, [user, isOnboarded]);

  // Route protection - redirect guests from team-only pages
  useEffect(() => {
    const teamOnlyPages = ['dashboard', 'activity', 'broadcast', 'team-management', 'cohorts', 'cohort-detail'];
    if (teamOnlyPages.includes(currentPage) && !canAccess(ROLES.TEAM)) {
      setCurrentPage('directory');
    }
  }, [currentPage, userRole, canAccess]);

  const handleSelectFellow = (fellow) => {
    setSelectedFellow(fellow);
    setProfileModalOpen(true);
  };

  const handleLogFromProfile = (fellow) => {
    setSelectedFellow(fellow);
    setProfileModalOpen(false);
    setLogModalOpen(true);
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="w-16 h-16 rounded-2xl p-2 animate-pulse" style={{ backgroundColor: '#E87722' }}>
          <img src={GATHER_LOGO} alt="Loading..." className="w-full h-full" />
        </div>
      </div>
    );
  }

  // Profile claiming flow - show when user logged in but not recognized
  if (user && needsProfileClaim) {
    return (
      <IsThisYouScreen
        email={user.email}
        userId={user.id}
        potentialMatches={potentialMatches}
        onClaim={() => {
          // Claim request submitted - continue to directory
          setNeedsProfileClaim(false);
        }}
        onSkip={() => {
          // User chose to browse as guest
          setNeedsProfileClaim(false);
        }}
      />
    );
  }

  // Onboarding flow
  if (!user || !isOnboarded) {
    if (onboardingStep === 0) {
      return <WelcomeScreen onNext={() => setOnboardingStep(1)} />;
    }
    if (onboardingStep === 1 || !user) {
      return <LoginScreen authError={authError} onLogin={(userData, skipRoleLookup = false) => {
        setAuthError(null);
        login(userData, skipRoleLookup);
        setOnboardingStep(2); // Go to language + notification setup
      }} />;
    }
    if (onboardingStep === 2 && user) {
      return <OnboardingSetupScreen onComplete={(selectedLang, notifSettings) => {
        changeLanguage(selectedLang);
        completeOnboarding(notifSettings);
      }} />;
    }
  }

  // Page titles
  const pageTitles = {
    dashboard: 'Dashboard',
    cohorts: 'Current Cohorts',
    'cohort-detail': 'Cohort',
    directory: 'Directory',
    community: 'Community',
    library: 'Library',
    search: 'Search',
    activity: 'Activity',
    broadcast: 'Broadcast',
    settings: 'Settings',
    'team-management': 'Team Management'
  };

  const openLogModal = () => {
    setSelectedFellow(null);
    setLogModalOpen(true);
  };

  // Main app
  return (
    <div
      className="min-h-screen bg-gray-50"
      ref={mainRef}
      onTouchStart={handleTouchStart}
      onTouchMove={handleTouchMove}
      onTouchEnd={handleTouchEnd}
    >
      {/* Pull-to-refresh indicator */}
      {(pullDistance > 0 || isRefreshing) && (
        <div
          className="fixed left-0 right-0 flex justify-center items-center z-50 transition-all"
          style={{
            top: 64,
            height: isRefreshing ? 60 : pullDistance,
            opacity: Math.min(pullDistance / 60, 1)
          }}
        >
          <div className={`w-8 h-8 rounded-full border-2 border-goldin-orange border-t-transparent ${isRefreshing ? 'animate-spin' : ''}`}
            style={{ transform: isRefreshing ? 'none' : `rotate(${pullDistance * 3}deg)` }}
          />
          {pullDistance > 60 && !isRefreshing && (
            <span className="ml-2 text-sm text-gray-600">Release to refresh</span>
          )}
          {isRefreshing && (
            <span className="ml-2 text-sm text-gray-600">Refreshing...</span>
          )}
        </div>
      )}

      <Header
        onMenuOpen={() => setMenuOpen(true)}
        pageTitle={t(pageTitles[currentPage] || 'GATHER')}
        onAddInteraction={openLogModal}
      />

      <SlideMenu
        isOpen={menuOpen}
        onClose={() => setMenuOpen(false)}
        currentPage={currentPage}
        onNavigate={setCurrentPage}
      />

      {/* Page content with padding for fixed header */}
      <main className="pt-16 pb-8" style={{ marginTop: isRefreshing ? 60 : 0 }}>
        {currentPage === 'dashboard' && <DashboardPage onLogInteraction={openLogModal} onSelectFellow={handleSelectFellow} />}
        {currentPage === 'cohorts' && <CohortDashboardPage onNavigate={setCurrentPage} />}
        {currentPage === 'cohort-detail' && <CohortSiteDetailPage onNavigate={setCurrentPage} onSelectFellow={handleSelectFellow} />}
        {currentPage === 'directory' && <DirectoryPage onSelectFellow={handleSelectFellow} />}
        {currentPage === 'community' && <CommunityPage />}
        {currentPage === 'library' && <LibraryPage />}
        {currentPage === 'search' && <SearchPage onSelectFellow={handleSelectFellow} />}
        {currentPage === 'activity' && <ActivityPage onSelectFellow={handleSelectFellow} />}
        {currentPage === 'broadcast' && <BroadcastPage />}
        {currentPage === 'settings' && <SettingsPage onNavigate={setCurrentPage} />}
        {currentPage === 'team-management' && <TeamManagementPage onBack={() => setCurrentPage('settings')} />}
      </main>
      
      <FellowProfileModal 
        fellow={selectedFellow} 
        isOpen={profileModalOpen} 
        onClose={() => setProfileModalOpen(false)}
        onLogInteraction={handleLogFromProfile}
      />
      
      <LogInteractionModal 
        isOpen={logModalOpen} 
        onClose={() => setLogModalOpen(false)} 
        preSelectedFellow={selectedFellow}
      />
    </div>
  );
}

// ============================================
// ROOT
// ============================================
function App() {
  return (
    <AppProvider>
      <MainApp />
    </AppProvider>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>

<!-- Register Service Worker -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW registration failed:', err));
  });
}
</script>

</body>
</html>
